{"id":"cod-0qv","title":"Fix review issues: initStealthSession cleanup + SearchError wrapping","description":"Address two issues from Oracle reviews:\n1. initStealthSession lacks cleanup on partial failure - if browser created but page.goto fails, browser leaks\n2. SearchServiceKimovil: browser-level errors not wrapped in SearchError, so they bypass retry logic","acceptance_criteria":"- [ ] initStealthSession uses acquireRelease or cleanup on failure\n- [ ] All errors from withPersistentStealthPage wrapped in SearchError\n- [ ] npm run check-types passes\n- [ ] npm run build passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:50:13.460317+01:00","updated_at":"2025-12-21T17:52:29.074467+01:00","closed_at":"2025-12-21T17:52:29.074467+01:00"}
{"id":"cod-0z6","title":"JobsSection main components rewrite","description":"Rewrite main container components: JobsSection (header + container), JobsTable (table with For), JobsRow (single row with memos), SelectedJobPanel (detail panel). Uses atoms and helpers.","design":"JobsSection.tsx becomes thin orchestrator. JobsTable.tsx renders table. JobsRow.tsx handles single row with createMemo for status/progress. SelectedJobPanel.tsx for detail view. All use atoms.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T00:17:23.181085+01:00","updated_at":"2025-12-22T00:27:47.431651+01:00","closed_at":"2025-12-22T00:27:47.431651+01:00","dependencies":[{"issue_id":"cod-0z6","depends_on_id":"cod-t8h","type":"parent-child","created_at":"2025-12-22T00:17:37.558664+01:00","created_by":"daemon"}]}
{"id":"cod-1k3","title":"Add price status indicator to DataStatusIcons","description":"Optional: Add a price indicator icon to show if device has linked Yandex.Market data in the devices table.","design":"Add ₽ icon in amber/orange color. Show filled if has prices, outline if only linked, hidden if neither.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-22T03:08:51.317751+01:00","updated_at":"2025-12-22T03:08:51.317751+01:00","dependencies":[{"issue_id":"cod-1k3","depends_on_id":"cod-3xb","type":"parent-child","created_at":"2025-12-22T03:09:07.77855+01:00","created_by":"daemon"}]}
{"id":"cod-26h","title":"Phase 2: Backfill Devices","description":"Populate devices and device_sources from existing kimovil_devices table.\n\n## Migration steps:\n1. Generate device IDs (16-char sha256 of slug)\n2. INSERT INTO devices from kimovil_devices\n3. INSERT INTO device_sources with source='kimovil', external_id=slug\n\n## Files:\n- apps/scraper/src/sql/schema.ts (add migration function)\n\nEstimated: 0.5 days","acceptance_criteria":"- [ ] All kimovil_devices migrated to devices\n- [ ] device_sources populated with source='kimovil'\n- [ ] Migration is idempotent (can run multiple times)\n- [ ] Existing functionality unchanged","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:17.482994+01:00","updated_at":"2025-12-21T04:49:47.035999+01:00","closed_at":"2025-12-21T04:49:47.035999+01:00","dependencies":[{"issue_id":"cod-26h","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.335025+01:00","created_by":"daemon"},{"issue_id":"cod-26h","depends_on_id":"cod-b4n","type":"blocks","created_at":"2025-12-21T04:41:19.017632+01:00","created_by":"daemon"}]}
{"id":"cod-2i2","title":"Phase 2: Implement stealth browser init and withPersistentStealthPage","description":"Create initStealthSession helper that launches chromium with stealth flags, patches webdriver, navigates to kimovil.com. Implement withPersistentStealthPage that lazily inits session, acquires semaphore, runs user effect with page, handles errors.","acceptance_criteria":"- [ ] Stealth browser launches with --disable-blink-features=AutomationControlled\n- [ ] navigator.webdriver patched via addInitScript\n- [ ] Session pre-warms by visiting kimovil.com/en/\n- [ ] withPersistentStealthPage serializes access via Semaphore\n- [ ] Lazy init on first call, reuses on subsequent\n- [ ] npm run check-types passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:38:46.282708+01:00","updated_at":"2025-12-21T17:46:31.993012+01:00","closed_at":"2025-12-21T17:46:31.993012+01:00","dependencies":[{"issue_id":"cod-2i2","depends_on_id":"cod-3a9","type":"parent-child","created_at":"2025-12-21T17:39:10.482994+01:00","created_by":"daemon"},{"issue_id":"cod-2i2","depends_on_id":"cod-8wi","type":"blocks","created_at":"2025-12-21T17:39:23.068878+01:00","created_by":"daemon"}]}
{"id":"cod-2l4","title":"Fix 2: Filter Price History by Availability","description":"Add is_available = 1 filter to getPriceHistory query.\n\n## Implementation\nUpdate apps/scraper/src/services/price.ts getPriceHistory method:\n- Add AND is_available = 1 to both query branches (with/without variantKey)\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T02:24:20.391424+01:00","updated_at":"2025-12-22T02:29:57.986054+01:00","closed_at":"2025-12-22T02:29:57.986054+01:00","dependencies":[{"issue_id":"cod-2l4","depends_on_id":"cod-ulx","type":"parent-child","created_at":"2025-12-22T02:24:45.439657+01:00","created_by":"daemon"},{"issue_id":"cod-2l4","depends_on_id":"cod-tve","type":"blocks","created_at":"2025-12-22T02:24:45.535652+01:00","created_by":"daemon"}]}
{"id":"cod-2qg","title":"Remove pipe-delimited strings, use JSON arrays everywhere","description":"Currently the codebase has inconsistent data formats:\n- Extractors return pipe-delimited strings (e.g., 'Glass|Aluminium')\n- Migration 001 converted some to JSON arrays in DB\n- Schema still expects Schema.String for these fields\n- Result: double-encoded JSON strings like '[\"Glass\",\"Aluminium\"]'\n- Nested values like skus[].marketId still pipe-delimited\n\n## Fields to migrate\n- aliases, images, materials, colors, displayFeatures, cpuCores, sim, cameraFeatures, others (top-level)\n- skus[].marketId (nested - should become string[])\n- cameras[].features (nested - should become string[])\n\n## Changes needed\n1. Update extractors to return arrays instead of .join('|')\n2. Update RawPhone/Phone schemas to use Schema.Array(Schema.String)\n3. Remove toDelimited/toPipeString helpers in scrape-kimovil.ts\n4. Update openai.ts to work with arrays\n5. Write migration to fix existing double-encoded data\n6. Update any UI code that splits on '|'","design":"Approach:\n1. Schema first: Update phone.ts to use arrays\n2. Extractors: Return arrays directly\n3. AI service: Remove pipe-string conversions\n4. Migration: Fix corrupted data in DB\n5. Test with fresh scrape + existing data","notes":"COMPLETED: Full migration to JSON arrays\n\nCHANGES:\n- Schema: All list fields now Schema.Array(Schema.String)\n- Sku: marketId → marketIds (array)\n- Camera: features now array\n- Extractors: Return arrays directly\n- Removed toDelimited/toPipeString helpers\n- Migration 002: Fixed 6462 rows in phone_data_raw, 57 in phone_data\n\nVERIFIED:\n- npm run check-types passes\n- Migration successful\n- samsung-galaxy-s24 now has proper arrays","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T21:11:32.708259+01:00","updated_at":"2025-12-21T21:20:56.952306+01:00","closed_at":"2025-12-21T21:20:56.952309+01:00"}
{"id":"cod-3a9","title":"Fix Kimovil search 403 by adding persistent stealth browser to BrowserService","description":"Cloudflare now blocks all direct HTTP requests to Kimovil API. Solution: extend BrowserService with persistent stealth browser that bypasses detection using --disable-blink-features=AutomationControlled + webdriver patch. Reuse browser session between searches to avoid repeated page loads.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-21T17:38:26.39231+01:00","updated_at":"2025-12-21T17:49:24.73252+01:00","closed_at":"2025-12-21T17:49:24.73252+01:00"}
{"id":"cod-3hz","title":"Phase 5: Migrate Kimovil Pipeline","description":"Migrate existing Kimovil phone scraping to new entity_data pattern.\n\n## Changes:\n1. Register Kimovil specs pipeline in registry\n2. Refactor ScrapeKimovilService to:\n   - Create scrape records via ScrapeRecordService\n   - Save to entity_data_raw instead of phone_data_raw\n   - Save to entity_data instead of phone_data\n3. Keep PhoneDataService as facade for API backward compatibility\n   - Reads from entity_data_raw/entity_data WHERE source='kimovil' AND data_kind='specs'\n   - Converts to existing RawPhone/Phone types\n\n## Files:\n- apps/scraper/src/services/scrape-kimovil.ts\n- apps/scraper/src/services/phone-data.ts (update as facade)\n- apps/scraper/src/sources/kimovil/specs.ts (new pipeline impl)\n\nEstimated: 3-5 days","acceptance_criteria":"- [ ] Kimovil pipeline registered\n- [ ] New scrapes use entity_data tables\n- [ ] PhoneDataService facade works unchanged\n- [ ] Existing API endpoints work\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:52.081627+01:00","updated_at":"2025-12-21T05:04:25.904919+01:00","closed_at":"2025-12-21T05:04:25.904919+01:00","dependencies":[{"issue_id":"cod-3hz","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.432995+01:00","created_by":"daemon"},{"issue_id":"cod-3hz","depends_on_id":"cod-7ue","type":"blocks","created_at":"2025-12-21T04:41:19.11074+01:00","created_by":"daemon"}]}
{"id":"cod-3qg","title":"Phase 3: Refactor KimovilScraper","description":"Rename scrape-kimovil.ts to kimovil.ts, refactor to use HtmlCacheService directly.","design":"1. Split scrape-kimovil.ts into three files:\n   - kimovil.ts (~300 lines): ScrapeService impl, fetch, cache orchestration\n   - kimovil-extractors.ts (~600 lines): extractPhoneData, getCameras, getSpecs, getSKUs\n   - kimovil-validators.ts (~100 lines): isBotProtectionPage, getHtmlValidationError\n2. kimovil.ts injects HtmlCacheService dependency\n3. Remove direct storage.ts imports for HTML ops\n4. Export extractors/validators for reuse and testing\n5. Prepare interface pattern for future scrapers (GSMArena, etc.)\n6. Update exports and imports across codebase","acceptance_criteria":"- [ ] scrape-kimovil.ts split into kimovil.ts, kimovil-extractors.ts, kimovil-validators.ts\n- [ ] kimovil.ts uses HtmlCacheService for caching\n- [ ] Extractors are pure functions, easily testable\n- [ ] Validators exported for reuse by other scrapers\n- [ ] Clean separation of Kimovil-specific logic\n- [ ] Build passes","notes":"Completed: validators + extractors extracted. scrape-kimovil.ts reduced from 1101 to 595 lines.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T19:31:06.531582+01:00","updated_at":"2025-12-20T19:57:00.587077+01:00","closed_at":"2025-12-20T19:57:00.587077+01:00","dependencies":[{"issue_id":"cod-3qg","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.893932+01:00","created_by":"daemon"},{"issue_id":"cod-3qg","depends_on_id":"cod-8np","type":"blocks","created_at":"2025-12-20T19:35:42.195617+01:00","created_by":"daemon"}]}
{"id":"cod-3xb","title":"Integrate Yandex.Market prices into PhoneDataModal","description":"Add a Prices tab to the existing PhoneDataModal component to allow linking devices to Yandex.Market URLs, scraping prices, and viewing current prices with history. This integrates the backend yandex.scrape and yandex.link WebSocket handlers plus REST endpoints for price data.","design":"Add Prices tab with 3 states: (1) No link - show URL input, (2) Linked no prices - show scrape button, (3) Has prices - show offers list with refresh. Use amber/orange color theme to differentiate from existing tabs.","status":"in_progress","priority":1,"issue_type":"epic","created_at":"2025-12-22T03:08:27.756029+01:00","updated_at":"2025-12-22T03:09:22.526774+01:00","dependencies":[{"issue_id":"cod-3xb","depends_on_id":"cod-syq","type":"blocks","created_at":"2025-12-23T00:55:00.381585+01:00","created_by":"daemon"}]}
{"id":"cod-568","title":"Add price-related types to types.ts","description":"Add TypeScript types for price data structures needed by the frontend.","design":"Add PriceOffer (seller, price, variant, availability), PriceSummary (min/max/count), PriceHistoryEntry (date, stats). Extend ScrapeStatus or create separate DevicePriceStatus.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T03:08:50.535056+01:00","updated_at":"2025-12-22T03:11:35.250985+01:00","closed_at":"2025-12-22T03:11:35.250985+01:00","dependencies":[{"issue_id":"cod-568","depends_on_id":"cod-nzz","type":"blocks","created_at":"2025-12-22T03:08:59.648592+01:00","created_by":"daemon"},{"issue_id":"cod-568","depends_on_id":"cod-a1z","type":"blocks","created_at":"2025-12-22T03:08:59.679333+01:00","created_by":"daemon"},{"issue_id":"cod-568","depends_on_id":"cod-3xb","type":"parent-child","created_at":"2025-12-22T03:09:07.662454+01:00","created_by":"daemon"}]}
{"id":"cod-6i9","title":"Phase 2: Component Refactor","description":"Refactor components to use contexts instead of props.\n\n## Deliverables\n1. DeviceRow.tsx - self-contained row with context consumption\n2. RowActionsMenu.tsx - overflow menu for destructive actions\n3. DevicesTable.tsx refactored (no props, uses contexts)\n4. SelectionBar.tsx refactored (uses SelectionContext)\n\n## Acceptance Criteria\n- [ ] DeviceRow subscribes only to its slug's data\n- [ ] Destructive actions behind overflow menu\n- [ ] No prop drilling in DevicesTable\n- [ ] SelectionBar reads from context\n- [ ] Build passes","design":"\n## DeviceRow Pattern\n- Key by slug\n- Uses useRowDataContext().getStatus(slug) for granular updates\n- Owns expanded state for price loading\n- createResource for lazy price fetch\n\n## RowActionsMenu\n- Trigger: ⋮ button\n- Contains: Clear All, Clear Raw, Clear AI (destructive)\n- Primary actions stay inline: Scrape, View\n\n## Component Hierarchy\nDevicesTableProvider\n├── DevicesTable (layout, header)\n│   └── For each → DeviceRow\n└── SelectionBar (floating)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T17:15:48.675737+01:00","updated_at":"2025-12-23T17:30:05.42846+01:00","closed_at":"2025-12-23T17:30:05.42846+01:00","dependencies":[{"issue_id":"cod-6i9","depends_on_id":"cod-u6l","type":"blocks","created_at":"2025-12-23T17:16:30.593649+01:00","created_by":"daemon"},{"issue_id":"cod-6i9","depends_on_id":"cod-b06","type":"parent-child","created_at":"2025-12-23T17:16:44.725327+01:00","created_by":"daemon"}]}
{"id":"cod-7ue","title":"Phase 6: Cleanup \u0026 Documentation","description":"Remove legacy code paths and update documentation.\n\n## Cleanup:\n- Remove direct phone_data_raw/phone_data writes (keep tables for now)\n- Remove legacy slug-based lookups where device_id should be used\n- Consolidate duplicate code between services\n\n## Documentation:\n- Update AGENTS.md with new architecture\n- Document pipeline registration pattern\n- Add example for new source implementation\n\n## Files:\n- AGENTS.md\n- README.md\n- apps/scraper/src/services/* (cleanup)\n\nEstimated: 2-3 days","acceptance_criteria":"- [ ] Legacy code paths removed\n- [ ] Documentation updated\n- [ ] AGENTS.md reflects new architecture\n- [ ] npm run build passes\n- [ ] npm run check-types passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T04:41:00.226038+01:00","updated_at":"2025-12-21T05:10:28.956992+01:00","closed_at":"2025-12-21T05:10:28.956992+01:00","dependencies":[{"issue_id":"cod-7ue","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.468979+01:00","created_by":"daemon"}]}
{"id":"cod-7y3","title":"Refactor search errors to Effect-idiomatic tagged errors","description":"Replace nested SearchError with structured tagged errors using Data.TaggedError pattern.\n\nCurrent problem:\n- Errors nested multiple times with string messages\n- No structured data (status code, URL, attempt buried in strings)\n- Hard to debug and filter logs\n\nSolution:\n- KimovilHttpError: url, status, statusText, attempt\n- KimovilInvalidResponseError: url, attempt, raw\n- SearchRetryExhaustedError: query, attempts, lastError\n- Map errors once at leaf, don't re-wrap\n- Use log annotations for debugging","acceptance_criteria":"- [ ] New error types using Data.TaggedError\n- [ ] Errors have structured fields (url, status, attempt, etc.)\n- [ ] Single mapError at leaf level\n- [ ] SearchRetryExhaustedError wraps final failure\n- [ ] No nested error wrapping\n- [ ] npm run check-types passes\n- [ ] npm run build passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:59:22.945237+01:00","updated_at":"2025-12-21T18:03:45.204748+01:00","closed_at":"2025-12-21T18:03:45.204748+01:00"}
{"id":"cod-8np","title":"Phase 1: Extract HtmlCacheService","description":"Extract HTML caching logic from storage.ts into dedicated HtmlCacheService. Add 'source' column for multi-source support.","design":"1. Create services/html-cache.ts with Effect service pattern\n2. Move: saveRawHtml, getRawHtml, getRawHtmlIfFresh, getRawHtmlWithAge\n3. Move: recordVerification, verifyHtml, getVerificationStatus, getCorruptedSlugs, getValidSlugs\n4. Add 'source' column to raw_html table (default: 'kimovil')\n5. Update scrape-kimovil.ts to use new service\n6. Keep old methods in storage.ts as deprecated wrappers initially","acceptance_criteria":"- [ ] HtmlCacheService created with Effect Context pattern\n- [ ] All HTML cache methods moved and working\n- [ ] Source column added with migration\n- [ ] scrape-kimovil.ts uses new service\n- [ ] Build passes, existing tests pass","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T19:30:39.8528+01:00","updated_at":"2025-12-20T19:57:00.458486+01:00","closed_at":"2025-12-20T19:57:00.458486+01:00","dependencies":[{"issue_id":"cod-8np","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.767894+01:00","created_by":"daemon"}]}
{"id":"cod-8sx","title":"Phase 6: WebSocket handlers for price scraping","description":"Add WebSocket methods to trigger and monitor Yandex price scraping.\n\n## Implementation\n1. Add WS methods to existing handler:\n   - yandex.scrape: Scrape prices for a device by slug/deviceId\n   - yandex.scrapeByUrl: Scrape given Yandex.Market URL (for new devices)\n   - yandex.linkDevice: Link a Yandex URL to existing device\n\n2. Progress events (reuse existing pattern):\n   - { type: 'progress', stage: 'browser'|'scrape'|'extract'|'save', progress: number }\n   - { type: 'complete', data: { priceCount, minPrice, maxPrice } }\n   - { type: 'error', message: string }\n\n3. Integrate with existing job queue for bulk operations\n\n## Verification\n- WS methods work from frontend\n- Progress streaming works\n- npm run build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:59.065444+01:00","updated_at":"2025-12-22T02:20:15.331586+01:00","closed_at":"2025-12-22T02:20:15.331586+01:00","dependencies":[{"issue_id":"cod-8sx","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.414912+01:00","created_by":"daemon"},{"issue_id":"cod-8sx","depends_on_id":"cod-ag0","type":"blocks","created_at":"2025-12-22T01:56:55.286956+01:00","created_by":"daemon"}]}
{"id":"cod-8w7","title":"Phase 3: Price storage service","description":"Create PriceService for writing price quotes and updating summaries.\n\n## Implementation\n1. Create src/services/price.ts with PriceService:\n   - savePriceQuotes(deviceId, source, offers[], scrapeId): Effect\n   - updatePriceSummary(deviceId): Effect\n   - getPriceHistory(deviceId, options): Effect\n\n2. Methods:\n   - savePriceQuotes: Insert rows to price_quotes with all fields\n   - updatePriceSummary: Compute min/max from available quotes, upsert price_summary\n   - getPriceHistory: Query for charts (group by date, optional variant filter)\n\n3. Use @effect/sql patterns from existing services\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:26.085766+01:00","updated_at":"2025-12-22T02:07:52.492635+01:00","closed_at":"2025-12-22T02:07:52.492635+01:00","dependencies":[{"issue_id":"cod-8w7","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.316892+01:00","created_by":"daemon"},{"issue_id":"cod-8w7","depends_on_id":"cod-a4l","type":"blocks","created_at":"2025-12-22T01:56:55.200072+01:00","created_by":"daemon"}]}
{"id":"cod-8wi","title":"Phase 1: Extend BrowserService interface and convert to Layer.scoped","description":"Add withPersistentStealthPage method signature. Convert BrowserServiceLive from Layer.succeed to Layer.scoped. Add Ref\u003cOption\u003c{browser, page}\u003e\u003e and Semaphore(1) for state management.","acceptance_criteria":"- [ ] Interface has withPersistentStealthPage method\n- [ ] Layer converted to Layer.scoped with acquireRelease\n- [ ] State refs created (browser/page Ref, Semaphore)\n- [ ] Existing scoped methods unchanged\n- [ ] npm run check-types passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:38:37.19559+01:00","updated_at":"2025-12-21T17:42:38.425932+01:00","closed_at":"2025-12-21T17:42:38.425932+01:00","dependencies":[{"issue_id":"cod-8wi","depends_on_id":"cod-3a9","type":"parent-child","created_at":"2025-12-21T17:39:10.451215+01:00","created_by":"daemon"}]}
{"id":"cod-a1z","title":"Add Prices tab to PhoneDataModal","description":"The main implementation: add a Prices tab that handles linking, scraping, and displaying Yandex.Market price data.","design":"Three states: (1) No link - input field for Yandex.Market URL with Link button and validation, (2) Linked but no prices - show linked URL with Scrape Prices button and progress indicator, (3) Has prices - show summary (min-max, count, updated time), offers list (seller, price, variant, availability), Refresh button. Use WebSocket for yandex.link and yandex.scrape calls. Handle progress events during scraping.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T03:08:51.127539+01:00","updated_at":"2025-12-22T03:21:52.887892+01:00","closed_at":"2025-12-22T03:21:52.887892+01:00","dependencies":[{"issue_id":"cod-a1z","depends_on_id":"cod-3xb","type":"parent-child","created_at":"2025-12-22T03:09:07.749101+01:00","created_by":"daemon"}]}
{"id":"cod-a4l","title":"Phase 2: Yandex.Market price extractor","description":"Create extraction logic for Yandex.Market price data from HTML.\n\n## Implementation\n1. Create src/sources/yandex_market/ directory\n2. Create extractor.ts with:\n   - parseYandexPrices(html: string): YandexOffer[]\n   - Extract from embedded JSON patterns:\n     - \"price\":{\"value\":N,\"currency\":\"RUR\"}\n     - \"actualPrice\":{\"amount\":{\"intPart\":N}}\n     - \"businessName\", \"businessId\", \"shopName\"\n     - oldPrice, discountPercent\n   - Normalize currency RUR → RUB\n\n3. Define types:\n   - YandexOffer: sellerName, sellerId, priceMinorUnits, currency, oldPrice, discount, variantKey, variantLabel, url, isAvailable\n\n## Verification\n- Unit tests for extractor\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:15.932339+01:00","updated_at":"2025-12-22T02:04:32.972833+01:00","closed_at":"2025-12-22T02:04:32.972833+01:00","dependencies":[{"issue_id":"cod-a4l","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.284817+01:00","created_by":"daemon"},{"issue_id":"cod-a4l","depends_on_id":"cod-uzr","type":"blocks","created_at":"2025-12-22T01:56:55.170611+01:00","created_by":"daemon"}]}
{"id":"cod-abp","title":"Epic: Yandex.Market Price Scraping","description":"Add ability to scrape Yandex.Market product pages for phone prices. Enables price history tracking and charts.\n\n## Research Findings\n- Local Playwright: 403 + captcha (blocked)\n- Bright Data: Works (2.5MB HTML with prices)\n- Price data: JSON embedded in page with seller info, variants, discounts\n\n## URL Pattern\nhttps://market.yandex.ru/card/{product-name}/{product-id}\n\n## Goals\n1. Link devices to Yandex.Market URLs via device_sources\n2. Scrape prices using Bright Data\n3. Extract multi-seller price quotes with variants\n4. Store price history for charting\n5. Update price_summary with current min/max\n\n## Architecture\n- New source: yandex_market\n- New pipeline: source=yandex_market, dataKind=prices\n- Reuse existing: device_sources, scrapes, entity_data_raw, price_quotes, price_summary","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-22T01:54:53.617706+01:00","updated_at":"2025-12-22T02:20:22.119352+01:00","closed_at":"2025-12-22T02:20:22.119352+01:00"}
{"id":"cod-ag0","title":"Phase 5: API endpoints for price data","description":"Add REST API endpoints for price data access.\n\n## Implementation\n1. Add to existing routes or create new price routes:\n   - GET /api/prices/:deviceId - Current prices (from price_summary + latest quotes)\n   - GET /api/prices/:deviceId/history - Price history for charts\n   - GET /api/prices/:deviceId/quotes - All current quotes with seller info\n\n2. Query parameters for history:\n   - days: number (default 30)\n   - variant: string (filter by variant_key)\n   - groupBy: 'day' | 'hour' (aggregation level)\n\n3. Response format for charts:\n   { \n     dates: string[], \n     minPrices: number[], \n     avgPrices: number[],\n     variants?: string[] \n   }\n\n## Verification\n- Endpoints return valid JSON\n- npm run build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:48.50868+01:00","updated_at":"2025-12-22T02:14:31.691925+01:00","closed_at":"2025-12-22T02:14:31.691925+01:00","dependencies":[{"issue_id":"cod-ag0","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.382032+01:00","created_by":"daemon"},{"issue_id":"cod-ag0","depends_on_id":"cod-ase","type":"blocks","created_at":"2025-12-22T01:56:55.257689+01:00","created_by":"daemon"}]}
{"id":"cod-apr","title":"Separate clear/refresh actions for Raw and AI data","description":"Add granular data management: separate 'Clear Raw Data' and 'Clear AI Data' buttons, plus 'Refresh Raw' (re-run extractors) and 'Refresh AI' (re-run Gemini) actions. Integrate into table row actions, PhoneDataModal tabs, and bulk selection bar.\n\n## Oracle-Validated API Contract\n\n### Delete endpoints (clear data):\n- DELETE /api/phone-data/raw/:slug - clear phone_data_raw only\n- DELETE /api/phone-data/:slug - clear phone_data only\n- Keep DELETE /api/scrape/html/:slug for raw_html (update to actually clear HTML)\n\n### Process endpoints (refresh):\n- POST /api/process/raw - re-run extractors on cached HTML (exists)\n- POST /api/process/ai - re-run Gemini on raw data (exists)\n\n### Edge cases to handle:\n- Refresh with missing source: 404/409 response\n- No cascade: clearing AI doesn't clear Raw (and vice versa)\n- Concurrency guard: check if slug is running in job_queue\n\n## UI Integration Points\n1. DevicesTable row actions: Clear Raw, Clear AI buttons\n2. PhoneDataModal tabs: Refresh button per tab (Raw/AI)\n3. SelectionBar: Bulk clear raw/AI actions","design":"## Backend Changes (api.ts + phone-data.ts)\n\n### PhoneDataService additions:\n- deleteRaw(slug): DELETE from phone_data_raw WHERE slug\n- delete(slug): DELETE from phone_data WHERE slug\n\n### New API routes:\n- DELETE /api/phone-data/raw/:slug → phoneData.deleteRaw(slug)\n- DELETE /api/phone-data/:slug → phoneData.delete(slug)\n\n### Update existing routes:\n- POST /api/process/raw: Add 404 check for missing HTML\n- POST /api/process/ai: Add 404 check for missing raw data\n\n## Frontend Changes\n\n### useSlugsApi.ts additions:\n- clearRawData(slug): DELETE /api/phone-data/raw/:slug\n- clearAiData(slug): DELETE /api/phone-data/:slug\n- refreshRawData(slug): POST /api/process/raw\n- refreshAiData(slug): POST /api/process/ai\n\n### DevicesTable.tsx:\n- Add 'Clear Raw' action button (cyan trash icon)\n- Add 'Clear AI' action button (violet trash icon)\n- Show only when respective data exists\n\n### PhoneDataModal.tsx:\n- Add refresh button to Raw Data tab header\n- Add refresh button to AI Data tab header\n- Loading state during refresh\n- Auto-reload data after refresh\n\n### SelectionBar.tsx:\n- Add 'Clear Raw' bulk action\n- Add 'Clear AI' bulk action","status":"in_progress","priority":1,"issue_type":"feature","created_at":"2025-12-21T21:59:35.823985+01:00","updated_at":"2025-12-21T21:59:48.809881+01:00"}
{"id":"cod-ase","title":"Phase 4: Yandex.Market prices pipeline","description":"Create pipeline for Yandex.Market price scraping using existing pipeline registry pattern.\n\n## Implementation\n1. Create src/sources/yandex_market/prices-pipeline.ts:\n   - Register pipeline: source='yandex_market', dataKind='prices'\n   - Stages: scrape, process_raw\n\n2. scrape stage:\n   - Use BrowserService with Bright Data (required - local blocked)\n   - Navigate to URL from device_sources\n   - Save HTML to raw_html with source='yandex_market'\n   - Create scrapes record\n\n3. process_raw stage:\n   - Load HTML from raw_html\n   - Call extractor to parse offers\n   - Save to entity_data_raw (source='yandex_market', dataKind='prices')\n   - Call PriceService.savePriceQuotes\n   - Call PriceService.updatePriceSummary\n\n4. Create src/sources/yandex_market/index.ts to register pipeline\n\n## Verification\n- Pipeline registers correctly\n- npm run build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:38.605044+01:00","updated_at":"2025-12-22T02:11:33.699364+01:00","closed_at":"2025-12-22T02:11:33.699364+01:00","dependencies":[{"issue_id":"cod-ase","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.348931+01:00","created_by":"daemon"},{"issue_id":"cod-ase","depends_on_id":"cod-8w7","type":"blocks","created_at":"2025-12-22T01:56:55.228831+01:00","created_by":"daemon"}]}
{"id":"cod-b06","title":"Epic: DevicesTable Redesign","description":"Complete redesign of the devices table with improved UX, granular reactivity, and context-based architecture.\n\n## Goals\n1. Clear design language: whole row clickable, data icons open modal tabs\n2. Improved selection: shift-click range, cmd/ctrl multi-select\n3. Prices info integrated into rows\n4. Actions consolidated into overflow menu (no delete next to open)\n5. Context-based architecture with granular SolidJS reactivity\n\n## Design Direction: Industrial Precision\nUtilitarian, data-dense aesthetic. Monospace for data, tight spacing, color coding over decoration.\n\n## Architecture\n- DevicesTableProvider with 4 contexts (Devices, Selection, RowData, Actions)\n- createStore for status maps (granular per-key updates)\n- SelectionService with modifier key support\n- Lazy price loading via createResource","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-23T17:15:17.088306+01:00","updated_at":"2025-12-23T17:52:52.307875+01:00","closed_at":"2025-12-23T17:52:52.307875+01:00"}
{"id":"cod-b4n","title":"Phase 3: Core Services Implementation","description":"Implement new core services for device registry, entity data, and scrape management.\n\n## New services:\n1. DeviceRegistryService - Manage devices + device_sources\n   - lookupDevice(source, externalId)\n   - createDevice(slug, name, brand)\n   - linkDeviceToSource(deviceId, source, externalId, url)\n   - getDeviceById/getDeviceBySlug\n\n2. EntityDataService - Abstract entity_data_raw + entity_data\n   - saveRawData(deviceId, source, dataKind, data, scrapeId?)\n   - saveFinalData(deviceId, dataKind, data)\n   - getRawData/getFinalData\n\n3. ScrapeRecordService - Manage scrapes table lifecycle\n   - createScrape(deviceId, source, dataKind, externalId, url)\n   - startScrape(id)\n   - completeScrape(id)\n   - failScrape(id, error)\n\n## Domain models:\n- Device, DeviceSourceLink schemas\n- DataKind type: 'specs' | 'prices' | 'reviews' | 'availability'\n\n## Files:\n- apps/scraper/src/services/device-registry.ts (new)\n- apps/scraper/src/services/entity-data.ts (new)\n- apps/scraper/src/services/scrape-record.ts (new)\n- packages/scraper-domain/src/models/device.ts (new)\n\nEstimated: 3-4 days","acceptance_criteria":"- [ ] DeviceRegistryService implemented with tests\n- [ ] EntityDataService implemented\n- [ ] ScrapeRecordService implemented\n- [ ] Device + DeviceSourceLink schemas defined\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:29.519649+01:00","updated_at":"2025-12-21T04:54:29.687519+01:00","closed_at":"2025-12-21T04:54:29.687519+01:00","dependencies":[{"issue_id":"cod-b4n","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.366509+01:00","created_by":"daemon"},{"issue_id":"cod-b4n","depends_on_id":"cod-li6","type":"blocks","created_at":"2025-12-21T04:41:19.048277+01:00","created_by":"daemon"}]}
{"id":"cod-baw","title":"Unified search UI: local DB + Kimovil","description":"Update web UI search on index page to search both local devices DB and Kimovil API. Show local results instantly, then load Kimovil additions.\n\nRequirements:\n- Search local devices table first (fast, instant results)\n- Optionally fetch Kimovil API for devices not in DB\n- Clean, modern UI to display mixed results\n- Clear visual distinction between local vs Kimovil-only items\n- Fast perceived performance (show local results immediately)","design":"Consider:\n- Parallel search: local DB query + Kimovil API call\n- Show local results first, append Kimovil results as they arrive\n- UI indicators: checkmark for 'in DB', plus icon for 'add from Kimovil'\n- Debounced search input\n- Loading states for each source","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-21T17:56:07.30486+01:00","updated_at":"2025-12-21T17:56:07.30486+01:00"}
{"id":"cod-bb8","title":"Refactor storage.ts into modular service architecture","description":"Split the 2075-line storage.ts monolith into focused, testable services. Enable multi-source scraping architecture with shared infrastructure. See architecture diagram in thread T-019b3cfd-8ef0-770e-8cb1-2293860be2fb.","design":"Phase 1: Extract data layer services (HtmlCacheService, JobQueueService, DeviceService)\nPhase 2: Create PhoneDataService, refactor OpenAI integration  \nPhase 3: Refactor scrapers to use new services, prepare for multi-source\nPhase 4: Update LiveLayer composition, cleanup deprecated code","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-20T19:30:30.435199+01:00","updated_at":"2025-12-20T23:40:55.273208+01:00","closed_at":"2025-12-20T23:40:55.273208+01:00"}
{"id":"cod-c4w","title":"Shared helpers \u0026 types for JobsSection","description":"Create centralized helpers for status logic, CSS classes, and progress calculations. Eliminates duplication across components.","design":"Create jobViewHelpers.ts with: getDisplayStatus(), isActiveStatus(), statusLabel(), statusPillClass(), statusDotClass(), progressPercent(), progressBarClass(). Export DisplayStatus type.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T00:17:06.635494+01:00","updated_at":"2025-12-22T00:27:47.368014+01:00","closed_at":"2025-12-22T00:27:47.368014+01:00","dependencies":[{"issue_id":"cod-c4w","depends_on_id":"cod-t8h","type":"parent-child","created_at":"2025-12-22T00:17:37.489055+01:00","created_by":"daemon"},{"issue_id":"cod-c4w","depends_on_id":"cod-u5r","type":"blocks","created_at":"2025-12-22T00:17:37.592264+01:00","created_by":"daemon"}]}
{"id":"cod-cnh","title":"Phase 3: API endpoints for schedules","description":"Add REST API endpoints for managing schedules.\n\n## Endpoints\n- GET /api/schedules - list all schedules with status\n- GET /api/schedules/:id - get single schedule details\n- POST /api/schedules - create new schedule\n- PUT /api/schedules/:id - update schedule\n- DELETE /api/schedules/:id - delete schedule\n- POST /api/schedules/:id/enable - enable schedule\n- POST /api/schedules/:id/disable - disable schedule\n- POST /api/schedules/:id/trigger - manual trigger (creates job immediately)\n\n## Response Format\nSchedule object with:\n- id, name, source, dataKind, jobType, mode\n- cronExpression, timezone, enabled\n- nextRunAt, lastRunAt, lastStatus, lastError, lastJobId\n\n## Files\n- apps/scraper/src/routes/api.ts (add schedule routes)","acceptance_criteria":"- [ ] All CRUD endpoints implemented\n- [ ] enable/disable endpoints work\n- [ ] trigger endpoint creates and starts job\n- [ ] Proper error handling (404, validation)\n- [ ] npm run build passes\n- [ ] npm run check-types passes","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-12-23T18:03:04.974735+01:00","updated_at":"2025-12-23T18:15:07.956162+01:00","dependencies":[{"issue_id":"cod-cnh","depends_on_id":"cod-eip","type":"parent-child","created_at":"2025-12-23T18:03:24.971048+01:00","created_by":"daemon"},{"issue_id":"cod-cnh","depends_on_id":"cod-s4i","type":"blocks","created_at":"2025-12-23T18:03:45.236863+01:00","created_by":"daemon"}]}
{"id":"cod-co8","title":"Phase 1: Extract JobQueueService","description":"Extract job queue CRUD from storage.ts into dedicated JobQueueService.","design":"1. Create services/job-queue.ts\n2. Move: createJob, getJob, getAllJobs, updateJobStatus, getJobStats\n3. Move: enqueueJobSlugs, claimNextJobQueueItem, completeQueueItem, rescheduleQueueItem\n4. Move: resetStuckQueueItems, resetErrorQueueItems, getErrorQueueItems, unclaimRunningItems, getTimeoutStats\n5. Move deprecated bulk job methods as aliases\n6. Update bulk-job.ts to use new service","acceptance_criteria":"- [ ] JobQueueService created with Effect Context pattern\n- [ ] All job/queue methods moved\n- [ ] bulk-job.ts uses new service\n- [ ] Build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T19:30:46.941906+01:00","updated_at":"2025-12-20T19:57:00.492287+01:00","closed_at":"2025-12-20T19:57:00.492287+01:00","dependencies":[{"issue_id":"cod-co8","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.801291+01:00","created_by":"daemon"}]}
{"id":"cod-cvb","title":"Phase 1: Schema + SchedulerService core","description":"Add job_schedules table and implement SchedulerService with CRUD operations.\n\n## Schema: job_schedules\n- id INTEGER PRIMARY KEY\n- name TEXT NOT NULL\n- source TEXT NOT NULL (e.g., 'yandex_market')\n- data_kind TEXT NOT NULL (e.g., 'prices')\n- job_type TEXT NOT NULL DEFAULT 'scrape'\n- mode TEXT NOT NULL DEFAULT 'fast'\n- filter TEXT (optional JSON array of slugs, null = all)\n- enabled INTEGER DEFAULT 0 (disabled by default!)\n- cron_expression TEXT NOT NULL\n- timezone TEXT DEFAULT 'UTC'\n- next_run_at INTEGER\n- last_run_at INTEGER\n- last_status TEXT ('success'|'error'|'skipped')\n- last_error TEXT\n- last_job_id TEXT (FK to jobs.id)\n- locked_until INTEGER (crash-safety lock)\n- created_at/updated_at\n\n## SchedulerService Interface\n- listSchedules()\n- getSchedule(id)\n- upsertSchedule(input)\n- enableSchedule(id)\n- disableSchedule(id)\n- deleteSchedule(id)\n- triggerNow(id) → jobId\n\n## Files\n- apps/scraper/src/sql/schema.ts (add migration)\n- apps/scraper/src/services/scheduler.ts (new)\n- apps/scraper/src/layers/live.ts (add to layer)","acceptance_criteria":"- [ ] job_schedules table created with migration\n- [ ] SchedulerService implemented with all CRUD ops\n- [ ] SchedulerService added to LiveLayer\n- [ ] npm run build passes\n- [ ] npm run check-types passes","notes":"COMPLETED: Phase 1 - Schema + SchedulerService core\n\nCHANGES:\n- Added job_schedules table with indexes (enabled, next_run_at)\n- Created SchedulerService with full CRUD + triggerNow\n- Added to LiveLayer\n\nCOMMIT: 59993c2 (+293 lines)\n\nORACLE REVIEW NOTES:\n- Consider adding CHECK constraint for last_status\n- Consider wrapping upsertSchedule in transaction\n- Phase 2 will need claimDueSchedules + markScheduleResult methods","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T18:02:44.396409+01:00","updated_at":"2025-12-23T18:07:59.797924+01:00","closed_at":"2025-12-23T18:07:59.797924+01:00","dependencies":[{"issue_id":"cod-cvb","depends_on_id":"cod-eip","type":"parent-child","created_at":"2025-12-23T18:03:24.914573+01:00","created_by":"daemon"}]}
{"id":"cod-dre","title":"Phone Data UI Integration","description":"Integrate phone_data_raw and phone_data tables into web UI with tabbed modal (HTML/Raw/AI/Compare), JsonViewer with Shiki highlighting, and redesigned dense table with data indicators.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-20T00:01:28.605046+01:00","updated_at":"2025-12-20T00:01:28.605046+01:00","comments":[{"id":1,"issue_id":"cod-dre","author":"romanzagrebin","text":"Phase 1-3 complete:\n- Backend: GET /api/phone-data/raw/:slug, GET /api/phone-data/:slug\n- Backend: /api/scrape/status now returns hasRawData, hasAiData\n- Frontend types: PhoneDataRaw, PhoneDataAi, Sku, SingleCameraData, Benchmark\n- API hooks: fetchPhoneDataRaw(), fetchPhoneDataAi()\n\nNext: Phase 4 - JsonViewer + TabBar components","created_at":"2025-12-19T23:04:38Z"},{"id":2,"issue_id":"cod-dre","author":"romanzagrebin","text":"Phase 4-5 complete:\n- Installed shiki for JSON syntax highlighting\n- Created JsonViewer component (Shiki highlighting, copy button, loading/empty states)\n- Created TabBar component (HTML/Raw/AI/Compare tabs with status indicators)\n- Created PhoneDataModal (replaces HtmlPreviewModal, tabbed interface, lazy data loading)\n- Updated Slugs.tsx integration\n- Updated DevicesTable to use new modal\n\nFiles created:\n- apps/ws-web/src/pages/slugs/components/JsonViewer.tsx\n- apps/ws-web/src/pages/slugs/components/TabBar.tsx\n- apps/ws-web/src/pages/slugs/components/PhoneDataModal.tsx\n\nType checks pass. Ready for testing.","created_at":"2025-12-19T23:09:10Z"},{"id":3,"issue_id":"cod-dre","author":"romanzagrebin","text":"Phase 6+8 complete:\n- Created DataStatusIcons component (HTML/Raw/AI/Verified icons with color coding)\n- Redesigned DevicesTable: dense layout, merged Device column (name+slug), separate Queue column, data icons\n- Updated StatsPanel: 6-column responsive grid with Raw Data + AI Data counts\n- Backend /api/slugs now returns rawData/aiData counts\n\nAll phases complete. Ready for testing.","created_at":"2025-12-19T23:12:49Z"}]}
{"id":"cod-dt2","title":"Implement rich CpuCoreCluster format for CPU cores parsing","description":"Current cpuCores format is string[] like ['4x2400', '4x2000'] which loses valuable data. Need structured format preserving core names (Cortex A78, Kryo, Firestorm), P/E core classification, and handling no-frequency cores (Apple devices).","design":"Add CpuCoreCluster interface: { count, maxFreqMhz, label, role, rawGroup, index }. Create getCpuCoreClusters() in parsers.ts, keep getCpuCores() as adapter. Update RawPhoneData in extractors.ts, scraper-domain, and scraper-protocol schemas.","acceptance_criteria":"- [ ] CpuCoreCluster type defined with count, maxFreqMhz, label, role, rawGroup, index\n- [ ] getCpuCoreClusters() parses all format variations from exploration\n- [ ] getCpuCores() adapter returns string[] for backward compat\n- [ ] Handles no-frequency cores (Apple: Firestorm, Avalanche, etc.)\n- [ ] Detects P/E core roles from keywords and known mappings\n- [ ] Effect Schemas updated in scraper-domain and scraper-protocol\n- [ ] Type checks pass\n- [ ] Existing tests still work","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-21T22:25:19.083937+01:00","updated_at":"2025-12-21T22:31:15.314286+01:00","closed_at":"2025-12-21T22:31:15.314286+01:00"}
{"id":"cod-duf","title":"Phase 1: Extract DeviceService","description":"Extract device and prefix CRUD from storage.ts into dedicated DeviceService.","design":"1. Create services/device.ts\n2. Move: upsertDevice, getDevice, getDeviceCount, getAllDevices\n3. Move: enqueuePrefix, getNextPendingPrefix, markPrefixDone, getPendingPrefixCount, seedInitialPrefixes, resetAllPrefixes\n4. Update slug-crawler.ts to use new service","acceptance_criteria":"- [ ] DeviceService created with Effect Context pattern\n- [ ] All device/prefix methods moved\n- [ ] slug-crawler.ts uses new service\n- [ ] Build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T19:30:52.435115+01:00","updated_at":"2025-12-20T19:57:00.524369+01:00","closed_at":"2025-12-20T19:57:00.524369+01:00","dependencies":[{"issue_id":"cod-duf","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.832406+01:00","created_by":"daemon"}]}
{"id":"cod-eip","title":"Epic: Recurring Cron Jobs for Price Updates","description":"Add robust recurring/scheduled jobs functionality for automated price updates. Build Effect-native scheduler with SQLite persistence.\n\n## Architecture\n- New SchedulerService (separate from JobQueueService)\n- job_schedules table for persistence\n- Daemon Effect fiber polling DB\n- Croner library for cron expression parsing only\n- Auto-trigger when enabled, disabled by default\n\n## Key Features\n1. Cron expressions in backend, simple intervals in UI\n2. Schedules opt-in per device/source\n3. Crash recovery: missed runs detected and handled\n4. Observability: API endpoints for status\n\n## Phases\n1. Schema + SchedulerService core\n2. Scheduler daemon loop\n3. API endpoints\n4. UI integration (optional/future)","status":"in_progress","priority":1,"issue_type":"epic","created_at":"2025-12-23T18:02:30.111455+01:00","updated_at":"2025-12-23T18:04:02.736931+01:00"}
{"id":"cod-f3t","title":"Epic: Multi-Source Device Data Platform Refactor (V3)","description":"Evolve from Kimovil scraper to multi-source device data platform. Make devices central and source-agnostic. Treat scrapes as first-class entities. Let each data kind define its own schema but reuse same infrastructure.\n\nKey changes:\n- devices table as canonical registry\n- device_sources for external source links\n- scrapes table for individual attempts\n- entity_data_raw + entity_data for generic data storage\n- price_quotes for multi-row price data\n- source + dataKind aware job queue\n\nEstimated: 2-3 weeks\n\nReference: REFACTOR_PLAN_V3.md","design":"Pipeline registry pattern: (source, dataKind, stage) → handler. Each source implements stages: scrape → process_raw → process_ai","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-21T04:39:56.921903+01:00","updated_at":"2025-12-21T05:10:36.388891+01:00","closed_at":"2025-12-21T05:10:36.388891+01:00"}
{"id":"cod-fzn","title":"Phase 5: Introduce DatabaseService layer","description":"Replace singleton getDb() pattern with proper Effect DatabaseService for idiomatic dependency injection.","design":"1. Create DatabaseService interface in db.ts with { db: Database.Database }\n2. Create DatabaseServiceLive layer that initializes connection + runs all migrations\n3. Update all data services (JobQueue, HtmlCache, Device, PhoneData) to yield* DatabaseService\n4. Update LiveLayer to provide DatabaseServiceLive to all data services\n5. Remove duplicate getDb() singletons from each service\n6. Enables proper testing with mock database","acceptance_criteria":"- [ ] DatabaseService created with Effect Context pattern\n- [ ] All data services depend on DatabaseService via yield*\n- [ ] Single shared connection guaranteed by Effect\n- [ ] No duplicate getDb() functions\n- [ ] Build passes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-20T19:47:01.359117+01:00","updated_at":"2025-12-20T23:40:51.463908+01:00","closed_at":"2025-12-20T23:40:51.463908+01:00","dependencies":[{"issue_id":"cod-fzn","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:47:05.88226+01:00","created_by":"daemon"},{"issue_id":"cod-fzn","depends_on_id":"cod-x5r","type":"blocks","created_at":"2025-12-20T19:47:05.914207+01:00","created_by":"daemon"}]}
{"id":"cod-gb9","title":"Fix 4: Populate variantLabel from Yandex HTML","description":"Extract human-readable variant labels (RAM/storage) from Yandex.Market HTML.\n\n## Implementation\n1. Analyze /tmp/yandex-brightdata.html for variant/SKU patterns\n2. Update apps/scraper/src/sources/yandex_market/extractor.ts:\n   - Look for memorySize, ramSize, or similar fields\n   - Build variantLabel like '4 GB / 128 GB'\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T02:24:37.689954+01:00","updated_at":"2025-12-22T02:39:19.942359+01:00","closed_at":"2025-12-22T02:39:19.942359+01:00","dependencies":[{"issue_id":"cod-gb9","depends_on_id":"cod-ulx","type":"parent-child","created_at":"2025-12-22T02:24:45.50384+01:00","created_by":"daemon"},{"issue_id":"cod-gb9","depends_on_id":"cod-v72","type":"blocks","created_at":"2025-12-22T02:24:45.599006+01:00","created_by":"daemon"}]}
{"id":"cod-li6","title":"Phase 4: Job Queue Extensions","description":"Extend job queue with source + dataKind awareness and implement pipeline registry.\n\n## JobQueueService changes:\n- Add source, dataKind to Job and JobQueueItem types\n- Extend createJob, enqueueJobSlugs with source/dataKind params\n- Add claimNextByPipeline(source, dataKind, jobType)\n\n## Pipeline Registry:\n\\`\\`\\`typescript\ninterface PipelineDefinition {\n  source: string;\n  dataKind: DataKind;\n  stages: Record\u003cPipelineStage, StageHandler\u003e;\n}\n\nconst pipelineRegistry = new Map\u003cstring, PipelineDefinition\u003e();\nconst registerPipeline = (def: PipelineDefinition) =\u003e ...\nconst getPipeline = (source, dataKind) =\u003e ...\n\\`\\`\\`\n\n## Worker updates:\n- Lookup pipeline by source + dataKind\n- Build PipelineContext and execute stage handler\n\n## Files:\n- apps/scraper/src/services/job-queue.ts\n- apps/scraper/src/pipeline/registry.ts (new)\n- apps/scraper/src/pipeline/context.ts (new)\n\nEstimated: 2-3 days","acceptance_criteria":"- [ ] Job/JobQueueItem types extended with source/dataKind\n- [ ] Pipeline registry implemented\n- [ ] Workers use pipeline registry for dispatch\n- [ ] Backward compatible (defaults to kimovil/specs)\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:40.986329+01:00","updated_at":"2025-12-21T05:00:23.031041+01:00","closed_at":"2025-12-21T05:00:23.031041+01:00","dependencies":[{"issue_id":"cod-li6","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.398203+01:00","created_by":"daemon"},{"issue_id":"cod-li6","depends_on_id":"cod-3hz","type":"blocks","created_at":"2025-12-21T04:41:19.077658+01:00","created_by":"daemon"}]}
{"id":"cod-mqu","title":"Phase 3: Modify SearchServiceKimovil to use BrowserService","description":"Replace HttpClient dependency with BrowserService. Use withPersistentStealthPage + page.evaluate(fetch) to call Kimovil API from page context. Keep existing Stream\u003cSearchEvent|SearchResult\u003e API and retry logic.","acceptance_criteria":"- [ ] SearchServiceKimovil depends on BrowserService (not HttpClient)\n- [ ] API call via page.evaluate(fetch(...))\n- [ ] Existing retry logic preserved\n- [ ] Stream API unchanged\n- [ ] live.ts updated to provide BrowserServiceLive to SearchServiceLayer\n- [ ] npm run check-types passes\n- [ ] Search works end-to-end (manual test)","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:38:56.65028+01:00","updated_at":"2025-12-21T17:49:17.57929+01:00","closed_at":"2025-12-21T17:49:17.57929+01:00","dependencies":[{"issue_id":"cod-mqu","depends_on_id":"cod-3a9","type":"parent-child","created_at":"2025-12-21T17:39:10.513827+01:00","created_by":"daemon"},{"issue_id":"cod-mqu","depends_on_id":"cod-2i2","type":"blocks","created_at":"2025-12-21T17:39:23.099275+01:00","created_by":"daemon"}]}
{"id":"cod-nah","title":"Phase 4: Integration \u0026 Cleanup","description":"Wire everything together in Slugs.tsx and clean up.\n\n## Deliverables\n1. DevicesTableProvider wrapped in Slugs.tsx\n2. Remove prop drilling, unused handlers\n3. Keyboard navigation (arrow keys, space to select)\n4. Final testing and polish\n\n## Acceptance Criteria\n- [ ] Slugs.tsx uses provider pattern\n- [ ] No unused props/handlers remain\n- [ ] Arrow keys navigate rows\n- [ ] Space toggles selection\n- [ ] Full flow works: search, filter, select, actions\n- [ ] Build passes","design":"\n## Provider Integration\n\u003cDevicesTableProvider\n  search={search}\n  filter={filter}\n  limit={limit}\n  onOpenModal={setModalSlug}\n\u003e\n  \u003cDevicesTable /\u003e\n  \u003cSelectionBar /\u003e\n\u003c/DevicesTableProvider\u003e\n\n## Keyboard Navigation\n- ArrowUp/Down: move focus\n- Space: toggle selection\n- Shift+ArrowUp/Down: extend selection\n- Escape: clear selection\n\n## Cleanup\n- Remove unused props from DevicesTableProps\n- Remove handlers moved to context\n- Update any remaining direct useSlugsApi consumers","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T17:16:18.154738+01:00","updated_at":"2025-12-23T17:52:43.032979+01:00","closed_at":"2025-12-23T17:52:43.032979+01:00","dependencies":[{"issue_id":"cod-nah","depends_on_id":"cod-b06","type":"parent-child","created_at":"2025-12-23T17:16:44.781069+01:00","created_by":"daemon"}]}
{"id":"cod-nzz","title":"Add price API methods to useSlugsApi hook","description":"Add REST API calls for fetching price data from the backend.","design":"Add fetchPrices(deviceId) calling GET /api/prices/:deviceId. Add fetchPriceHistory(deviceId, days) calling GET /api/prices/:deviceId/history. Return typed responses.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T03:08:50.738103+01:00","updated_at":"2025-12-22T03:13:49.8017+01:00","closed_at":"2025-12-22T03:13:49.8017+01:00","dependencies":[{"issue_id":"cod-nzz","depends_on_id":"cod-a1z","type":"blocks","created_at":"2025-12-22T03:08:59.70924+01:00","created_by":"daemon"},{"issue_id":"cod-nzz","depends_on_id":"cod-3xb","type":"parent-child","created_at":"2025-12-22T03:09:07.691906+01:00","created_by":"daemon"}]}
{"id":"cod-pgg","title":"Phase 1: Schema Extensions","description":"Add source/data_kind columns to existing tables and create new tables.\n\n## Tables to modify:\n- jobs: ADD source TEXT DEFAULT 'kimovil', data_kind TEXT DEFAULT 'specs'\n- job_queue: ADD source TEXT DEFAULT 'kimovil', data_kind TEXT DEFAULT 'specs', scrape_id INTEGER\n- raw_html: ADD scrape_id INTEGER\n- scrape_verification: ADD scrape_id INTEGER\n\n## New tables:\n- devices (id, slug, name, brand, created_at, updated_at)\n- device_sources (device_id, source, external_id, url, status, first_seen, last_seen)\n- scrapes (id, device_id, source, data_kind, external_id, url, requested_at, started_at, completed_at, status, error_message)\n- entity_data_raw (id, device_id, source, data_kind, scrape_id, data, created_at, updated_at)\n- entity_data (id, device_id, data_kind, data, created_at, updated_at)\n- price_quotes (id, device_id, source, seller, price_minor_units, currency, url, scraped_at, scrape_id, is_available)\n- price_summary (device_id, min_price, max_price, currency, updated_at)\n\n## Files:\n- apps/scraper/src/sql/schema.ts\n\nEstimated: 1-2 days","acceptance_criteria":"- [ ] All ALTER TABLE migrations run without error\n- [ ] New tables created with indexes\n- [ ] Defaults preserve backward compatibility\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:09.338913+01:00","updated_at":"2025-12-21T04:47:19.772919+01:00","closed_at":"2025-12-21T04:47:19.772919+01:00","dependencies":[{"issue_id":"cod-pgg","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.30202+01:00","created_by":"daemon"},{"issue_id":"cod-pgg","depends_on_id":"cod-26h","type":"blocks","created_at":"2025-12-21T04:41:18.984493+01:00","created_by":"daemon"}]}
{"id":"cod-pr6","title":"Update AI service and UI for cpuCoreClusters + rename to RobotService","description":"AI service needs updates after cpuCoreClusters addition. Also rename OpenAIService to RobotService and improve error handling/progress in web UI when processing AI from modal.","design":"1. Rename openai.ts to robot.ts, OpenAIService to RobotService, OpenAIError to RobotError\n2. Update validateAndMerge to include cpuCoreClusters field\n3. Improve PhoneDataModal to show progress/errors during AI processing (not just spinner)\n4. Update all imports and references across codebase","acceptance_criteria":"- [ ] openai.ts renamed to robot.ts\n- [ ] OpenAIService → RobotService everywhere\n- [ ] OpenAIError → RobotError\n- [ ] cpuCoreClusters passed through to final PhoneData\n- [ ] PhoneDataModal shows error messages on AI failure\n- [ ] Type checks pass","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-21T22:36:43.079116+01:00","updated_at":"2025-12-21T22:43:27.393549+01:00","closed_at":"2025-12-21T22:43:27.393549+01:00"}
{"id":"cod-pt7","title":"Epic: Unified Effect + SQL Migration","description":"Migrate to @effect/sql + idiomatic Effect patterns. Combines Epic 2 (Effect patterns) with Schema Refactor.\n\n## Goals\n- Replace raw better-sqlite3 with @effect/sql\n- Eliminate Effect.runPromise escapes\n- Add proper resource management (acquireRelease)\n- Domain models with Model.Class\n- Quarantine table for corrupted data\n- Structured logging\n\n## Constraints\n- App not live (can go offline, change schema freely)\n- No external DB consumers\n- ~50 writes/sec peak\n- Fail fast + quarantine corrupted data\n- Model.Class for DB entities only\n- Backup restore acceptable\n\n## Estimated Effort\n1.5-2 days\n\n## Reference\nSee REFACTOR_PLAN_V2.md for full details","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-21T00:32:25.806026+01:00","updated_at":"2025-12-21T00:32:25.806026+01:00"}
{"id":"cod-pt7.1","title":"Phase 0: Browser Resource Management","description":"Fix browser leak before touching DB. Isolated change that reduces flakes during later work.\n\n## Tasks\n- Add Effect.acquireRelease to BrowserService.createBrowser()\n- Add Effect.acquireRelease to BrowserService.createLocalBrowser()\n- Update callers to use Effect.scoped\n- Verify no browser processes leak after scrape errors\n\n## Files\n- apps/scraper/src/services/browser.ts\n- apps/scraper/src/services/scrape-kimovil.ts\n- apps/scraper/src/services/bulk-job.ts\n\n## Pattern\n```typescript\nconst withBrowser = Effect.acquireRelease(\n  browserService.createBrowser(),\n  (browser) =\u003e Effect.promise(() =\u003e browser.close())\n);\n\n// Usage\nEffect.scoped(\n  Effect.gen(function* () {\n    const browser = yield* withBrowser;\n    // use browser...\n  })\n); // browser.close() called automatically\n```\n\n## Verification\n- Run scrape, kill mid-way, check no orphan Chrome processes\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:32:39.426645+01:00","updated_at":"2025-12-21T01:40:11.774452+01:00","closed_at":"2025-12-21T01:40:11.774452+01:00","dependencies":[{"issue_id":"cod-pt7.1","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:32:39.42709+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.10","title":"Phase 9: Update AI Service","description":"Use domain models, eliminate runPromise escapes.\n\n## Tasks\n- Import Phone schema from @repo/scraper-domain\n- Delete duplicate schemas (NormalizedDataSchema, CameraSchema, etc.)\n- Keep Vercel AI SDK (@ai-sdk/google) - don't switch\n- Wrap AI calls in Effect.tryPromise\n- Return typed Effect, not Promise\n\n## Pattern\n```typescript\nconst adaptScrapedData = (rawData: Record\u003cstring, unknown\u003e) =\u003e\n  Effect.tryPromise({\n    try: () =\u003e generateObject({\n      model: google('gemini-2.0-flash'),\n      schema: PhoneSchema,  // From @repo/scraper-domain\n      prompt: buildPrompt(rawData),\n    }),\n    catch: (e) =\u003e new AiError({ cause: e }),\n  }).pipe(\n    Effect.map(result =\u003e result.object),\n    Effect.retry(Schedule.exponential('1 second').pipe(\n      Schedule.compose(Schedule.recurs(3))\n    ))\n  );\n```\n\n## Files\n- apps/scraper/src/services/openai.ts\n\n## Verification\n- AI normalization works end-to-end\n- No duplicate schema definitions\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:34:15.906759+01:00","updated_at":"2025-12-21T02:09:26.708511+01:00","closed_at":"2025-12-21T02:09:26.708511+01:00","dependencies":[{"issue_id":"cod-pt7.10","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:15.907295+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.10","depends_on_id":"cod-pt7.9","type":"blocks","created_at":"2025-12-21T00:35:34.926815+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.11","title":"Phase 10: Update Scrape Service","description":"Use new repositories, eliminate runPromise escapes.\n\n## Tasks\n- Update scrape-kimovil.ts to use new PhoneRepo\n- Replace Effect.runPromise calls with yield*\n- Use Effect.acquireRelease for page lifecycle\n- Stay in Effect context throughout\n\n## Before/After\n```typescript\n// Before\nconst html = await Effect.runPromise(htmlCache.getRawHtml(slug));\nconst browser = await Effect.runPromise(browserService.createBrowser());\n\n// After\nconst html = yield* htmlCache.getRawHtml(slug);\nconst browser = yield* Effect.scoped(withBrowser);\n```\n\n## Key Changes\n- scrape() returns Effect.Effect, not Promise\n- scrapeFast() returns Effect.Effect, not Promise\n- All internal calls use yield*, not await + runPromise\n- Page lifecycle managed with acquireRelease\n\n## Files\n- apps/scraper/src/services/scrape-kimovil.ts\n\n## Verification\n- Full scrape works end-to-end\n- No Effect.runPromise in service code\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-21T00:34:25.285122+01:00","updated_at":"2025-12-21T02:18:18.242749+01:00","closed_at":"2025-12-21T02:18:18.242749+01:00","dependencies":[{"issue_id":"cod-pt7.11","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:25.285575+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.11","depends_on_id":"cod-pt7.9","type":"blocks","created_at":"2025-12-21T00:35:34.961481+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.12","title":"Phase 11: Frontend Types","description":"Share types with frontend without adding @effect/schema dependency.\n\n## Tasks\n- Export plain TS types derived from domain models\n- Update frontend to import from @repo/scraper-domain\n- Remove duplicate type definitions in frontend\n\n## Pattern\n```typescript\n// @repo/scraper-domain/index.ts\nimport type { Phone as PhoneModel } from './models/phone';\n\n// Re-export as plain type (strips runtime Schema parts)\nexport type Phone = PhoneModel;\nexport type Camera = PhoneModel['cameras'][number];\n```\n\n## Files\n- packages/scraper-domain/src/index.ts (update exports)\n- apps/ws-web/src/pages/slugs/types.ts (simplify/remove)\n\n## Verification\n- Frontend builds without @effect/schema\n- Types match between backend and frontend\n- npm run check-types passes","status":"closed","priority":3,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-21T00:34:33.845849+01:00","updated_at":"2025-12-21T02:21:48.92588+01:00","closed_at":"2025-12-21T02:21:48.92588+01:00","dependencies":[{"issue_id":"cod-pt7.12","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:33.846277+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.12","depends_on_id":"cod-pt7.10","type":"blocks","created_at":"2025-12-21T00:35:34.993111+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.12","depends_on_id":"cod-pt7.11","type":"blocks","created_at":"2025-12-21T00:35:35.024877+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.13","title":"Phase 12: Structured Logging","description":"Replace console.log with Effect.log*.\n\n## Tasks\n- Replace console.log -\u003e Effect.logInfo\n- Replace console.warn -\u003e Effect.logWarning  \n- Replace console.error -\u003e Effect.logError\n- Add structured annotations where useful\n- Configure log output format\n\n## Pattern\n```typescript\n// Before\nconsole.log(`[HtmlCache] Saved raw HTML for slug: ${slug}`);\n\n// After\nyield* Effect.logInfo('Saved raw HTML').pipe(\n  Effect.annotateLogs({ service: 'HtmlCache', slug })\n);\n```\n\n## Benefits\n- Log levels (debug, info, warn, error)\n- Structured metadata (JSON-friendly)\n- Configurable at runtime\n- Testable (can capture logs)\n\n## Files\n- All service files\n- apps/scraper/src/utils/logger.ts (may delete or adapt)\n\n## Verification\n- Logs appear with proper levels\n- npm run check-types passes","status":"closed","priority":3,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:34:42.763019+01:00","updated_at":"2025-12-21T02:26:38.009441+01:00","closed_at":"2025-12-21T02:26:38.009441+01:00","dependencies":[{"issue_id":"cod-pt7.13","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:42.763481+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.13","depends_on_id":"cod-pt7.12","type":"blocks","created_at":"2025-12-21T00:35:35.056954+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.14","title":"Phase 13: Effect.Stream for WebSocket (Optional)","description":"Replace AsyncGenerator with Effect.Stream for better backpressure.\n\n## Tasks\n- Convert scrape progress events to Stream.Stream\n- Update WebSocket handler to consume stream\n- Add cancellation via Fiber interruption\n\n## Pattern\n```typescript\n// Before\nasync function* runScrape(): AsyncGenerator\u003cScrapeEvent\u003e {\n  yield { type: 'progress', stage: 'browser', progress: 0 };\n  // ...\n}\n\n// After  \nconst runScrape: Stream.Stream\u003cScrapeEvent, ScrapeError, ScrapeService\u003e =\n  Stream.gen(function* () {\n    yield* Stream.emit({ type: 'progress', stage: 'browser', progress: 0 });\n    // ...\n  });\n```\n\n## Benefits\n- Backpressure handling\n- Cancellation via Fiber interruption\n- Composable with other streams\n- Error typing\n\n## Files\n- apps/scraper/src/services/scrape-kimovil.ts\n- apps/scraper/src/routes/ws.ts\n\n## Verification\n- WebSocket progress works\n- Cancellation works\n- npm run check-types passes\n\n## Note\nThis phase is optional - can be deferred if time-constrained.","status":"open","priority":3,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-21T00:34:51.707317+01:00","updated_at":"2025-12-21T00:34:51.707317+01:00","dependencies":[{"issue_id":"cod-pt7.14","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:51.707795+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.14","depends_on_id":"cod-pt7.13","type":"blocks","created_at":"2025-12-21T00:35:35.089457+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.2","title":"Phase 1: Install Packages + Test Harness","description":"Set up @effect/sql and testing infrastructure.\n\n## Tasks\n- Add @effect/sql, @effect/sql-sqlite-node to apps/scraper\n- Add @effect/vitest to dev dependencies\n- Create test harness with temp SQLite DB\n- Write one smoke test proving harness works\n\n## Files\n- apps/scraper/package.json\n- apps/scraper/src/test/setup.ts (new)\n- apps/scraper/src/test/smoke.test.ts (new)\n\n## Test Harness Pattern\n```typescript\n// setup.ts\nimport { SqliteClient } from '@effect/sql-sqlite-node';\n\nexport const TestDbLayer = SqliteClient.layer({\n  filename: ':memory:',\n});\n\nexport const withTestDb = \u003cA, E\u003e(\n  effect: Effect.Effect\u003cA, E, SqlClient\u003e\n) =\u003e effect.pipe(\n  Effect.provide(TestDbLayer),\n  Effect.scoped\n);\n```\n\n## Verification\n- bun test runs and passes\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-21T00:32:52.909917+01:00","updated_at":"2025-12-21T01:40:11.963213+01:00","closed_at":"2025-12-21T01:40:11.963213+01:00","dependencies":[{"issue_id":"cod-pt7.2","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:32:52.9105+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.3","title":"Phase 2: SqlClient Layer + Quarantine","description":"Replace DatabaseService with @effect/sql SqlClient, add quarantine infrastructure.\n\n## Tasks\n- Create apps/scraper/src/sql/client.ts with SqlClient layer\n- Configure WAL mode, busy timeout (for ~50 writes/sec), statement cache\n- Migrate schema initialization to new client\n- Create quarantine table for corrupted data\n- Create quarantine helper: quarantine(slug, sourceTable, data, error)\n- Delete old services/db.ts\n- Update layers/live.ts\n\n## Quarantine Schema\n```sql\nCREATE TABLE IF NOT EXISTS quarantine (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  slug TEXT NOT NULL,\n  source_table TEXT NOT NULL,\n  data TEXT NOT NULL,\n  error TEXT NOT NULL,\n  quarantined_at INTEGER NOT NULL DEFAULT (unixepoch())\n);\nCREATE INDEX idx_quarantine_slug ON quarantine(slug);\nCREATE INDEX idx_quarantine_source ON quarantine(source_table);\n```\n\n## Files\n- apps/scraper/src/sql/client.ts (new)\n- apps/scraper/src/sql/quarantine.ts (new)\n- apps/scraper/src/sql/schema.ts (new)\n- apps/scraper/src/services/db.ts (delete)\n- apps/scraper/src/layers/live.ts (update)\n\n## Verification\n- App starts with new SqlClient\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:06.211541+01:00","updated_at":"2025-12-21T01:43:22.271472+01:00","closed_at":"2025-12-21T01:43:22.271472+01:00","dependencies":[{"issue_id":"cod-pt7.3","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:06.212243+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.3","depends_on_id":"cod-pt7.2","type":"blocks","created_at":"2025-12-21T00:35:34.598542+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.4","title":"Phase 3: Domain Models","description":"Create canonical domain models using Model.Class.\n\n## Tasks\n- Create Camera, Sku, Benchmark as Schema.Class (embedded types)\n- Create Phone as Model.Class with proper field types\n- Create RawPhone as Model.Class for pre-AI data\n- Use Model.JsonFromString for array fields\n- Use Model.BooleanFromNumber for SQLite booleans\n- Add createdAt, updatedAt timestamps\n- Export from @repo/scraper-domain\n\n## Model Pattern\n```typescript\nexport class Camera extends Schema.Class\u003cCamera\u003e('Camera')({\n  resolution_mp: Schema.Number,\n  aperture_fstop: Schema.NullOr(Schema.String),\n  sensor: Schema.NullOr(Schema.String),\n  type: CameraType,\n  features: Schema.Array(Schema.String),\n}) {}\n\nexport class Phone extends Model.Class\u003cPhone\u003e('Phone')({\n  slug: Schema.String,\n  name: Schema.String,\n  cameras: Model.JsonFromString(Schema.Array(Camera)),\n  nfc: Model.BooleanFromNumber,\n  createdAt: Model.DateTimeInsert,\n  updatedAt: Model.DateTimeUpdate,\n}) {}\n```\n\n## Files\n- packages/scraper-domain/src/models/phone.ts (new)\n- packages/scraper-domain/src/models/index.ts (new)\n- packages/scraper-domain/src/index.ts (update exports)\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:16.401696+01:00","updated_at":"2025-12-21T01:49:00.226416+01:00","closed_at":"2025-12-21T01:49:00.226416+01:00","dependencies":[{"issue_id":"cod-pt7.4","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:16.402118+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.4","depends_on_id":"cod-pt7.3","type":"blocks","created_at":"2025-12-21T00:35:34.632569+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.5","title":"Phase 4: Migrate PhoneDataService","description":"Migrate phone data storage to @effect/sql with Model + quarantine.\n\n## Tasks\n- Write integration tests for current PhoneDataService behavior\n- Create PhoneRepo using Model.makeRepository for basic CRUD\n- Keep custom queries hand-written (getSlugsNeedingAi, getSlugsNeedingExtraction)\n- Add Schema.decode with fail-fast + quarantine fallback\n- Update service internals, keep interface stable\n- Delete old implementation\n\n## Error Handling Pattern\n```typescript\nconst getPhone = (slug: string) =\u003e sql\u003cPhoneRow\u003e`\n  SELECT * FROM phone_data WHERE slug = ${slug}\n`.pipe(\n  Effect.flatMap(rows =\u003e rows[0] \n    ? Schema.decode(Phone)(rows[0])\n    : Effect.succeed(null)\n  ),\n  Effect.catchTag('ParseError', (e) =\u003e\n    quarantine(slug, 'phone_data', rows[0], e.message).pipe(\n      Effect.as(null)\n    )\n  )\n);\n```\n\n## Files\n- apps/scraper/src/test/phone-data.test.ts (new)\n- apps/scraper/src/repositories/phone.ts (new)\n- apps/scraper/src/services/phone-data.ts (rewrite internals)\n\n## Verification\n- All phone-data tests pass\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:26.366226+01:00","updated_at":"2025-12-21T02:02:10.029025+01:00","closed_at":"2025-12-21T02:02:10.029025+01:00","dependencies":[{"issue_id":"cod-pt7.5","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:26.367233+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.5","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.664561+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.6","title":"Phase 5: Migrate HtmlCacheService","description":"Migrate HTML cache to @effect/sql.\n\n## Tasks\n- Write integration tests for current HtmlCacheService behavior\n- Rewrite internals to use SqlClient\n- Keep interface stable\n- Add quarantine for corrupted verification records\n\n## Key Methods to Test\n- saveRawHtml(slug, html, source)\n- getRawHtml(slug, source)\n- getRawHtmlWithAge(slug, source)\n- recordVerification(slug, isCorrupted, reason)\n- getVerificationStatus(slug)\n- getCorruptedSlugs()\n- getValidSlugs()\n\n## Files\n- apps/scraper/src/test/html-cache.test.ts (new)\n- apps/scraper/src/services/html-cache.ts (rewrite internals)\n\n## Verification\n- All html-cache tests pass\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-21T00:33:32.625445+01:00","updated_at":"2025-12-21T02:02:10.215932+01:00","closed_at":"2025-12-21T02:02:10.215932+01:00","dependencies":[{"issue_id":"cod-pt7.6","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:32.625901+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.6","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.696791+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.7","title":"Phase 6: Migrate JobQueueService","description":"Migrate job queue to @effect/sql with explicit transactions.\n\n## Tasks\n- Write integration tests for queue behavior (ordering, retry, backoff)\n- Identify multi-step operations needing transactions\n- Rewrite internals to use SqlClient\n- Wrap transactional operations explicitly\n- Keep interface stable\n\n## Transactional Operations\n- claimNextQueueItem (SELECT + UPDATE in one transaction)\n- rescheduleQueueItem (UPDATE attempt + next_attempt_at)\n- enqueueJobSlugs (bulk INSERT)\n\n## Key Methods to Test\n- createJob(input)\n- getJob(id), getAllJobs()\n- enqueueJobSlugs(jobId, jobType, mode, slugs)\n- claimNextQueueItem(jobId) - must be atomic\n- completeQueueItem(id, error?)\n- rescheduleQueueItem(id, nextAttemptAt, error, errorCode)\n- getJobStats(id), getTimeoutStats(id)\n\n## Files\n- apps/scraper/src/test/job-queue.test.ts (new)\n- apps/scraper/src/services/job-queue.ts (rewrite internals)\n\n## Verification\n- All job-queue tests pass\n- Queue ordering/retry semantics unchanged\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:41.731196+01:00","updated_at":"2025-12-21T02:02:10.39989+01:00","closed_at":"2025-12-21T02:02:10.39989+01:00","dependencies":[{"issue_id":"cod-pt7.7","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:41.731666+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.7","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.730495+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.8","title":"Phase 7: Migrate DeviceService","description":"Migrate device storage to @effect/sql.\n\n## Tasks\n- Write integration tests for DeviceService\n- Create Device Model.Class if beneficial (or keep simple)\n- Rewrite internals to use SqlClient\n- Keep interface stable\n\n## Key Methods to Test\n- upsertDevice(device)\n- getDevice(slug)\n- getDeviceCount()\n- getAllDevices()\n- enqueuePrefix(prefix, depth)\n- getNextPendingPrefix()\n- markPrefixDone(prefix, resultCount)\n\n## Files\n- apps/scraper/src/test/device.test.ts (new)\n- apps/scraper/src/services/device.ts (rewrite internals)\n\n## Verification\n- All device tests pass\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:33:55.850655+01:00","updated_at":"2025-12-21T02:02:10.585224+01:00","closed_at":"2025-12-21T02:02:10.585224+01:00","dependencies":[{"issue_id":"cod-pt7.8","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:55.851095+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.8","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.762845+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.9","title":"Phase 8: Data Migration (Pipe to JSON)","description":"Convert pipe-delimited strings to JSON arrays.\n\n## Tasks\n- Create idempotent migration script\n- Add pre-check: count rows needing migration\n- Add post-check: count valid JSON rows\n- Backup DB before running\n- Run migration\n- Verify no data loss\n\n## Migration Logic\n```typescript\nconst needsMigration = (value: string) =\u003e {\n  if (!value) return false;\n  try { JSON.parse(value); return false; }  // Already JSON\n  catch { return value.includes('|'); }      // Pipe-delimited\n};\n\nconst migrate = (value: string) =\u003e \n  JSON.stringify(value.split('|').filter(Boolean));\n```\n\n## Fields to Migrate\n- aliases, images, materials, colors\n- displayFeatures, cpuCores, sim\n- cameraFeatures, others\n\n## Files\n- apps/scraper/src/migrations/001-pipe-to-json.ts (new)\n\n## Verification\n- Pre-check count matches post-check count\n- Random sample of migrated rows parse correctly\n- App reads migrated data without errors","status":"closed","priority":1,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-21T00:34:04.51097+01:00","updated_at":"2025-12-21T02:05:53.846096+01:00","closed_at":"2025-12-21T02:05:53.846096+01:00","dependencies":[{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:04.511464+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.5","type":"blocks","created_at":"2025-12-21T00:35:34.795495+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.6","type":"blocks","created_at":"2025-12-21T00:35:34.827669+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.7","type":"blocks","created_at":"2025-12-21T00:35:34.859748+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.8","type":"blocks","created_at":"2025-12-21T00:35:34.893089+01:00","created_by":"daemon"}]}
{"id":"cod-rll","title":"Phase 2: Create PhoneDataService","description":"Create PhoneDataService to own phone data storage (raw + AI normalized).","design":"1. Create services/phone-data.ts\n2. Move from storage.ts: savePhoneDataRaw, getPhoneDataRaw, hasPhoneDataRaw, getPhoneDataRawCount\n3. Move: savePhoneData, getPhoneData, hasPhoneData, getPhoneDataCount\n4. Move: getPhoneDataRawBulk, getSlugsNeedingExtraction, getSlugsNeedingAi\n5. OpenAI service calls PhoneDataService to save results\n6. Update api.ts routes to use new service","acceptance_criteria":"- [ ] PhoneDataService created\n- [ ] All phone data methods moved\n- [ ] OpenAI/bulk-job uses new service for saving\n- [ ] API routes work correctly\n- [ ] Build passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T19:30:59.796622+01:00","updated_at":"2025-12-20T19:57:00.556503+01:00","closed_at":"2025-12-20T19:57:00.556503+01:00","dependencies":[{"issue_id":"cod-rll","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.863404+01:00","created_by":"daemon"},{"issue_id":"cod-rll","depends_on_id":"cod-8np","type":"blocks","created_at":"2025-12-20T19:35:42.105534+01:00","created_by":"daemon"},{"issue_id":"cod-rll","depends_on_id":"cod-co8","type":"blocks","created_at":"2025-12-20T19:35:42.137539+01:00","created_by":"daemon"},{"issue_id":"cod-rll","depends_on_id":"cod-duf","type":"blocks","created_at":"2025-12-20T19:35:42.1665+01:00","created_by":"daemon"}]}
{"id":"cod-s4i","title":"Phase 2: Scheduler daemon loop","description":"Implement the background scheduler fiber that polls for due schedules and triggers jobs.\n\n## Scheduler Loop\n- Effect.forever fiber started on app boot\n- Polls job_schedules for next_run_at \u003c= now AND enabled = 1\n- Claims schedule with locked_until for crash safety\n- Creates Job via JobQueueService\n- Enqueues work items\n- Starts BulkJobManager.runJob\n- Updates schedule state (last_run_at, last_status, next_run_at)\n\n## Croner Integration\n- Install croner package\n- Use only for computing next_run_at from cron expression\n- No in-memory scheduling\n\n## Crash Recovery\n- On startup, check for schedules with next_run_at in the past\n- Run once (not catch-up all missed)\n- Check if last_job_id is still running before creating new job\n\n## Files\n- apps/scraper/src/services/scheduler.ts (add loop + helpers)\n- apps/scraper/src/index.ts (start loop on boot)\n- package.json (add croner)","acceptance_criteria":"- [ ] Croner installed and used for next-run calculation\n- [ ] Scheduler loop implemented as Effect.forever fiber\n- [ ] Loop started on app boot (after resumeStuckJobs)\n- [ ] Schedule claiming with locked_until works\n- [ ] Job creation + BulkJobManager integration works\n- [ ] Crash recovery handles missed schedules\n- [ ] npm run build passes\n- [ ] npm run check-types passes","notes":"COMPLETED: Phase 2 - Scheduler daemon loop\n\nCHANGES:\n- Installed croner for cron expression parsing\n- Added loop methods: getDueSchedules, claimSchedule, releaseSchedule, markScheduleResult\n- enableSchedule now computes next_run_at (critical fix from oracle review)\n- markScheduleResult uses Effect.try (critical fix from oracle review)\n- runSchedulerLoop uses catchAllCause (critical fix from oracle review)\n- Loop started on boot after resumeStuckJobs\n\nCOMMIT: 4ffa815 (+316 lines)\n\nORACLE REVIEW FIXES APPLIED:\n- Safe cron parsing with Effect.try in markScheduleResult\n- catchAllCause instead of catchAll for defect handling\n- Initialize next_run_at on enable","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T18:02:56.597745+01:00","updated_at":"2025-12-23T18:14:41.974896+01:00","closed_at":"2025-12-23T18:14:41.974896+01:00","dependencies":[{"issue_id":"cod-s4i","depends_on_id":"cod-eip","type":"parent-child","created_at":"2025-12-23T18:03:24.942668+01:00","created_by":"daemon"},{"issue_id":"cod-s4i","depends_on_id":"cod-cvb","type":"blocks","created_at":"2025-12-23T18:03:45.20874+01:00","created_by":"daemon"}]}
{"id":"cod-sdl","title":"Add prices icon to TabBar component","description":"Extend TabBar to support a prices/currency icon variant for the new Prices tab.","design":"Add 'prices' to TabIcon type. Use Russian Ruble symbol (₽) or currency icon. Style with amber/orange color to differentiate from existing cyan/violet tabs.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T03:08:50.931938+01:00","updated_at":"2025-12-22T03:15:52.485338+01:00","closed_at":"2025-12-22T03:15:52.485338+01:00","dependencies":[{"issue_id":"cod-sdl","depends_on_id":"cod-a1z","type":"blocks","created_at":"2025-12-22T03:08:59.740208+01:00","created_by":"daemon"},{"issue_id":"cod-sdl","depends_on_id":"cod-3xb","type":"parent-child","created_at":"2025-12-22T03:09:07.720419+01:00","created_by":"daemon"}]}
{"id":"cod-syq","title":"Fix multi-link architecture for price tracking","description":"Current schema only allows ONE source link per device per source type (UNIQUE device_id,source constraint). User needs: device → many source links → many price quotes per link.\n\nBlockers identified:\n1. device_sources has UNIQUE(device_id, source) - prevents multiple Yandex links\n2. price_quotes has no link identifier (no external_id column)\n3. entity_data_raw has UNIQUE(device_id, source, data_kind)\n4. All price queries are device-level only\n\nMigration needed:\n- Remove UNIQUE(device_id, source) from device_sources\n- Add external_id TEXT column to price_quotes\n- Update PriceService.savePriceQuotes to accept externalId\n- Update yandex.scrape handler to pass externalId","design":"Schema changes:\n1. Rebuild device_sources without UNIQUE(device_id, source)\n2. ALTER TABLE price_quotes ADD COLUMN external_id TEXT\n3. Add index idx_price_quotes_link on (device_id, source, external_id, scraped_at)\n\nService changes:\n1. PriceService.savePriceQuotes: add externalId param, store in price_quotes\n2. PriceService.getPriceHistory: add optional externalId filter\n3. yandex.scrape handler: extract externalId from URL, call linkDeviceToSource, pass to savePriceQuotes\n\nEffort: ~4-6 hours","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T00:54:09.217212+01:00","updated_at":"2025-12-23T01:15:04.181863+01:00","closed_at":"2025-12-23T01:15:04.181863+01:00"}
{"id":"cod-t8h","title":"Refactor JobsSection: Complete Rewrite","description":"Complete refactor of JobsSection.tsx following SolidJS idioms. Current state: 600-line monolith with duplicated logic, bugs (status() not called), and anti-patterns (IIFEs in JSX).","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-22T00:16:57.18393+01:00","updated_at":"2025-12-22T00:27:47.462819+01:00","closed_at":"2025-12-22T00:27:47.462819+01:00"}
{"id":"cod-t8k","title":"Phase 1: Context \u0026 Services Architecture","description":"Create the foundation: selection service and context providers.\n\n## Deliverables\n1. selection.service.ts - modifier key support (shift/ctrl/cmd)\n2. devices-table.context.tsx - 4 contexts (Devices, Selection, RowData, Actions)\n3. Refactor useSlugsApi to use createStore for status maps\n\n## Acceptance Criteria\n- [ ] SelectionService handles click, shift+click, cmd/ctrl+click\n- [ ] Contexts expose focused APIs (not 17+ props)\n- [ ] scrapeStatus, queueStatus, queueLoading use createStore\n- [ ] Build passes (npm run check-types)","design":"\n## Selection Service\n- createStore\u003cRecord\u003cstring, boolean\u003e\u003e for selected state\n- lastIndex signal for shift-select anchor\n- handleRowClick(slug, index, MouseEvent) with modifier detection\n\n## Context Architecture\n- DevicesContext: devices, filtered, total, limit\n- SelectionContext: isSelected, handleRowClick, toggleAll, clearSelection\n- RowDataContext: getStatus(slug), getQueue(slug), getQueueLoading(slug)\n- ActionsContext: queueScrape, clearData, openModal\n\n## useSlugsApi Changes\nReplace createSignal\u003cRecord\u003c...\u003e\u003e with createStore\u003cRecord\u003c...\u003e\u003e for:\n- scrapeStatus\n- queueStatus\n- queueLoading","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T17:15:32.588334+01:00","updated_at":"2025-12-23T17:20:57.844145+01:00","closed_at":"2025-12-23T17:20:57.844145+01:00","dependencies":[{"issue_id":"cod-t8k","depends_on_id":"cod-6i9","type":"blocks","created_at":"2025-12-23T17:16:30.56457+01:00","created_by":"daemon"},{"issue_id":"cod-t8k","depends_on_id":"cod-b06","type":"parent-child","created_at":"2025-12-23T17:16:44.696426+01:00","created_by":"daemon"}]}
{"id":"cod-tve","title":"Fix 1: SSRF Protection + Shared URL Validation","description":"Create shared URL validation helper and use it in both WS handlers.\n\n## Implementation\n1. Create apps/scraper/src/sources/yandex_market/url-utils.ts:\n   - validateYandexUrl(url: string): { externalId: string } | { error: string }\n   - Whitelist: market.yandex.ru, m.market.yandex.ru\n   - Require HTTPS\n   - Extract product ID from pathname\n\n2. Update yandex.scrape handler to use validateYandexUrl\n3. Update yandex.link handler to use validateYandexUrl\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T02:24:11.826905+01:00","updated_at":"2025-12-22T02:27:55.188285+01:00","closed_at":"2025-12-22T02:27:55.188285+01:00","dependencies":[{"issue_id":"cod-tve","depends_on_id":"cod-ulx","type":"parent-child","created_at":"2025-12-22T02:24:45.407891+01:00","created_by":"daemon"}]}
{"id":"cod-u5r","title":"JobsSection presentational atoms","description":"Create small reusable UI components: JobTypeBadge, JobStatusBadge, JobProgressBar, JobWorkersSelect, JobActions, JobTimeoutInfo. Each component uses shared helpers.","design":"Components in apps/ws-web/src/pages/slugs/components/jobs/. Each is pure presentational, takes props, uses helpers from jobViewHelpers.ts.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T00:17:14.468131+01:00","updated_at":"2025-12-22T00:27:47.399727+01:00","closed_at":"2025-12-22T00:27:47.399727+01:00","dependencies":[{"issue_id":"cod-u5r","depends_on_id":"cod-t8h","type":"parent-child","created_at":"2025-12-22T00:17:37.524221+01:00","created_by":"daemon"},{"issue_id":"cod-u5r","depends_on_id":"cod-0z6","type":"blocks","created_at":"2025-12-22T00:17:37.626364+01:00","created_by":"daemon"}]}
{"id":"cod-u6l","title":"Phase 3: Design Polish \u0026 Interactions","description":"Implement the industrial precision design and interactive features.\n\n## Deliverables\n1. Entire row clickable for selection\n2. DataStatusIcons clickable to open specific modal tabs\n3. Inline price summary (lazy-loaded)\n4. Row expansion for price details\n5. Visual refinements per design system\n\n## Acceptance Criteria\n- [ ] Row click triggers selection (not just checkbox)\n- [ ] Clicking HTML/Raw/AI icon opens modal to that tab\n- [ ] Price summary shows inline when available\n- [ ] Expanded row shows price details\n- [ ] Build passes","design":"\n## Row Layout\n┌─────┬─────────────────────────┬────────┬─────────────────┬────────┬──────┬─────┐\n│ ☑  │ Device Name              │ Brand  │ ■ ■ ■ ✓        │ 85K₽   │ •••  │ ⋮   │\n│     │ device-slug              │        │ HTML RAW AI OK  │ 3 offers│      │     │\n└─────┴─────────────────────────┴────────┴─────────────────┴────────┴──────┴─────┘\n\n## Clickable Icons\nDataStatusIcons receive onOpenTab callback\nEach icon triggers openModal(slug, tab) where tab = 'html' | 'raw' | 'ai'\n\n## Price Integration\n- createResource fetches price summary\n- Shows min price inline\n- Expansion shows full price breakdown","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T17:16:06.839431+01:00","updated_at":"2025-12-23T17:37:03.742966+01:00","closed_at":"2025-12-23T17:37:03.742966+01:00","dependencies":[{"issue_id":"cod-u6l","depends_on_id":"cod-nah","type":"blocks","created_at":"2025-12-23T17:16:30.625061+01:00","created_by":"daemon"},{"issue_id":"cod-u6l","depends_on_id":"cod-b06","type":"parent-child","created_at":"2025-12-23T17:16:44.753275+01:00","created_by":"daemon"}]}
{"id":"cod-ulx","title":"Epic: Yandex.Market Follow-up Fixes","description":"Fix issues identified during Oracle reviews of Yandex.Market price scraping feature.\n\n## Issues\n1. SSRF Protection (Critical) - validate URLs before scraping\n2. Shared URL Parsing - DRY up URL validation logic\n3. Availability Parsing - extract isAvailable from HTML\n4. Filter History by Availability - only include available offers\n5. variantLabel Population - extract human-readable variant names","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-22T02:24:01.963094+01:00","updated_at":"2025-12-22T02:39:26.894021+01:00","closed_at":"2025-12-22T02:39:26.894021+01:00"}
{"id":"cod-uzr","title":"Phase 1: Schema extensions for price scraping","description":"Extend database schema to support Yandex.Market price scraping.\n\n## Changes\n1. Add columns to price_quotes via ensureColumn:\n   - seller_id TEXT (Yandex businessId)\n   - variant_key TEXT (normalized SKU like '4/128')\n   - variant_label TEXT (human readable '4 GB / 128 GB')\n   - offer_id TEXT (for deduplication)\n\n2. Add index for efficient queries:\n   - idx_price_quotes_variant on (device_id, variant_key, scraped_at)\n\n## Verification\n- npm run build passes\n- npm run check-types passes\n- Schema auto-migrates on app startup","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:03.569219+01:00","updated_at":"2025-12-22T01:59:40.740925+01:00","closed_at":"2025-12-22T01:59:40.740925+01:00","dependencies":[{"issue_id":"cod-uzr","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.25131+01:00","created_by":"daemon"}]}
{"id":"cod-v72","title":"Fix 3: Parse Availability from Yandex HTML","description":"Extract actual availability status from Yandex.Market HTML instead of hardcoding true.\n\n## Implementation\n1. Analyze /tmp/yandex-brightdata.html for availability patterns\n2. Update apps/scraper/src/sources/yandex_market/extractor.ts:\n   - Look for inStock, isAvailable, stockItemCount, or similar fields\n   - Set isAvailable based on found data\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T02:24:29.013185+01:00","updated_at":"2025-12-22T02:35:11.87267+01:00","closed_at":"2025-12-22T02:35:11.87267+01:00","dependencies":[{"issue_id":"cod-v72","depends_on_id":"cod-ulx","type":"parent-child","created_at":"2025-12-22T02:24:45.472098+01:00","created_by":"daemon"},{"issue_id":"cod-v72","depends_on_id":"cod-2l4","type":"blocks","created_at":"2025-12-22T02:24:45.566358+01:00","created_by":"daemon"}]}
{"id":"cod-vtu","title":"Phase 4: Update AGENTS.md documentation","description":"Update documentation to reflect new scheduler functionality.\n\n## Updates\n- Remove 'No cron/scheduler' limitation note\n- Add Scheduler section describing:\n  - job_schedules table\n  - SchedulerService\n  - Scheduler loop behavior\n  - API endpoints\n  - Crash recovery strategy\n- Add example schedule creation\n- Document cron expression format\n\n## Files\n- AGENTS.md","acceptance_criteria":"- [ ] AGENTS.md updated with scheduler documentation\n- [ ] Limitation note removed\n- [ ] API endpoints documented\n- [ ] Example usage included","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-23T18:03:12.585877+01:00","updated_at":"2025-12-23T18:03:12.585877+01:00","dependencies":[{"issue_id":"cod-vtu","depends_on_id":"cod-eip","type":"parent-child","created_at":"2025-12-23T18:03:24.999624+01:00","created_by":"daemon"},{"issue_id":"cod-vtu","depends_on_id":"cod-cnh","type":"blocks","created_at":"2025-12-23T18:03:45.264293+01:00","created_by":"daemon"}]}
{"id":"cod-x5r","title":"Phase 4: Update LiveLayer and cleanup","description":"Update Effect layer composition with new services, remove deprecated code from storage.ts.","design":"1. Update layers/live.ts to compose all new services\n2. Remove deprecated wrappers from storage.ts\n3. Delete storage.ts if empty, or keep minimal shared DB utilities\n4. Update all imports across codebase\n5. Verify index.ts startup works correctly","acceptance_criteria":"- [ ] LiveLayer composes: HtmlCacheService, JobQueueService, DeviceService, PhoneDataService, KimovilScraper, OpenAIService, BrowserService\n- [ ] No deprecated code in storage.ts\n- [ ] Clean imports everywhere\n- [ ] Server starts and all features work\n- [ ] Build and typecheck pass","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T19:31:14.194922+01:00","updated_at":"2025-12-20T23:40:47.73989+01:00","closed_at":"2025-12-20T23:40:47.73989+01:00","dependencies":[{"issue_id":"cod-x5r","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.925128+01:00","created_by":"daemon"},{"issue_id":"cod-x5r","depends_on_id":"cod-rll","type":"blocks","created_at":"2025-12-20T19:35:42.226064+01:00","created_by":"daemon"},{"issue_id":"cod-x5r","depends_on_id":"cod-3qg","type":"blocks","created_at":"2025-12-20T19:35:42.258114+01:00","created_by":"daemon"}]}
