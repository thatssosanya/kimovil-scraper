{"id":"cod-087","title":"Phase 3: Centralize shared types in domain","description":"Consolidate duplicated phone types (~100 lines moved). Create models/shared.ts with: CpuCoreRoleSchema, CpuCoreCluster, Sku, Benchmark, UsbTypeSchema, FingerprintPositionSchema. Update phone.ts to import from shared. Update scraper-protocol to import shared types from @repo/scraper-domain instead of duplicating.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-25T17:23:48.165075+01:00","updated_at":"2025-12-25T17:45:35.612032+01:00","closed_at":"2025-12-25T17:45:35.612032+01:00","dependencies":[{"issue_id":"cod-087","depends_on_id":"cod-2nf","type":"parent-child","created_at":"2025-12-25T17:24:20.181532+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-087","depends_on_id":"cod-wl0","type":"blocks","created_at":"2025-12-25T17:24:42.097085+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-0qv","title":"Fix review issues: initStealthSession cleanup + SearchError wrapping","description":"Address two issues from Oracle reviews:\n1. initStealthSession lacks cleanup on partial failure - if browser created but page.goto fails, browser leaks\n2. SearchServiceKimovil: browser-level errors not wrapped in SearchError, so they bypass retry logic","acceptance_criteria":"- [ ] initStealthSession uses acquireRelease or cleanup on failure\n- [ ] All errors from withPersistentStealthPage wrapped in SearchError\n- [ ] npm run check-types passes\n- [ ] npm run build passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:50:13.460317+01:00","updated_at":"2025-12-21T17:52:29.074467+01:00","closed_at":"2025-12-21T17:52:29.074467+01:00"}
{"id":"cod-0ua","title":"Widget: Real price data integration (yandex + price_ru)","description":"Integrate real price data from price_quotes table for widget rendering.\n\n## Deliverables\n1. Query to fetch latest prices by source (yandex_market, price_ru)\n2. Group by source with min price and offer count\n3. Use PriceService.getAllQuotes or direct SQL\n4. Handle devices with no prices gracefully\n\n## Data Requirements\n- Per source: minPrice, offerCount, topOffers (up to 3)\n- Sort sources by minPrice ascending\n- Include seller URLs for click-through\n\n## Shop Config\n- yandex_market: 'Яндекс Маркет'\n- price_ru: 'Price.ru'\n\n## Edge Cases\n- Device exists but no prices: show 'Цены не найдены'\n- One source has prices, other doesn't: show only available\n- All prices unavailable: show lowest unavailable with note","notes":"COMPLETED: Created apps/scraper/src/services/widget-data.ts with:\n- WidgetPriceOffer, WidgetSourcePrices, WidgetDeviceData interfaces\n- WidgetDataError tagged error class\n- WidgetDataService with getWidgetData(slug) method\n- SHOP_CONFIG for source display names (yandex_market, price_ru)\n- Single optimized query joining devices with entity_data_raw for specs\n- Price quotes grouped by source with top 3 offers each\n- Returns null if device not found, empty prices array if no prices\n- Build passes (tsc)\n\nNEXT: Add to layer exports when WidgetService is ready","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-08T18:15:53.557395+01:00","updated_at":"2026-01-08T18:20:52.434052+01:00","closed_at":"2026-01-08T18:20:52.434052+01:00","close_reason":"Implemented WidgetDataService with getWidgetData() - fetches device specs + prices grouped by source","dependencies":[{"issue_id":"cod-0ua","depends_on_id":"cod-1qq","type":"parent-child","created_at":"2026-01-08T18:16:38.698612+01:00","created_by":"daemon"}]}
{"id":"cod-0um","title":"Seed default device categories","description":"Seed device_categories table with initial hierarchy: smartphone, tablet, watch, smartwatch, tv, headphones, true_wireless, over_ear, console, laptop, gaming_laptop, hybrid.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T19:39:18.27991+01:00","updated_at":"2026-01-08T19:42:48.458471+01:00","closed_at":"2026-01-08T19:42:48.458471+01:00","close_reason":"Added seedDeviceCategories function with hierarchy","dependencies":[{"issue_id":"cod-0um","depends_on_id":"cod-63k","type":"parent-child","created_at":"2026-01-08T19:39:31.80612+01:00","created_by":"daemon"}]}
{"id":"cod-0z6","title":"JobsSection main components rewrite","description":"Rewrite main container components: JobsSection (header + container), JobsTable (table with For), JobsRow (single row with memos), SelectedJobPanel (detail panel). Uses atoms and helpers.","design":"JobsSection.tsx becomes thin orchestrator. JobsTable.tsx renders table. JobsRow.tsx handles single row with createMemo for status/progress. SelectedJobPanel.tsx for detail view. All use atoms.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T00:17:23.181085+01:00","updated_at":"2025-12-22T00:27:47.431651+01:00","closed_at":"2025-12-22T00:27:47.431651+01:00","dependencies":[{"issue_id":"cod-0z6","depends_on_id":"cod-t8h","type":"parent-child","created_at":"2025-12-22T00:17:37.558664+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-1k3","title":"Add price status indicator to DataStatusIcons","description":"Add a price status indicator to DataStatusIcons showing:\n- Count of price-related device_sources (yandex_market, price_ru, etc.)\n- Whether device has scraped prices\n\n## Design\n- Amber/orange ₽ icon in StatusBadge\n- Show count badge (e.g., '₽ 3' for 3 linked sources)\n- Filled if has prices, outline if only linked, hidden if neither\n- Click opens Prices tab in modal\n\n## Backend Changes (api-v2.ts)\nAdd to status response:\n- priceSourceCount: number - COUNT(*) FROM device_sources WHERE device_id = ? AND source IN ('yandex_market', 'price_ru')\n- hasPrices: boolean - EXISTS in price_quotes for this device\n\n## Frontend Changes\n1. Update ScrapeStatus type in types.ts with priceSourceCount and hasPrices\n2. Add amber StatusBadge to DataStatusIcons.tsx with ₽ icon and count\n\n## Future-proof\nUse source list that can be extended when adding new price sources like price_ru.","design":"Add ₽ icon in amber/orange color. Show filled if has prices, outline if only linked, hidden if neither.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T03:08:51.317751+01:00","updated_at":"2025-12-25T18:43:42.95084+01:00","closed_at":"2025-12-25T18:43:42.95084+01:00","dependencies":[{"issue_id":"cod-1k3","depends_on_id":"cod-3xb","type":"parent-child","created_at":"2025-12-22T03:09:07.77855+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-1ni","title":"Phase 4: Drop legacy kimovil_devices table","description":"After migration is verified, drop the legacy kimovil_devices table to eliminate data duplication.\n\nSteps:\n1. Add verification query to check all kimovil_devices exist in devices table\n2. Remove kimovil_devices table creation from schema.ts\n3. Remove KimovilDevice interface and related types from the codebase\n4. Add migration to drop kimovil_devices table (or just remove CREATE and let it be orphaned)\n\nVerification before drop:\nSELECT COUNT(*) FROM kimovil_devices kd \nWHERE NOT EXISTS (SELECT 1 FROM devices d WHERE d.slug = kd.slug);\n-- Must return 0\n\n~30 lines changed.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T18:00:50.166841+01:00","updated_at":"2025-12-26T00:38:19.407806+01:00","closed_at":"2025-12-26T00:38:19.407806+01:00","dependencies":[{"issue_id":"cod-1ni","depends_on_id":"cod-qda","type":"parent-child","created_at":"2025-12-25T18:00:57.325181+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-1ni","depends_on_id":"cod-4p1","type":"blocks","created_at":"2025-12-25T18:00:57.430167+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-1o8","title":"Phase 1: Create shared generateDeviceId utility","description":"Create shared ID generation utility in scraper-domain. Replace duplicate implementations in device.ts (hashSlug), device-registry.ts (generateDeviceId), schema.ts (generateDeviceId), and slug-crawler.ts (inline createHash).\n\nFiles to change:\n- packages/scraper-domain/src/utils/device-id.ts (new file)\n- apps/scraper/src/services/device.ts\n- apps/scraper/src/services/device-registry.ts  \n- apps/scraper/src/sql/schema.ts\n- apps/scraper/src/services/slug-crawler.ts\n\n~25 lines added/changed.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T17:57:48.380854+01:00","updated_at":"2025-12-25T18:11:00.691711+01:00","closed_at":"2025-12-25T18:11:00.691711+01:00","dependencies":[{"issue_id":"cod-1o8","depends_on_id":"cod-qda","type":"parent-child","created_at":"2025-12-25T17:58:19.723242+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-1qq","title":"Epic: High-Performance Widget API","description":"Create a production-ready HTML widget API endpoint that serves pre-rendered price comparison widgets. Target: 500k req/day, sub-10ms response time, high availability.\n\n## Requirements\n- Server-rendered HTML with same styling as PalachPriceWidget\n- Real price.ru + yandex_market price integration\n- Multi-layer caching (in-memory LRU + SQLite + HTTP headers)\n- Manual cache invalidation (per-slug + global)\n- ws-web integration via fetch + innerHTML\n- Tailwind safelist for widget classes\n- Comprehensive tests\n\n## Key Decisions\n- Injected HTML approach (not iframe) for Tailwind compatibility\n- Query params: slug, arrowVariant, theme\n- Cache invalidation via POST endpoints","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-01-08T18:15:13.205478+01:00","updated_at":"2026-01-08T18:44:35.694375+01:00","closed_at":"2026-01-08T18:44:35.694375+01:00","close_reason":"All subtasks completed - widget API fully implemented"}
{"id":"cod-1vu","title":"Effect.Stream for WebSocket progress events","description":"Replace AsyncGenerator with Effect.Stream for better backpressure handling in WebSocket progress events.\n\n## Tasks\n- Convert scrape progress events to Stream.Stream\n- Update WebSocket handler to consume stream\n- Add cancellation via Fiber interruption\n\n## Benefits\n- Backpressure handling\n- Cancellation via Fiber interruption\n- Composable with other streams\n- Error typing\n\n## Files\n- apps/scraper/src/services/scrape-kimovil.ts\n- apps/scraper/src/routes/ws.ts\n\n## Note\nOptional enhancement - low priority.","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-25T18:30:55.816695+01:00","updated_at":"2025-12-25T18:30:55.816695+01:00"}
{"id":"cod-21o","title":"Frontend: Migrate to v2 API","description":"Update frontend to use new /api/v2/* endpoints.\n\n## Deliverables\n1. Update useSlugsApi.ts to use v2 endpoints\n2. Update clearBulk/clearRawBulk/clearAiBulk to call POST /api/v2/jobs\n3. Update status fetching to use bulk-status endpoint\n4. Keep backward compatibility during transition\n\n## Files to Modify\n- apps/ws-web/src/pages/slugs/hooks/useSlugsApi.ts\n- apps/ws-web/src/pages/slugs/hooks/useBulkJobs.ts (if needed)\n\n## Verification\n- npm run build passes (in ws-web)\n- Manual test: Clear button actually deletes HTML\n- Manual test: Bulk status still works","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-25T01:27:28.51896+01:00","updated_at":"2025-12-25T01:46:57.069757+01:00","closed_at":"2025-12-25T01:46:57.069757+01:00","dependencies":[{"issue_id":"cod-21o","depends_on_id":"cod-jw1","type":"parent-child","created_at":"2025-12-25T01:27:42.202741+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-26h","title":"Phase 2: Backfill Devices","description":"Populate devices and device_sources from existing kimovil_devices table.\n\n## Migration steps:\n1. Generate device IDs (16-char sha256 of slug)\n2. INSERT INTO devices from kimovil_devices\n3. INSERT INTO device_sources with source='kimovil', external_id=slug\n\n## Files:\n- apps/scraper/src/sql/schema.ts (add migration function)\n\nEstimated: 0.5 days","acceptance_criteria":"- [ ] All kimovil_devices migrated to devices\n- [ ] device_sources populated with source='kimovil'\n- [ ] Migration is idempotent (can run multiple times)\n- [ ] Existing functionality unchanged","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:17.482994+01:00","updated_at":"2025-12-21T04:49:47.035999+01:00","closed_at":"2025-12-21T04:49:47.035999+01:00","dependencies":[{"issue_id":"cod-26h","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.335025+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-26h","depends_on_id":"cod-b4n","type":"blocks","created_at":"2025-12-21T04:41:19.017632+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-2i2","title":"Phase 2: Implement stealth browser init and withPersistentStealthPage","description":"Create initStealthSession helper that launches chromium with stealth flags, patches webdriver, navigates to kimovil.com. Implement withPersistentStealthPage that lazily inits session, acquires semaphore, runs user effect with page, handles errors.","acceptance_criteria":"- [ ] Stealth browser launches with --disable-blink-features=AutomationControlled\n- [ ] navigator.webdriver patched via addInitScript\n- [ ] Session pre-warms by visiting kimovil.com/en/\n- [ ] withPersistentStealthPage serializes access via Semaphore\n- [ ] Lazy init on first call, reuses on subsequent\n- [ ] npm run check-types passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:38:46.282708+01:00","updated_at":"2025-12-21T17:46:31.993012+01:00","closed_at":"2025-12-21T17:46:31.993012+01:00","dependencies":[{"issue_id":"cod-2i2","depends_on_id":"cod-3a9","type":"parent-child","created_at":"2025-12-21T17:39:10.482994+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-2i2","depends_on_id":"cod-8wi","type":"blocks","created_at":"2025-12-21T17:39:23.068878+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-2l4","title":"Fix 2: Filter Price History by Availability","description":"Add is_available = 1 filter to getPriceHistory query.\n\n## Implementation\nUpdate apps/scraper/src/services/price.ts getPriceHistory method:\n- Add AND is_available = 1 to both query branches (with/without variantKey)\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T02:24:20.391424+01:00","updated_at":"2025-12-22T02:29:57.986054+01:00","closed_at":"2025-12-22T02:29:57.986054+01:00","dependencies":[{"issue_id":"cod-2l4","depends_on_id":"cod-ulx","type":"parent-child","created_at":"2025-12-22T02:24:45.439657+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-2l4","depends_on_id":"cod-tve","type":"blocks","created_at":"2025-12-22T02:24:45.535652+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-2nf","title":"Epic: Domain \u0026 Protocol Package Cleanup","description":"Bring scraper-domain and scraper-protocol packages up to date with multi-source architecture. Remove dead code, consolidate duplicated types, centralize shared enums.","design":"5 phases: (1) Remove dead domain code, (2) Remove dead protocol code, (3) Centralize shared types in domain, (4) Add missing types, (5) Update app imports. Dependency direction: domain → protocol → app.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-25T17:23:19.405057+01:00","updated_at":"2025-12-25T17:55:18.322328+01:00","closed_at":"2025-12-25T17:55:18.322328+01:00"}
{"id":"cod-2ov","title":"Phase 1: Remove dead code from scraper-domain","description":"Remove unused models and helpers from scraper-domain package (~100 lines). Delete: JsonFromString, BooleanFromNumber, NullableBooleanFromNumber, DateFromTimestamp helpers; RawPhoneRow, PhoneRow classes; Device, DeviceSourceLink, Scrape classes and their Data type aliases. Keep: DataKind, SourceStatus, ScrapeStatus type unions.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-25T17:23:29.223527+01:00","updated_at":"2025-12-25T17:31:21.185913+01:00","closed_at":"2025-12-25T17:31:21.185913+01:00","dependencies":[{"issue_id":"cod-2ov","depends_on_id":"cod-2nf","type":"parent-child","created_at":"2025-12-25T17:24:19.944158+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-2qg","title":"Remove pipe-delimited strings, use JSON arrays everywhere","description":"Currently the codebase has inconsistent data formats:\n- Extractors return pipe-delimited strings (e.g., 'Glass|Aluminium')\n- Migration 001 converted some to JSON arrays in DB\n- Schema still expects Schema.String for these fields\n- Result: double-encoded JSON strings like '[\"Glass\",\"Aluminium\"]'\n- Nested values like skus[].marketId still pipe-delimited\n\n## Fields to migrate\n- aliases, images, materials, colors, displayFeatures, cpuCores, sim, cameraFeatures, others (top-level)\n- skus[].marketId (nested - should become string[])\n- cameras[].features (nested - should become string[])\n\n## Changes needed\n1. Update extractors to return arrays instead of .join('|')\n2. Update RawPhone/Phone schemas to use Schema.Array(Schema.String)\n3. Remove toDelimited/toPipeString helpers in scrape-kimovil.ts\n4. Update openai.ts to work with arrays\n5. Write migration to fix existing double-encoded data\n6. Update any UI code that splits on '|'","design":"Approach:\n1. Schema first: Update phone.ts to use arrays\n2. Extractors: Return arrays directly\n3. AI service: Remove pipe-string conversions\n4. Migration: Fix corrupted data in DB\n5. Test with fresh scrape + existing data","notes":"COMPLETED: Full migration to JSON arrays\n\nCHANGES:\n- Schema: All list fields now Schema.Array(Schema.String)\n- Sku: marketId → marketIds (array)\n- Camera: features now array\n- Extractors: Return arrays directly\n- Removed toDelimited/toPipeString helpers\n- Migration 002: Fixed 6462 rows in phone_data_raw, 57 in phone_data\n\nVERIFIED:\n- npm run check-types passes\n- Migration successful\n- samsung-galaxy-s24 now has proper arrays","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T21:11:32.708259+01:00","updated_at":"2025-12-21T21:20:56.952306+01:00","closed_at":"2025-12-21T21:20:56.952309+01:00"}
{"id":"cod-3a9","title":"Fix Kimovil search 403 by adding persistent stealth browser to BrowserService","description":"Cloudflare now blocks all direct HTTP requests to Kimovil API. Solution: extend BrowserService with persistent stealth browser that bypasses detection using --disable-blink-features=AutomationControlled + webdriver patch. Reuse browser session between searches to avoid repeated page loads.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-21T17:38:26.39231+01:00","updated_at":"2025-12-21T17:49:24.73252+01:00","closed_at":"2025-12-21T17:49:24.73252+01:00"}
{"id":"cod-3aw","title":"WordPress widget cache system","description":"Implement caching system for WordPress widget data to enable efficient mapping of widget models to device slugs.\n\n## Context\n- WordPress posts contain Yandex Market widgets with searchText parameter\n- 1274 posts in last 3 months, 1109 unique widget models, 1954 total usages\n- Currently hardcoded WIDGET_DATA array - need live data with caching\n\n## Requirements\n1. Cache WordPress post content + extracted widget models in SQLite\n2. Incremental sync using post modified_after parameter\n3. Period selection (1m, 3m, 6m, all) for debug UI\n4. Content hash for change detection\n5. Keep raw content for re-extraction if regex changes","notes":"COMPLETED: WordPress widget cache system\n- Schema: sync_state, wp_posts_cache, wordpress_widget_cache tables with indexes\n- WordPressSyncService: incremental sync with content hash change detection\n- Updated widget-debug API: period filter (1m/3m/6m/all), sync-status, refresh triggers sync\n\nDISCOVERED: cod-dq8 - deleted/trashed posts not handled (deferred)\n\nOracle review passed - no critical issues, minor improvements noted","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-08T19:43:27.510532+01:00","updated_at":"2026-01-08T19:51:31.420564+01:00","closed_at":"2026-01-08T19:51:31.420567+01:00"}
{"id":"cod-3hz","title":"Phase 5: Migrate Kimovil Pipeline","description":"Migrate existing Kimovil phone scraping to new entity_data pattern.\n\n## Changes:\n1. Register Kimovil specs pipeline in registry\n2. Refactor ScrapeKimovilService to:\n   - Create scrape records via ScrapeRecordService\n   - Save to entity_data_raw instead of phone_data_raw\n   - Save to entity_data instead of phone_data\n3. Keep PhoneDataService as facade for API backward compatibility\n   - Reads from entity_data_raw/entity_data WHERE source='kimovil' AND data_kind='specs'\n   - Converts to existing RawPhone/Phone types\n\n## Files:\n- apps/scraper/src/services/scrape-kimovil.ts\n- apps/scraper/src/services/phone-data.ts (update as facade)\n- apps/scraper/src/sources/kimovil/specs.ts (new pipeline impl)\n\nEstimated: 3-5 days","acceptance_criteria":"- [ ] Kimovil pipeline registered\n- [ ] New scrapes use entity_data tables\n- [ ] PhoneDataService facade works unchanged\n- [ ] Existing API endpoints work\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:52.081627+01:00","updated_at":"2025-12-21T05:04:25.904919+01:00","closed_at":"2025-12-21T05:04:25.904919+01:00","dependencies":[{"issue_id":"cod-3hz","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.432995+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-3hz","depends_on_id":"cod-7ue","type":"blocks","created_at":"2025-12-21T04:41:19.11074+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-3qg","title":"Phase 3: Refactor KimovilScraper","description":"Rename scrape-kimovil.ts to kimovil.ts, refactor to use HtmlCacheService directly.","design":"1. Split scrape-kimovil.ts into three files:\n   - kimovil.ts (~300 lines): ScrapeService impl, fetch, cache orchestration\n   - kimovil-extractors.ts (~600 lines): extractPhoneData, getCameras, getSpecs, getSKUs\n   - kimovil-validators.ts (~100 lines): isBotProtectionPage, getHtmlValidationError\n2. kimovil.ts injects HtmlCacheService dependency\n3. Remove direct storage.ts imports for HTML ops\n4. Export extractors/validators for reuse and testing\n5. Prepare interface pattern for future scrapers (GSMArena, etc.)\n6. Update exports and imports across codebase","acceptance_criteria":"- [ ] scrape-kimovil.ts split into kimovil.ts, kimovil-extractors.ts, kimovil-validators.ts\n- [ ] kimovil.ts uses HtmlCacheService for caching\n- [ ] Extractors are pure functions, easily testable\n- [ ] Validators exported for reuse by other scrapers\n- [ ] Clean separation of Kimovil-specific logic\n- [ ] Build passes","notes":"Completed: validators + extractors extracted. scrape-kimovil.ts reduced from 1101 to 595 lines.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T19:31:06.531582+01:00","updated_at":"2025-12-20T19:57:00.587077+01:00","closed_at":"2025-12-20T19:57:00.587077+01:00","dependencies":[{"issue_id":"cod-3qg","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.893932+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-3qg","depends_on_id":"cod-8np","type":"blocks","created_at":"2025-12-20T19:35:42.195617+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-3xb","title":"Integrate Yandex.Market prices into PhoneDataModal","description":"Add a Prices tab to the existing PhoneDataModal component to allow linking devices to Yandex.Market URLs, scraping prices, and viewing current prices with history. This integrates the backend yandex.scrape and yandex.link WebSocket handlers plus REST endpoints for price data.","design":"Add Prices tab with 3 states: (1) No link - show URL input, (2) Linked no prices - show scrape button, (3) Has prices - show offers list with refresh. Use amber/orange color theme to differentiate from existing tabs.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-22T03:08:27.756029+01:00","updated_at":"2026-01-08T18:02:20.271195+01:00","closed_at":"2026-01-08T18:02:20.271195+01:00","close_reason":"All 5 tasks complete: Prices tab added to PhoneDataModal with types, API methods, icon, and status indicator","dependencies":[{"issue_id":"cod-3xb","depends_on_id":"cod-syq","type":"blocks","created_at":"2025-12-23T00:55:00.381585+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-4p1","title":"Phase 3: Rename DeviceService to KimovilPrefixService","description":"Slim down DeviceService to prefix queue only and rename for clarity.\n\nRemove from DeviceService:\n- upsertDevice, getDevice, getAllDevices, getDeviceCount\n- KimovilDevice interface and related types\n\nKeep (rename to KimovilPrefixService):\n- enqueuePrefix, getNextPendingPrefix, markPrefixDone\n- getPendingPrefixCount, seedInitialPrefixes, resetAllPrefixes\n- KimovilPrefixState interface\n\nUpdate:\n- Rename file: device.ts → kimovil-prefix.ts\n- Rename service: DeviceService → KimovilPrefixService\n- Rename error: DeviceError → KimovilPrefixError\n- Update all imports in: slug-crawler.ts, layers/live.ts, debug.ts\n\n~90 lines changed.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T17:58:11.335833+01:00","updated_at":"2025-12-26T00:38:19.408771+01:00","closed_at":"2025-12-26T00:38:19.408771+01:00","dependencies":[{"issue_id":"cod-4p1","depends_on_id":"cod-qda","type":"parent-child","created_at":"2025-12-25T17:58:19.919718+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-4p1","depends_on_id":"cod-lxv","type":"blocks","created_at":"2025-12-25T17:58:26.546746+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-4wd","title":"Schema: Add missing columns to widget_model_mappings","description":"Add columns: usage_count INTEGER, first_seen_at INTEGER, last_seen_at INTEGER. Update status enum to ('pending', 'suggested', 'auto_confirmed', 'confirmed', 'ignored'). Add ensureColumn calls for migration.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-08T20:08:07.457182+01:00","updated_at":"2026-01-08T20:15:28.991211+01:00","closed_at":"2026-01-08T20:15:28.991211+01:00","close_reason":"Added usage_count, first_seen_at, last_seen_at columns. Updated status enum with constraint migration.","dependencies":[{"issue_id":"cod-4wd","depends_on_id":"cod-g7x","type":"parent-child","created_at":"2026-01-08T20:09:08.045012+01:00","created_by":"daemon"}]}
{"id":"cod-52w","title":"Widget debug API with cached data","description":"Update widget-debug routes to use cached data instead of hardcoded WIDGET_DATA","design":"Endpoints:\n1. GET /api/widget-debug/models?period=3m - aggregated model stats from cache\n2. GET /api/widget-debug/sync-status - last sync info\n3. POST /api/widget-debug/sync - trigger incremental sync\n\nSQL for summary:\nSELECT search_text, COUNT(*) AS total_usages, COUNT(DISTINCT post_id) AS posts_count,\nMIN(post_date_gmt) AS first_seen, MAX(post_date_gmt) AS last_seen\nFROM wordpress_widget_cache\nWHERE post_date_gmt \u003e= :from_date\nGROUP BY search_text\nORDER BY total_usages DESC","acceptance_criteria":"- [ ] Period filter works (1m, 3m, 6m, all)\n- [ ] Sync status endpoint shows last sync time\n- [ ] Manual sync trigger works\n- [ ] Replace hardcoded WIDGET_DATA with DB query","notes":"COMPLETED: Updated widget-debug routes - period filter, sync-status endpoint, refresh triggers sync, removed hardcoded data","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T19:43:58.152789+01:00","updated_at":"2026-01-08T19:49:58.296076+01:00","closed_at":"2026-01-08T19:49:58.296078+01:00","dependencies":[{"issue_id":"cod-52w","depends_on_id":"cod-3aw","type":"parent-child","created_at":"2026-01-08T19:44:11.279594+01:00","created_by":"daemon"},{"issue_id":"cod-52w","depends_on_id":"cod-reb","type":"blocks","created_at":"2026-01-08T19:44:32.082346+01:00","created_by":"daemon"}]}
{"id":"cod-568","title":"Add price-related types to types.ts","description":"Add TypeScript types for price data structures needed by the frontend.","design":"Add PriceOffer (seller, price, variant, availability), PriceSummary (min/max/count), PriceHistoryEntry (date, stats). Extend ScrapeStatus or create separate DevicePriceStatus.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T03:08:50.535056+01:00","updated_at":"2025-12-22T03:11:35.250985+01:00","closed_at":"2025-12-22T03:11:35.250985+01:00","dependencies":[{"issue_id":"cod-568","depends_on_id":"cod-nzz","type":"blocks","created_at":"2025-12-22T03:08:59.648592+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-568","depends_on_id":"cod-a1z","type":"blocks","created_at":"2025-12-22T03:08:59.679333+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-568","depends_on_id":"cod-3xb","type":"parent-child","created_at":"2025-12-22T03:09:07.662454+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-56x","title":"Update WidgetDebug UI for cached data","description":"Update ws-web WidgetDebug page to work with new cached WordPress data and add sync controls.\n\n## Changes needed:\n1. Period selector (1m, 3m, 6m, all)\n2. Sync status display (last sync time, post/widget counts)\n3. Sync trigger button\n4. Update data model for firstSeen/lastSeen fields\n5. Better loading/error states during sync","notes":"COMPLETED: Updated WidgetDebug UI with:\n- Period selector (1m/3m/6m/all)\n- Sync status card showing last sync time and counts\n- Sync button with loading state\n- firstSeen/lastSeen fields in model and detail modal","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-08T19:54:25.115322+01:00","updated_at":"2026-01-08T19:56:46.306849+01:00","closed_at":"2026-01-08T19:56:46.306854+01:00"}
{"id":"cod-63k","title":"Device categories and widget mappings schema","description":"Implement multi-category device support and widget model mappings table for the price widget system. Needed to replace WordPress Yandex Market widgets with our own.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-08T19:38:50.592157+01:00","updated_at":"2026-01-08T19:44:41.907145+01:00","closed_at":"2026-01-08T19:44:41.907145+01:00","close_reason":"Schema complete: device_categories, device_category_links, widget_model_mappings tables added with Oracle-reviewed indexes"}
{"id":"cod-6dt","title":"Phase 5: Update app imports to use domain types","description":"Update apps/scraper to import centralized types (~40 lines). Update: pipeline/registry.ts to import DataKind from domain; job-queue.ts to import JobType, JobStatus, AiMode, ScrapeStatus from domain; kimovil/extractors.ts to import shared types from domain.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-25T17:24:04.160015+01:00","updated_at":"2025-12-25T17:55:18.063115+01:00","closed_at":"2025-12-25T17:55:18.063115+01:00","dependencies":[{"issue_id":"cod-6dt","depends_on_id":"cod-2nf","type":"parent-child","created_at":"2025-12-25T17:24:20.461055+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-6dt","depends_on_id":"cod-vaq","type":"blocks","created_at":"2025-12-25T17:24:42.297302+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-6i9","title":"Phase 2: Component Refactor","description":"Refactor components to use contexts instead of props.\n\n## Deliverables\n1. DeviceRow.tsx - self-contained row with context consumption\n2. RowActionsMenu.tsx - overflow menu for destructive actions\n3. DevicesTable.tsx refactored (no props, uses contexts)\n4. SelectionBar.tsx refactored (uses SelectionContext)\n\n## Acceptance Criteria\n- [ ] DeviceRow subscribes only to its slug's data\n- [ ] Destructive actions behind overflow menu\n- [ ] No prop drilling in DevicesTable\n- [ ] SelectionBar reads from context\n- [ ] Build passes","design":"\n## DeviceRow Pattern\n- Key by slug\n- Uses useRowDataContext().getStatus(slug) for granular updates\n- Owns expanded state for price loading\n- createResource for lazy price fetch\n\n## RowActionsMenu\n- Trigger: ⋮ button\n- Contains: Clear All, Clear Raw, Clear AI (destructive)\n- Primary actions stay inline: Scrape, View\n\n## Component Hierarchy\nDevicesTableProvider\n├── DevicesTable (layout, header)\n│   └── For each → DeviceRow\n└── SelectionBar (floating)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T17:15:48.675737+01:00","updated_at":"2025-12-23T17:30:05.42846+01:00","closed_at":"2025-12-23T17:30:05.42846+01:00","dependencies":[{"issue_id":"cod-6i9","depends_on_id":"cod-u6l","type":"blocks","created_at":"2025-12-23T17:16:30.593649+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-6i9","depends_on_id":"cod-b06","type":"parent-child","created_at":"2025-12-23T17:16:44.725327+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-6p1","title":"Refactor: Split api.ts into route modules","description":"api.ts is 813 lines - split into separate route modules (jobs, devices, schedules, etc.) for maintainability","status":"open","priority":2,"issue_type":"chore","created_at":"2025-12-26T00:36:40.198408+01:00","updated_at":"2025-12-26T00:36:40.198408+01:00"}
{"id":"cod-7gy","title":"Widget: ws-web integration with Tailwind safelist","description":"Update ws-web to fetch and display widget HTML from the new endpoint.\n\n## Deliverables\n1. Update apps/ws-web/src/pages/widgets/Widgets.tsx\n2. Fetch HTML from /widget/v1/price/:slug\n3. Inject via innerHTML into container div\n4. Add config panel to change slug/arrowVariant (keep existing)\n5. Update Tailwind config with safelist for widget classes\n\n## Tailwind Safelist\nExtract all unique classes from PalachPriceWidget.tsx:\n- Layout: flex, items-center, justify-center, gap-*, p-*, m-*, etc.\n- Colors: bg-white, text-neutral-*, bg-neutral-*, etc.\n- Typography: text-[*], font-*, tracking-*, leading-*\n- Effects: rounded-*, shadow-*, transition-*, hover:*\n\n## Widget Container\n- Container div with id='widget-container'\n- Loading state while fetching\n- Error state on fetch failure\n- Refetch on config change","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-08T18:16:16.308086+01:00","updated_at":"2026-01-08T18:42:35.808509+01:00","closed_at":"2026-01-08T18:42:35.808509+01:00","close_reason":"Integrated ws-web with widget API, added Tailwind safelist","dependencies":[{"issue_id":"cod-7gy","depends_on_id":"cod-1qq","type":"parent-child","created_at":"2026-01-08T18:16:38.925942+01:00","created_by":"daemon"},{"issue_id":"cod-7gy","depends_on_id":"cod-ecc","type":"blocks","created_at":"2026-01-08T18:16:49.519134+01:00","created_by":"daemon"}]}
{"id":"cod-7ue","title":"Phase 6: Cleanup \u0026 Documentation","description":"Remove legacy code paths and update documentation.\n\n## Cleanup:\n- Remove direct phone_data_raw/phone_data writes (keep tables for now)\n- Remove legacy slug-based lookups where device_id should be used\n- Consolidate duplicate code between services\n\n## Documentation:\n- Update AGENTS.md with new architecture\n- Document pipeline registration pattern\n- Add example for new source implementation\n\n## Files:\n- AGENTS.md\n- README.md\n- apps/scraper/src/services/* (cleanup)\n\nEstimated: 2-3 days","acceptance_criteria":"- [ ] Legacy code paths removed\n- [ ] Documentation updated\n- [ ] AGENTS.md reflects new architecture\n- [ ] npm run build passes\n- [ ] npm run check-types passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T04:41:00.226038+01:00","updated_at":"2025-12-21T05:10:28.956992+01:00","closed_at":"2025-12-21T05:10:28.956992+01:00","dependencies":[{"issue_id":"cod-7ue","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.468979+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-7y3","title":"Refactor search errors to Effect-idiomatic tagged errors","description":"Replace nested SearchError with structured tagged errors using Data.TaggedError pattern.\n\nCurrent problem:\n- Errors nested multiple times with string messages\n- No structured data (status code, URL, attempt buried in strings)\n- Hard to debug and filter logs\n\nSolution:\n- KimovilHttpError: url, status, statusText, attempt\n- KimovilInvalidResponseError: url, attempt, raw\n- SearchRetryExhaustedError: query, attempts, lastError\n- Map errors once at leaf, don't re-wrap\n- Use log annotations for debugging","acceptance_criteria":"- [ ] New error types using Data.TaggedError\n- [ ] Errors have structured fields (url, status, attempt, etc.)\n- [ ] Single mapError at leaf level\n- [ ] SearchRetryExhaustedError wraps final failure\n- [ ] No nested error wrapping\n- [ ] npm run check-types passes\n- [ ] npm run build passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:59:22.945237+01:00","updated_at":"2025-12-21T18:03:45.204748+01:00","closed_at":"2025-12-21T18:03:45.204748+01:00"}
{"id":"cod-82b","title":"UI: Mapping editor modal","description":"Replace current detail modal with mapping editor. Show: suggested matches with confidence badges, device search input with results, Confirm \u0026 Lock button (sets confirmed), Ignore button (sets ignored). Auto-advance to next item after action.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T20:08:53.50493+01:00","updated_at":"2026-01-08T20:38:25.744446+01:00","closed_at":"2026-01-08T20:38:25.744446+01:00","close_reason":"Mapping editor modal with: suggested matches, device search, Confirm \u0026 Lock, Ignore, auto-advance to next item","dependencies":[{"issue_id":"cod-82b","depends_on_id":"cod-g7x","type":"parent-child","created_at":"2026-01-08T20:09:08.513734+01:00","created_by":"daemon"},{"issue_id":"cod-82b","depends_on_id":"cod-jsz","type":"blocks","created_at":"2026-01-08T20:09:31.195296+01:00","created_by":"daemon"}]}
{"id":"cod-852","title":"Backend: Implement v2 API routes","description":"Add new /api/v2/* routes to scraper backend.\n\n## Deliverables\n1. New route file: src/routes/api-v2.ts\n2. Device data endpoints (GET/DELETE for html, raw-data, data)\n3. Bulk status endpoint\n4. New job types: clear_html, clear_raw, clear_processed\n5. Update JobQueueService with actual delete operations\n6. Keep legacy routes working (don't break frontend during migration)\n\n## Files to Modify\n- apps/scraper/src/routes/api-v2.ts (new)\n- apps/scraper/src/routes/index.ts (mount v2)\n- apps/scraper/src/services/job-queue.ts (add delete methods)\n- apps/scraper/src/services/bulk-job.ts (handle new job types)\n- apps/scraper/src/services/html-cache.ts (add delete method)\n- apps/scraper/src/services/phone-data.ts (add delete methods)\n\n## Verification\n- npm run build passes\n- npm run check-types passes\n- Manual test: DELETE /api/v2/devices/test-slug/sources/kimovil/html actually deletes from raw_html","notes":"COMPLETED: v2 API routes implemented (a9dd84e, +321/-8)\nISSUES FOUND by oracle review:\n1. deleteRawHtml 'deleted' flag only reflects last DELETE (scrape_verification), not raw_html\n2. Falsy checks (!result) can fail for valid JSON values like 0, false, ''\n3. DELETE returns 200 even when device not found (inconsistent with GET 404)\n4. bulk-status doesn't catch errors for all service calls consistently\nIN PROGRESS: Fixing critical issues before moving to frontend","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-25T01:27:19.444381+01:00","updated_at":"2025-12-25T01:39:32.595187+01:00","closed_at":"2025-12-25T01:39:32.595187+01:00","dependencies":[{"issue_id":"cod-852","depends_on_id":"cod-jw1","type":"parent-child","created_at":"2025-12-25T01:27:42.113476+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-852","depends_on_id":"cod-21o","type":"blocks","created_at":"2025-12-25T01:27:42.298879+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-8np","title":"Phase 1: Extract HtmlCacheService","description":"Extract HTML caching logic from storage.ts into dedicated HtmlCacheService. Add 'source' column for multi-source support.","design":"1. Create services/html-cache.ts with Effect service pattern\n2. Move: saveRawHtml, getRawHtml, getRawHtmlIfFresh, getRawHtmlWithAge\n3. Move: recordVerification, verifyHtml, getVerificationStatus, getCorruptedSlugs, getValidSlugs\n4. Add 'source' column to raw_html table (default: 'kimovil')\n5. Update scrape-kimovil.ts to use new service\n6. Keep old methods in storage.ts as deprecated wrappers initially","acceptance_criteria":"- [ ] HtmlCacheService created with Effect Context pattern\n- [ ] All HTML cache methods moved and working\n- [ ] Source column added with migration\n- [ ] scrape-kimovil.ts uses new service\n- [ ] Build passes, existing tests pass","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T19:30:39.8528+01:00","updated_at":"2025-12-20T19:57:00.458486+01:00","closed_at":"2025-12-20T19:57:00.458486+01:00","dependencies":[{"issue_id":"cod-8np","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.767894+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-8sx","title":"Phase 6: WebSocket handlers for price scraping","description":"Add WebSocket methods to trigger and monitor Yandex price scraping.\n\n## Implementation\n1. Add WS methods to existing handler:\n   - yandex.scrape: Scrape prices for a device by slug/deviceId\n   - yandex.scrapeByUrl: Scrape given Yandex.Market URL (for new devices)\n   - yandex.linkDevice: Link a Yandex URL to existing device\n\n2. Progress events (reuse existing pattern):\n   - { type: 'progress', stage: 'browser'|'scrape'|'extract'|'save', progress: number }\n   - { type: 'complete', data: { priceCount, minPrice, maxPrice } }\n   - { type: 'error', message: string }\n\n3. Integrate with existing job queue for bulk operations\n\n## Verification\n- WS methods work from frontend\n- Progress streaming works\n- npm run build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:59.065444+01:00","updated_at":"2025-12-22T02:20:15.331586+01:00","closed_at":"2025-12-22T02:20:15.331586+01:00","dependencies":[{"issue_id":"cod-8sx","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.414912+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-8sx","depends_on_id":"cod-ag0","type":"blocks","created_at":"2025-12-22T01:56:55.286956+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-8w7","title":"Phase 3: Price storage service","description":"Create PriceService for writing price quotes and updating summaries.\n\n## Implementation\n1. Create src/services/price.ts with PriceService:\n   - savePriceQuotes(deviceId, source, offers[], scrapeId): Effect\n   - updatePriceSummary(deviceId): Effect\n   - getPriceHistory(deviceId, options): Effect\n\n2. Methods:\n   - savePriceQuotes: Insert rows to price_quotes with all fields\n   - updatePriceSummary: Compute min/max from available quotes, upsert price_summary\n   - getPriceHistory: Query for charts (group by date, optional variant filter)\n\n3. Use @effect/sql patterns from existing services\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:26.085766+01:00","updated_at":"2025-12-22T02:07:52.492635+01:00","closed_at":"2025-12-22T02:07:52.492635+01:00","dependencies":[{"issue_id":"cod-8w7","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.316892+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-8w7","depends_on_id":"cod-a4l","type":"blocks","created_at":"2025-12-22T01:56:55.200072+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-8wi","title":"Phase 1: Extend BrowserService interface and convert to Layer.scoped","description":"Add withPersistentStealthPage method signature. Convert BrowserServiceLive from Layer.succeed to Layer.scoped. Add Ref\u003cOption\u003c{browser, page}\u003e\u003e and Semaphore(1) for state management.","acceptance_criteria":"- [ ] Interface has withPersistentStealthPage method\n- [ ] Layer converted to Layer.scoped with acquireRelease\n- [ ] State refs created (browser/page Ref, Semaphore)\n- [ ] Existing scoped methods unchanged\n- [ ] npm run check-types passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:38:37.19559+01:00","updated_at":"2025-12-21T17:42:38.425932+01:00","closed_at":"2025-12-21T17:42:38.425932+01:00","dependencies":[{"issue_id":"cod-8wi","depends_on_id":"cod-3a9","type":"parent-child","created_at":"2025-12-21T17:39:10.451215+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-a1z","title":"Add Prices tab to PhoneDataModal","description":"The main implementation: add a Prices tab that handles linking, scraping, and displaying Yandex.Market price data.","design":"Three states: (1) No link - input field for Yandex.Market URL with Link button and validation, (2) Linked but no prices - show linked URL with Scrape Prices button and progress indicator, (3) Has prices - show summary (min-max, count, updated time), offers list (seller, price, variant, availability), Refresh button. Use WebSocket for yandex.link and yandex.scrape calls. Handle progress events during scraping.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T03:08:51.127539+01:00","updated_at":"2025-12-22T03:21:52.887892+01:00","closed_at":"2025-12-22T03:21:52.887892+01:00","dependencies":[{"issue_id":"cod-a1z","depends_on_id":"cod-3xb","type":"parent-child","created_at":"2025-12-22T03:09:07.749101+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-a21","title":"Widget: Create WidgetService with caching layer","description":"Create the core WidgetService Effect service with multi-layer caching.\n\n## Deliverables\n1. apps/scraper/src/services/widget.ts - WidgetService with:\n   - getWidgetHtml(slug, options) - main entry point\n   - In-memory LRU cache (5-10 min TTL)\n   - Cache key: widget:v1:${slug}:${arrowVariant}:${theme}\n2. Add to LiveRuntime layer composition\n\n## Interface\n- getWidgetHtml(params: { slug, arrowVariant?, theme? }) =\u003e Effect\u003cstring, WidgetServiceError\u003e\n- invalidateSlug(slug: string) =\u003e Effect\u003cvoid\u003e\n- invalidateAll() =\u003e Effect\u003cvoid\u003e\n\n## Caching Strategy\n- L1: In-memory LRU (10k entries, 5 min TTL)\n- L2: SQLite widget_html table (soft 3h, hard 24h TTL)\n- Stale-while-revalidate: serve stale, trigger background refresh","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-08T18:15:24.227102+01:00","updated_at":"2026-01-08T18:28:38.753919+01:00","closed_at":"2026-01-08T18:28:38.753919+01:00","close_reason":"Implemented WidgetService with in-memory LRU cache and cache invalidation","dependencies":[{"issue_id":"cod-a21","depends_on_id":"cod-1qq","type":"parent-child","created_at":"2026-01-08T18:16:38.349221+01:00","created_by":"daemon"},{"issue_id":"cod-a21","depends_on_id":"cod-z8g","type":"blocks","created_at":"2026-01-08T18:16:49.08859+01:00","created_by":"daemon"}]}
{"id":"cod-a4l","title":"Phase 2: Yandex.Market price extractor","description":"Create extraction logic for Yandex.Market price data from HTML.\n\n## Implementation\n1. Create src/sources/yandex_market/ directory\n2. Create extractor.ts with:\n   - parseYandexPrices(html: string): YandexOffer[]\n   - Extract from embedded JSON patterns:\n     - \"price\":{\"value\":N,\"currency\":\"RUR\"}\n     - \"actualPrice\":{\"amount\":{\"intPart\":N}}\n     - \"businessName\", \"businessId\", \"shopName\"\n     - oldPrice, discountPercent\n   - Normalize currency RUR → RUB\n\n3. Define types:\n   - YandexOffer: sellerName, sellerId, priceMinorUnits, currency, oldPrice, discount, variantKey, variantLabel, url, isAvailable\n\n## Verification\n- Unit tests for extractor\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:15.932339+01:00","updated_at":"2025-12-22T02:04:32.972833+01:00","closed_at":"2025-12-22T02:04:32.972833+01:00","dependencies":[{"issue_id":"cod-a4l","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.284817+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-a4l","depends_on_id":"cod-uzr","type":"blocks","created_at":"2025-12-22T01:56:55.170611+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-abp","title":"Epic: Yandex.Market Price Scraping","description":"Add ability to scrape Yandex.Market product pages for phone prices. Enables price history tracking and charts.\n\n## Research Findings\n- Local Playwright: 403 + captcha (blocked)\n- Bright Data: Works (2.5MB HTML with prices)\n- Price data: JSON embedded in page with seller info, variants, discounts\n\n## URL Pattern\nhttps://market.yandex.ru/card/{product-name}/{product-id}\n\n## Goals\n1. Link devices to Yandex.Market URLs via device_sources\n2. Scrape prices using Bright Data\n3. Extract multi-seller price quotes with variants\n4. Store price history for charting\n5. Update price_summary with current min/max\n\n## Architecture\n- New source: yandex_market\n- New pipeline: source=yandex_market, dataKind=prices\n- Reuse existing: device_sources, scrapes, entity_data_raw, price_quotes, price_summary","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-22T01:54:53.617706+01:00","updated_at":"2025-12-22T02:20:22.119352+01:00","closed_at":"2025-12-22T02:20:22.119352+01:00"}
{"id":"cod-ag0","title":"Phase 5: API endpoints for price data","description":"Add REST API endpoints for price data access.\n\n## Implementation\n1. Add to existing routes or create new price routes:\n   - GET /api/prices/:deviceId - Current prices (from price_summary + latest quotes)\n   - GET /api/prices/:deviceId/history - Price history for charts\n   - GET /api/prices/:deviceId/quotes - All current quotes with seller info\n\n2. Query parameters for history:\n   - days: number (default 30)\n   - variant: string (filter by variant_key)\n   - groupBy: 'day' | 'hour' (aggregation level)\n\n3. Response format for charts:\n   { \n     dates: string[], \n     minPrices: number[], \n     avgPrices: number[],\n     variants?: string[] \n   }\n\n## Verification\n- Endpoints return valid JSON\n- npm run build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:48.50868+01:00","updated_at":"2025-12-22T02:14:31.691925+01:00","closed_at":"2025-12-22T02:14:31.691925+01:00","dependencies":[{"issue_id":"cod-ag0","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.382032+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-ag0","depends_on_id":"cod-ase","type":"blocks","created_at":"2025-12-22T01:56:55.257689+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-apr","title":"Separate clear/refresh actions for Raw and AI data","description":"Add granular data management: separate 'Clear Raw Data' and 'Clear AI Data' buttons, plus 'Refresh Raw' (re-run extractors) and 'Refresh AI' (re-run Gemini) actions. Integrate into table row actions, PhoneDataModal tabs, and bulk selection bar.\n\n## Oracle-Validated API Contract\n\n### Delete endpoints (clear data):\n- DELETE /api/phone-data/raw/:slug - clear phone_data_raw only\n- DELETE /api/phone-data/:slug - clear phone_data only\n- Keep DELETE /api/scrape/html/:slug for raw_html (update to actually clear HTML)\n\n### Process endpoints (refresh):\n- POST /api/process/raw - re-run extractors on cached HTML (exists)\n- POST /api/process/ai - re-run Gemini on raw data (exists)\n\n### Edge cases to handle:\n- Refresh with missing source: 404/409 response\n- No cascade: clearing AI doesn't clear Raw (and vice versa)\n- Concurrency guard: check if slug is running in job_queue\n\n## UI Integration Points\n1. DevicesTable row actions: Clear Raw, Clear AI buttons\n2. PhoneDataModal tabs: Refresh button per tab (Raw/AI)\n3. SelectionBar: Bulk clear raw/AI actions","design":"## Backend Changes (api.ts + phone-data.ts)\n\n### PhoneDataService additions:\n- deleteRaw(slug): DELETE from phone_data_raw WHERE slug\n- delete(slug): DELETE from phone_data WHERE slug\n\n### New API routes:\n- DELETE /api/phone-data/raw/:slug → phoneData.deleteRaw(slug)\n- DELETE /api/phone-data/:slug → phoneData.delete(slug)\n\n### Update existing routes:\n- POST /api/process/raw: Add 404 check for missing HTML\n- POST /api/process/ai: Add 404 check for missing raw data\n\n## Frontend Changes\n\n### useSlugsApi.ts additions:\n- clearRawData(slug): DELETE /api/phone-data/raw/:slug\n- clearAiData(slug): DELETE /api/phone-data/:slug\n- refreshRawData(slug): POST /api/process/raw\n- refreshAiData(slug): POST /api/process/ai\n\n### DevicesTable.tsx:\n- Add 'Clear Raw' action button (cyan trash icon)\n- Add 'Clear AI' action button (violet trash icon)\n- Show only when respective data exists\n\n### PhoneDataModal.tsx:\n- Add refresh button to Raw Data tab header\n- Add refresh button to AI Data tab header\n- Loading state during refresh\n- Auto-reload data after refresh\n\n### SelectionBar.tsx:\n- Add 'Clear Raw' bulk action\n- Add 'Clear AI' bulk action","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-21T21:59:35.823985+01:00","updated_at":"2026-01-08T18:02:26.563038+01:00","closed_at":"2026-01-08T18:02:26.563038+01:00","close_reason":"Feature implemented: separate clear/refresh actions for Raw and AI data with DELETE endpoints and UI integration"}
{"id":"cod-ase","title":"Phase 4: Yandex.Market prices pipeline","description":"Create pipeline for Yandex.Market price scraping using existing pipeline registry pattern.\n\n## Implementation\n1. Create src/sources/yandex_market/prices-pipeline.ts:\n   - Register pipeline: source='yandex_market', dataKind='prices'\n   - Stages: scrape, process_raw\n\n2. scrape stage:\n   - Use BrowserService with Bright Data (required - local blocked)\n   - Navigate to URL from device_sources\n   - Save HTML to raw_html with source='yandex_market'\n   - Create scrapes record\n\n3. process_raw stage:\n   - Load HTML from raw_html\n   - Call extractor to parse offers\n   - Save to entity_data_raw (source='yandex_market', dataKind='prices')\n   - Call PriceService.savePriceQuotes\n   - Call PriceService.updatePriceSummary\n\n4. Create src/sources/yandex_market/index.ts to register pipeline\n\n## Verification\n- Pipeline registers correctly\n- npm run build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:38.605044+01:00","updated_at":"2025-12-22T02:11:33.699364+01:00","closed_at":"2025-12-22T02:11:33.699364+01:00","dependencies":[{"issue_id":"cod-ase","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.348931+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-ase","depends_on_id":"cod-8w7","type":"blocks","created_at":"2025-12-22T01:56:55.228831+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-b06","title":"Epic: DevicesTable Redesign","description":"Complete redesign of the devices table with improved UX, granular reactivity, and context-based architecture.\n\n## Goals\n1. Clear design language: whole row clickable, data icons open modal tabs\n2. Improved selection: shift-click range, cmd/ctrl multi-select\n3. Prices info integrated into rows\n4. Actions consolidated into overflow menu (no delete next to open)\n5. Context-based architecture with granular SolidJS reactivity\n\n## Design Direction: Industrial Precision\nUtilitarian, data-dense aesthetic. Monospace for data, tight spacing, color coding over decoration.\n\n## Architecture\n- DevicesTableProvider with 4 contexts (Devices, Selection, RowData, Actions)\n- createStore for status maps (granular per-key updates)\n- SelectionService with modifier key support\n- Lazy price loading via createResource","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-23T17:15:17.088306+01:00","updated_at":"2025-12-23T17:52:52.307875+01:00","closed_at":"2025-12-23T17:52:52.307875+01:00"}
{"id":"cod-b4n","title":"Phase 3: Core Services Implementation","description":"Implement new core services for device registry, entity data, and scrape management.\n\n## New services:\n1. DeviceRegistryService - Manage devices + device_sources\n   - lookupDevice(source, externalId)\n   - createDevice(slug, name, brand)\n   - linkDeviceToSource(deviceId, source, externalId, url)\n   - getDeviceById/getDeviceBySlug\n\n2. EntityDataService - Abstract entity_data_raw + entity_data\n   - saveRawData(deviceId, source, dataKind, data, scrapeId?)\n   - saveFinalData(deviceId, dataKind, data)\n   - getRawData/getFinalData\n\n3. ScrapeRecordService - Manage scrapes table lifecycle\n   - createScrape(deviceId, source, dataKind, externalId, url)\n   - startScrape(id)\n   - completeScrape(id)\n   - failScrape(id, error)\n\n## Domain models:\n- Device, DeviceSourceLink schemas\n- DataKind type: 'specs' | 'prices' | 'reviews' | 'availability'\n\n## Files:\n- apps/scraper/src/services/device-registry.ts (new)\n- apps/scraper/src/services/entity-data.ts (new)\n- apps/scraper/src/services/scrape-record.ts (new)\n- packages/scraper-domain/src/models/device.ts (new)\n\nEstimated: 3-4 days","acceptance_criteria":"- [ ] DeviceRegistryService implemented with tests\n- [ ] EntityDataService implemented\n- [ ] ScrapeRecordService implemented\n- [ ] Device + DeviceSourceLink schemas defined\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:29.519649+01:00","updated_at":"2025-12-21T04:54:29.687519+01:00","closed_at":"2025-12-21T04:54:29.687519+01:00","dependencies":[{"issue_id":"cod-b4n","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.366509+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-b4n","depends_on_id":"cod-li6","type":"blocks","created_at":"2025-12-21T04:41:19.048277+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-b5g","title":"Optimize ORDER BY index alignment for /devices endpoint","description":"The ORDER BY CASE WHEN release_date IS NULL expression doesn't fully use the idx_devices_release_date index. SQLite can't leverage the index when sorting by an expression.\n\nOptions:\n1. Simplify ORDER BY to 'ORDER BY release_date DESC, name' (accept NULL ordering)\n2. Use expression index matching the ORDER BY: CREATE INDEX ... ON devices((release_date IS NULL), release_date DESC, name)\n\nCurrent: ~2ms response time\nPotential: Could squeeze out a few more ms with proper index alignment\n\nContext from Oracle review: https://ampcode.com/threads/T-019b9e44-ae4a-76cd-9f86-c29ceff2a3f7","status":"open","priority":3,"issue_type":"chore","created_at":"2026-01-08T18:00:29.972137+01:00","updated_at":"2026-01-08T18:00:29.972137+01:00"}
{"id":"cod-baw","title":"Unified search UI: local DB + Kimovil","description":"Update web UI search on index page to search both local devices DB and Kimovil API. Show local results instantly, then load Kimovil additions.\n\nRequirements:\n- Search local devices table first (fast, instant results)\n- Optionally fetch Kimovil API for devices not in DB\n- Clean, modern UI to display mixed results\n- Clear visual distinction between local vs Kimovil-only items\n- Fast perceived performance (show local results immediately)","design":"Consider:\n- Parallel search: local DB query + Kimovil API call\n- Show local results first, append Kimovil results as they arrive\n- UI indicators: checkmark for 'in DB', plus icon for 'add from Kimovil'\n- Debounced search input\n- Loading states for each source","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-21T17:56:07.30486+01:00","updated_at":"2025-12-25T18:34:08.565+01:00","closed_at":"2025-12-25T18:34:08.565+01:00"}
{"id":"cod-bb8","title":"Refactor storage.ts into modular service architecture","description":"Split the 2075-line storage.ts monolith into focused, testable services. Enable multi-source scraping architecture with shared infrastructure. See architecture diagram in thread T-019b3cfd-8ef0-770e-8cb1-2293860be2fb.","design":"Phase 1: Extract data layer services (HtmlCacheService, JobQueueService, DeviceService)\nPhase 2: Create PhoneDataService, refactor OpenAI integration  \nPhase 3: Refactor scrapers to use new services, prepare for multi-source\nPhase 4: Update LiveLayer composition, cleanup deprecated code","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-20T19:30:30.435199+01:00","updated_at":"2025-12-20T23:40:55.273208+01:00","closed_at":"2025-12-20T23:40:55.273208+01:00"}
{"id":"cod-bu2","title":"API endpoints for widget mappings","description":"Create /api/widget-mappings routes: GET / (list with status filter), GET /:rawModel (single mapping with suggestions), PUT /:rawModel (update device_id/status), POST /sync (trigger sync from widget cache), GET /devices/search?q= (device search for manual assignment).","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-08T20:08:35.011063+01:00","updated_at":"2026-01-08T20:26:25.760405+01:00","closed_at":"2026-01-08T20:26:25.760405+01:00","close_reason":"Created /api/widget-mappings endpoints with input validation and proper error handling","dependencies":[{"issue_id":"cod-bu2","depends_on_id":"cod-g7x","type":"parent-child","created_at":"2026-01-08T20:09:08.278197+01:00","created_by":"daemon"},{"issue_id":"cod-bu2","depends_on_id":"cod-cb5","type":"blocks","created_at":"2026-01-08T20:09:30.966432+01:00","created_by":"daemon"}]}
{"id":"cod-c4w","title":"Shared helpers \u0026 types for JobsSection","description":"Create centralized helpers for status logic, CSS classes, and progress calculations. Eliminates duplication across components.","design":"Create jobViewHelpers.ts with: getDisplayStatus(), isActiveStatus(), statusLabel(), statusPillClass(), statusDotClass(), progressPercent(), progressBarClass(). Export DisplayStatus type.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T00:17:06.635494+01:00","updated_at":"2025-12-22T00:27:47.368014+01:00","closed_at":"2025-12-22T00:27:47.368014+01:00","dependencies":[{"issue_id":"cod-c4w","depends_on_id":"cod-t8h","type":"parent-child","created_at":"2025-12-22T00:17:37.489055+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-c4w","depends_on_id":"cod-u5r","type":"blocks","created_at":"2025-12-22T00:17:37.592264+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-cb5","title":"WidgetMappingService with matching logic","description":"Extract findBestMatch, normalizeModel, detectBrand from widget-debug.ts into WidgetMappingService. Methods: syncMappings() to populate from widget cache with auto-matching, getMapping(rawModel), updateMapping(rawModel, deviceId, status), searchDevices(query). Auto-confirm threshold \u003e=0.97, suggested 0.90-0.97, pending \u003c0.90.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-08T20:08:20.945858+01:00","updated_at":"2026-01-08T20:22:33.350548+01:00","closed_at":"2026-01-08T20:22:33.350548+01:00","close_reason":"Created WidgetMappingService with syncMappings, getMapping, updateMapping, listMappings, searchDevices. Uses atomic upsert and transaction wrapping.","dependencies":[{"issue_id":"cod-cb5","depends_on_id":"cod-g7x","type":"parent-child","created_at":"2026-01-08T20:09:08.162476+01:00","created_by":"daemon"},{"issue_id":"cod-cb5","depends_on_id":"cod-4wd","type":"blocks","created_at":"2026-01-08T20:09:30.854189+01:00","created_by":"daemon"}]}
{"id":"cod-cnh","title":"Phase 3: API endpoints for schedules","description":"Add REST API endpoints for managing schedules.\n\n## Endpoints\n- GET /api/schedules - list all schedules with status\n- GET /api/schedules/:id - get single schedule details\n- POST /api/schedules - create new schedule\n- PUT /api/schedules/:id - update schedule\n- DELETE /api/schedules/:id - delete schedule\n- POST /api/schedules/:id/enable - enable schedule\n- POST /api/schedules/:id/disable - disable schedule\n- POST /api/schedules/:id/trigger - manual trigger (creates job immediately)\n\n## Response Format\nSchedule object with:\n- id, name, source, dataKind, jobType, mode\n- cronExpression, timezone, enabled\n- nextRunAt, lastRunAt, lastStatus, lastError, lastJobId\n\n## Files\n- apps/scraper/src/routes/api.ts (add schedule routes)","acceptance_criteria":"- [ ] All CRUD endpoints implemented\n- [ ] enable/disable endpoints work\n- [ ] trigger endpoint creates and starts job\n- [ ] Proper error handling (404, validation)\n- [ ] npm run build passes\n- [ ] npm run check-types passes","notes":"COMPLETED: Phase 3 - API endpoints\n\nENDPOINTS:\n- GET /api/schedules - list all schedules\n- GET /api/schedules/:id - get single schedule\n- POST /api/schedules - create (201 Created)\n- PUT /api/schedules/:id - update schedule\n- DELETE /api/schedules/:id - delete (204 No Content)\n- POST /api/schedules/:id/enable - enable + set next_run_at\n- POST /api/schedules/:id/disable - disable schedule\n- POST /api/schedules/:id/trigger - manual trigger (returns jobId)\n\nORACLE REVIEW FIXES:\n- Added 400 status for validation errors\n- Added ID validation (NaN, negative)\n- Added jobType/mode allowlist validation\n- 201 status for POST create\n\nCOMMIT: 7640199 (+219 lines)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T18:03:04.974735+01:00","updated_at":"2025-12-23T18:18:24.199158+01:00","closed_at":"2025-12-23T18:18:24.199158+01:00","dependencies":[{"issue_id":"cod-cnh","depends_on_id":"cod-eip","type":"parent-child","created_at":"2025-12-23T18:03:24.971048+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-cnh","depends_on_id":"cod-s4i","type":"blocks","created_at":"2025-12-23T18:03:45.236863+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-co8","title":"Phase 1: Extract JobQueueService","description":"Extract job queue CRUD from storage.ts into dedicated JobQueueService.","design":"1. Create services/job-queue.ts\n2. Move: createJob, getJob, getAllJobs, updateJobStatus, getJobStats\n3. Move: enqueueJobSlugs, claimNextJobQueueItem, completeQueueItem, rescheduleQueueItem\n4. Move: resetStuckQueueItems, resetErrorQueueItems, getErrorQueueItems, unclaimRunningItems, getTimeoutStats\n5. Move deprecated bulk job methods as aliases\n6. Update bulk-job.ts to use new service","acceptance_criteria":"- [ ] JobQueueService created with Effect Context pattern\n- [ ] All job/queue methods moved\n- [ ] bulk-job.ts uses new service\n- [ ] Build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T19:30:46.941906+01:00","updated_at":"2025-12-20T19:57:00.492287+01:00","closed_at":"2025-12-20T19:57:00.492287+01:00","dependencies":[{"issue_id":"cod-co8","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.801291+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-cvb","title":"Phase 1: Schema + SchedulerService core","description":"Add job_schedules table and implement SchedulerService with CRUD operations.\n\n## Schema: job_schedules\n- id INTEGER PRIMARY KEY\n- name TEXT NOT NULL\n- source TEXT NOT NULL (e.g., 'yandex_market')\n- data_kind TEXT NOT NULL (e.g., 'prices')\n- job_type TEXT NOT NULL DEFAULT 'scrape'\n- mode TEXT NOT NULL DEFAULT 'fast'\n- filter TEXT (optional JSON array of slugs, null = all)\n- enabled INTEGER DEFAULT 0 (disabled by default!)\n- cron_expression TEXT NOT NULL\n- timezone TEXT DEFAULT 'UTC'\n- next_run_at INTEGER\n- last_run_at INTEGER\n- last_status TEXT ('success'|'error'|'skipped')\n- last_error TEXT\n- last_job_id TEXT (FK to jobs.id)\n- locked_until INTEGER (crash-safety lock)\n- created_at/updated_at\n\n## SchedulerService Interface\n- listSchedules()\n- getSchedule(id)\n- upsertSchedule(input)\n- enableSchedule(id)\n- disableSchedule(id)\n- deleteSchedule(id)\n- triggerNow(id) → jobId\n\n## Files\n- apps/scraper/src/sql/schema.ts (add migration)\n- apps/scraper/src/services/scheduler.ts (new)\n- apps/scraper/src/layers/live.ts (add to layer)","acceptance_criteria":"- [ ] job_schedules table created with migration\n- [ ] SchedulerService implemented with all CRUD ops\n- [ ] SchedulerService added to LiveLayer\n- [ ] npm run build passes\n- [ ] npm run check-types passes","notes":"COMPLETED: Phase 1 - Schema + SchedulerService core\n\nCHANGES:\n- Added job_schedules table with indexes (enabled, next_run_at)\n- Created SchedulerService with full CRUD + triggerNow\n- Added to LiveLayer\n\nCOMMIT: 59993c2 (+293 lines)\n\nORACLE REVIEW NOTES:\n- Consider adding CHECK constraint for last_status\n- Consider wrapping upsertSchedule in transaction\n- Phase 2 will need claimDueSchedules + markScheduleResult methods","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T18:02:44.396409+01:00","updated_at":"2025-12-23T18:07:59.797924+01:00","closed_at":"2025-12-23T18:07:59.797924+01:00","dependencies":[{"issue_id":"cod-cvb","depends_on_id":"cod-eip","type":"parent-child","created_at":"2025-12-23T18:03:24.914573+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-dq8","title":"Fix: WordPress sync doesn't handle deleted/trashed posts","description":"Posts that are trashed/deleted in WordPress remain in cache forever. Need periodic reconciliation or status filtering.","design":"Options:\n1. Periodic full enumeration to reconcile cache\n2. Request status=any and handle trash/private posts\n3. Add a 'stale check' that removes posts not seen in recent syncs","notes":"COMPLETED: Fixed Oracle issues:\n1. Metadata changes now trigger cache update even if content unchanged\n2. Widget queries now JOIN with wp_posts_cache and filter by status='publish'\n3. Widget re-extraction only happens when content actually changed","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-08T19:51:08.458072+01:00","updated_at":"2026-01-08T19:54:14.211712+01:00","closed_at":"2026-01-08T19:54:14.211715+01:00","dependencies":[{"issue_id":"cod-dq8","depends_on_id":"cod-3aw","type":"discovered-from","created_at":"2026-01-08T19:51:15.09041+01:00","created_by":"daemon"}]}
{"id":"cod-dre","title":"Phone Data UI Integration","description":"Integrate phone_data_raw and phone_data tables into web UI with tabbed modal (HTML/Raw/AI/Compare), JsonViewer with Shiki highlighting, and redesigned dense table with data indicators.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-20T00:01:28.605046+01:00","updated_at":"2025-12-25T18:35:48.30869+01:00","closed_at":"2025-12-25T18:35:48.30869+01:00","comments":[{"id":1,"issue_id":"cod-dre","author":"romanzagrebin","text":"Phase 1-3 complete:\n- Backend: GET /api/phone-data/raw/:slug, GET /api/phone-data/:slug\n- Backend: /api/scrape/status now returns hasRawData, hasAiData\n- Frontend types: PhoneDataRaw, PhoneDataAi, Sku, SingleCameraData, Benchmark\n- API hooks: fetchPhoneDataRaw(), fetchPhoneDataAi()\n\nNext: Phase 4 - JsonViewer + TabBar components","created_at":"2025-12-19T23:04:38Z"},{"id":2,"issue_id":"cod-dre","author":"romanzagrebin","text":"Phase 4-5 complete:\n- Installed shiki for JSON syntax highlighting\n- Created JsonViewer component (Shiki highlighting, copy button, loading/empty states)\n- Created TabBar component (HTML/Raw/AI/Compare tabs with status indicators)\n- Created PhoneDataModal (replaces HtmlPreviewModal, tabbed interface, lazy data loading)\n- Updated Slugs.tsx integration\n- Updated DevicesTable to use new modal\n\nFiles created:\n- apps/ws-web/src/pages/slugs/components/JsonViewer.tsx\n- apps/ws-web/src/pages/slugs/components/TabBar.tsx\n- apps/ws-web/src/pages/slugs/components/PhoneDataModal.tsx\n\nType checks pass. Ready for testing.","created_at":"2025-12-19T23:09:10Z"},{"id":3,"issue_id":"cod-dre","author":"romanzagrebin","text":"Phase 6+8 complete:\n- Created DataStatusIcons component (HTML/Raw/AI/Verified icons with color coding)\n- Redesigned DevicesTable: dense layout, merged Device column (name+slug), separate Queue column, data icons\n- Updated StatsPanel: 6-column responsive grid with Raw Data + AI Data counts\n- Backend /api/slugs now returns rawData/aiData counts\n\nAll phases complete. Ready for testing.","created_at":"2025-12-19T23:12:49Z"}]}
{"id":"cod-dt2","title":"Implement rich CpuCoreCluster format for CPU cores parsing","description":"Current cpuCores format is string[] like ['4x2400', '4x2000'] which loses valuable data. Need structured format preserving core names (Cortex A78, Kryo, Firestorm), P/E core classification, and handling no-frequency cores (Apple devices).","design":"Add CpuCoreCluster interface: { count, maxFreqMhz, label, role, rawGroup, index }. Create getCpuCoreClusters() in parsers.ts, keep getCpuCores() as adapter. Update RawPhoneData in extractors.ts, scraper-domain, and scraper-protocol schemas.","acceptance_criteria":"- [ ] CpuCoreCluster type defined with count, maxFreqMhz, label, role, rawGroup, index\n- [ ] getCpuCoreClusters() parses all format variations from exploration\n- [ ] getCpuCores() adapter returns string[] for backward compat\n- [ ] Handles no-frequency cores (Apple: Firestorm, Avalanche, etc.)\n- [ ] Detects P/E core roles from keywords and known mappings\n- [ ] Effect Schemas updated in scraper-domain and scraper-protocol\n- [ ] Type checks pass\n- [ ] Existing tests still work","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-21T22:25:19.083937+01:00","updated_at":"2025-12-21T22:31:15.314286+01:00","closed_at":"2025-12-21T22:31:15.314286+01:00"}
{"id":"cod-duf","title":"Phase 1: Extract DeviceService","description":"Extract device and prefix CRUD from storage.ts into dedicated DeviceService.","design":"1. Create services/device.ts\n2. Move: upsertDevice, getDevice, getDeviceCount, getAllDevices\n3. Move: enqueuePrefix, getNextPendingPrefix, markPrefixDone, getPendingPrefixCount, seedInitialPrefixes, resetAllPrefixes\n4. Update slug-crawler.ts to use new service","acceptance_criteria":"- [ ] DeviceService created with Effect Context pattern\n- [ ] All device/prefix methods moved\n- [ ] slug-crawler.ts uses new service\n- [ ] Build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T19:30:52.435115+01:00","updated_at":"2025-12-20T19:57:00.524369+01:00","closed_at":"2025-12-20T19:57:00.524369+01:00","dependencies":[{"issue_id":"cod-duf","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.832406+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-ecc","title":"Widget: Elysia routes with cache headers","description":"Create widget routes file with proper HTTP caching.\n\n## Deliverables\n1. apps/scraper/src/routes/widget.ts\n2. GET /widget/v1/price/:slug - returns HTML\n3. POST /widget/v1/invalidate/:slug - invalidate single slug\n4. POST /widget/v1/invalidate - invalidate all widgets\n5. Mount in index.ts\n\n## Query Params\n- arrowVariant: neutral|up|down|hot|new (default: neutral)\n- theme: light|dark (default: light)\n\n## Response Headers\n- Content-Type: text/html; charset=utf-8\n- Cache-Control: public, max-age=300, stale-while-revalidate=86400\n- ETag: content hash or version\n- Vary: Accept-Encoding\n\n## Error Handling\n- Unknown slug: 200 with 'Device not found' styled card\n- DB error: 200 with 'Temporarily unavailable' card\n- Never expose raw errors in HTML","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-08T18:15:42.960629+01:00","updated_at":"2026-01-08T18:30:50.545775+01:00","closed_at":"2026-01-08T18:30:50.545775+01:00","close_reason":"Implemented widget routes with cache headers","dependencies":[{"issue_id":"cod-ecc","depends_on_id":"cod-1qq","type":"parent-child","created_at":"2026-01-08T18:16:38.581632+01:00","created_by":"daemon"},{"issue_id":"cod-ecc","depends_on_id":"cod-a21","type":"blocks","created_at":"2026-01-08T18:16:49.193348+01:00","created_by":"daemon"}]}
{"id":"cod-eip","title":"Epic: Recurring Cron Jobs for Price Updates","description":"Add robust recurring/scheduled jobs functionality for automated price updates. Build Effect-native scheduler with SQLite persistence.\n\n## Architecture\n- New SchedulerService (separate from JobQueueService)\n- job_schedules table for persistence\n- Daemon Effect fiber polling DB\n- Croner library for cron expression parsing only\n- Auto-trigger when enabled, disabled by default\n\n## Key Features\n1. Cron expressions in backend, simple intervals in UI\n2. Schedules opt-in per device/source\n3. Crash recovery: missed runs detected and handled\n4. Observability: API endpoints for status\n\n## Phases\n1. Schema + SchedulerService core\n2. Scheduler daemon loop\n3. API endpoints\n4. UI integration (optional/future)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-23T18:02:30.111455+01:00","updated_at":"2025-12-23T18:19:56.170217+01:00","closed_at":"2025-12-23T18:19:56.170217+01:00"}
{"id":"cod-f3t","title":"Epic: Multi-Source Device Data Platform Refactor (V3)","description":"Evolve from Kimovil scraper to multi-source device data platform. Make devices central and source-agnostic. Treat scrapes as first-class entities. Let each data kind define its own schema but reuse same infrastructure.\n\nKey changes:\n- devices table as canonical registry\n- device_sources for external source links\n- scrapes table for individual attempts\n- entity_data_raw + entity_data for generic data storage\n- price_quotes for multi-row price data\n- source + dataKind aware job queue\n\nEstimated: 2-3 weeks\n\nReference: REFACTOR_PLAN_V3.md","design":"Pipeline registry pattern: (source, dataKind, stage) → handler. Each source implements stages: scrape → process_raw → process_ai","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-21T04:39:56.921903+01:00","updated_at":"2025-12-21T05:10:36.388891+01:00","closed_at":"2025-12-21T05:10:36.388891+01:00"}
{"id":"cod-fzn","title":"Phase 5: Introduce DatabaseService layer","description":"Replace singleton getDb() pattern with proper Effect DatabaseService for idiomatic dependency injection.","design":"1. Create DatabaseService interface in db.ts with { db: Database.Database }\n2. Create DatabaseServiceLive layer that initializes connection + runs all migrations\n3. Update all data services (JobQueue, HtmlCache, Device, PhoneData) to yield* DatabaseService\n4. Update LiveLayer to provide DatabaseServiceLive to all data services\n5. Remove duplicate getDb() singletons from each service\n6. Enables proper testing with mock database","acceptance_criteria":"- [ ] DatabaseService created with Effect Context pattern\n- [ ] All data services depend on DatabaseService via yield*\n- [ ] Single shared connection guaranteed by Effect\n- [ ] No duplicate getDb() functions\n- [ ] Build passes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-20T19:47:01.359117+01:00","updated_at":"2025-12-20T23:40:51.463908+01:00","closed_at":"2025-12-20T23:40:51.463908+01:00","dependencies":[{"issue_id":"cod-fzn","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:47:05.88226+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-fzn","depends_on_id":"cod-x5r","type":"blocks","created_at":"2025-12-20T19:47:05.914207+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-g7x","title":"Widget mapping table and manual review UI","description":"Implement the widget_model_mappings table and UI for manual slug assignment.\n\n## From Oracle plan:\n- widget_model_mappings table with status workflow (pending/suggested/auto_confirmed/confirmed/ignored)\n- Mapping editor modal with suggested matches\n- Device search for manual assignment\n- Confirm \u0026 Lock / Ignore actions\n- Status filter tabs in main table","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-08T19:54:34.311119+01:00","updated_at":"2026-01-08T20:38:38.341957+01:00","closed_at":"2026-01-08T20:38:38.341957+01:00","close_reason":"All 5 subtasks completed: schema changes, WidgetMappingService, API endpoints, status tabs UI, mapping editor modal","dependencies":[{"issue_id":"cod-g7x","depends_on_id":"cod-56x","type":"blocks","created_at":"2026-01-08T19:54:40.609097+01:00","created_by":"daemon"}]}
{"id":"cod-gb9","title":"Fix 4: Populate variantLabel from Yandex HTML","description":"Extract human-readable variant labels (RAM/storage) from Yandex.Market HTML.\n\n## Implementation\n1. Analyze /tmp/yandex-brightdata.html for variant/SKU patterns\n2. Update apps/scraper/src/sources/yandex_market/extractor.ts:\n   - Look for memorySize, ramSize, or similar fields\n   - Build variantLabel like '4 GB / 128 GB'\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T02:24:37.689954+01:00","updated_at":"2025-12-22T02:39:19.942359+01:00","closed_at":"2025-12-22T02:39:19.942359+01:00","dependencies":[{"issue_id":"cod-gb9","depends_on_id":"cod-ulx","type":"parent-child","created_at":"2025-12-22T02:24:45.50384+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-gb9","depends_on_id":"cod-v72","type":"blocks","created_at":"2025-12-22T02:24:45.599006+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-h11","title":"Implement shared runScheduleOnce executor","description":"Extract shared executor function that handles: claim lock, check last job status, create job, get slugs, enqueue, mark result. Called by both scheduler loop and triggerNow.","design":"Options: caller (scheduler|manual), claimLock, skipIfActiveJob, requireEnabled, swallowInternalErrors. Returns ScheduleRunResult. Scheduler loop and triggerNow both call this function.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T02:02:29.649398+01:00","updated_at":"2025-12-24T02:06:51.440827+01:00","closed_at":"2025-12-24T02:06:51.440827+01:00"}
{"id":"cod-h2g","title":"Integrate catalogue Yandex links into widget mapping UI","description":"Add ability to use Yandex Market links from the catalogue DB in the widget mapping review modal.\n\n## Context\n- Widget mapping modal has a Yandex button with dropdown for manual URL input\n- Catalogue DB (Turso: palach-stage-12-25) has 522 Yandex links stored in Link table\n- Links may be shorteners (kik.cat, ya.cc) that need HTTP resolution\n\n## Deliverables\n1. CatalogueSqlClient - separate Turso connection layer\n2. LinkResolverService - HTTP redirect resolution for shorteners  \n3. CatalogueLinkService - queries catalogue DB for Yandex links by slug\n4. catalogue_link_cache table - cache resolved URLs in scraper DB\n5. API endpoint GET /api/catalogue-links/:slug\n6. Frontend: show 'Use saved link' option in Yandex dropdown when catalogue link exists\n\n## Architecture (from Oracle review)\n- Separate SqlClient for catalogue DB (different connection, failure domain)\n- Soft-fail pattern: treat catalogue as optional, log warnings\n- Cache in scraper DB, not catalogue (read-only external)","design":"Effect-TS architecture per Oracle review:\n- CatalogueSqlClient tag with Turso layer\n- LinkResolverService: fetch with redirect following (5 hops, 3-5s timeout)\n- CatalogueLinkService: depends on CatalogueSqlClient + LinkResolverService\n- CatalogueLinkError with NotFound/Unavailable/Unexpected tags\n- Cache resolved URLs in scraper DB table","status":"in_progress","priority":1,"issue_type":"feature","created_at":"2026-01-08T22:57:17.932352+01:00","updated_at":"2026-01-08T22:57:55.849813+01:00"}
{"id":"cod-idm","title":"Add device_categories table with hierarchy support","description":"Create device_categories table with id, slug, name, parent_id for hierarchical categories (smartphone, tablet, watch, tv, headphones, console, laptop, etc.)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T19:38:58.218964+01:00","updated_at":"2026-01-08T19:41:08.122241+01:00","closed_at":"2026-01-08T19:41:08.122241+01:00","close_reason":"Added device_categories table with hierarchy support","dependencies":[{"issue_id":"cod-idm","depends_on_id":"cod-sne","type":"blocks","created_at":"2026-01-08T19:39:25.202432+01:00","created_by":"daemon"},{"issue_id":"cod-idm","depends_on_id":"cod-0um","type":"blocks","created_at":"2026-01-08T19:39:25.319902+01:00","created_by":"daemon"},{"issue_id":"cod-idm","depends_on_id":"cod-63k","type":"parent-child","created_at":"2026-01-08T19:39:31.443908+01:00","created_by":"daemon"}]}
{"id":"cod-if0","title":"Epic: price.ru Price Source Integration","description":"Integrate price.ru as a second price source alongside Yandex Market.\n\n## API Summary\n- **Partner ID**: 631191034\n- **Base URL**: https://price.ru/v4\n- **Category ID**: 2801 (mobile phones)\n- **Region ID**: 1 (Moscow, default)\n\n### Key Endpoints\n1. \\`POST /search/offers\\` - Search products, returns offers with model_id\n2. \\`GET /models/{id}\\` - Get model details with aggregated price_info (min/max/avg)\n3. \\`GET /regions\\` - List available regions\n\n### Data Model\n- \\`model_id\\` = stable variant identifier (e.g., 8137690 for 'Galaxy S24 Ultra 12/512Gb Gray')\n- \\`click_url\\` = affiliate link (short TTL, fetch on-demand)\n- \\`redirect_target\\` = 'to_merchant' (direct) or 'to_price' (via price.ru)\n- Offers include: price, seller info, availability, variant attributes\n\n## Architecture Approach\n1. Use \\`device_sources\\` for linking (source='price_ru', external_id=model_id)\n2. Store variant metadata in \\`device_sources.metadata\\` (variant_key, color, storage)\n3. Price data goes to \\`price_quotes\\` with source='price_ru'\n4. Use \\`/models/{id}\\` for scheduled updates (returns price_info without affiliate links)\n5. Use \\`/search/offers\\` for on-demand affiliate link generation\n\n## Effect-Idiomatic Patterns\n- PriceRuClient service with typed errors (RateLimitError, ApiError, NetworkError)\n- Exponential backoff retry with Schedule\n- Layer composition with config (partner_id, region_id)\n- Pipeline registration for scheduled updates","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-25T19:23:47.20429+01:00","updated_at":"2025-12-26T00:38:19.406856+01:00","closed_at":"2025-12-26T00:38:19.406856+01:00"}
{"id":"cod-if0.1","title":"Phase 1: PriceRuClient service with Effect","description":"Create the core API client service for price.ru.\n\n## Files\n- \\`apps/scraper/src/sources/price_ru/client.ts\\`\n- \\`apps/scraper/src/sources/price_ru/errors.ts\\`\n- \\`apps/scraper/src/sources/price_ru/types.ts\\`\n\n## Types (types.ts)\n\\`\\`\\`typescript\ninterface PriceRuConfig {\n  partnerId: string;\n  regionId: number;\n  baseUrl: string;\n}\n\ninterface PriceRuOffer {\n  id: number;\n  name: string;\n  modelId: number;\n  price: number;\n  clickUrl: string;\n  redirectTarget: 'to_merchant' | 'to_price';\n  shopInfo: { id: number; name: string };\n  availability: string;\n  variantKey?: string;\n  variantLabel?: string;\n}\n\ninterface PriceRuModel {\n  id: number;\n  name: string;\n  slug: string;\n  priceInfo: { min: number; max: number; avg: number };\n  offerCount: number;\n}\n\ninterface SearchOffersParams {\n  query: string;\n  categoryId?: string;\n  perPage?: number;\n}\n\\`\\`\\`\n\n## Errors (errors.ts)\n\\`\\`\\`typescript\nclass PriceRuApiError extends Data.TaggedError('PriceRuApiError')\u003c{\n  status: number;\n  message: string;\n  endpoint: string;\n}\u003e {}\n\nclass PriceRuNetworkError extends Data.TaggedError('PriceRuNetworkError')\u003c{\n  message: string;\n  cause?: unknown;\n}\u003e {}\n\nclass PriceRuRateLimitError extends Data.TaggedError('PriceRuRateLimitError')\u003c{\n  retryAfter?: number;\n}\u003e {}\n\\`\\`\\`\n\n## Service Interface (client.ts)\n\\`\\`\\`typescript\ninterface PriceRuClient {\n  searchOffers: (params: SearchOffersParams) =\u003e Effect\u003cPriceRuOffer[], PriceRuError\u003e;\n  getModel: (modelId: number) =\u003e Effect\u003cPriceRuModel | null, PriceRuError\u003e;\n}\n\nconst PriceRuClient = Context.GenericTag\u003cPriceRuClient\u003e('PriceRuClient');\n\nconst PriceRuClientLive = Layer.effect(\n  PriceRuClient,\n  Effect.gen(function* () {\n    const config = yield* PriceRuConfig;\n    \n    const request = \u003cT\u003e(endpoint: string, options?: RequestInit) =\u003e\n      Effect.tryPromise({\n        try: () =\u003e fetch(\\`${config.baseUrl}${endpoint}\\`, options).then(r =\u003e r.json()),\n        catch: (e) =\u003e new PriceRuNetworkError({ message: String(e), cause: e }),\n      }).pipe(\n        Effect.retry({\n          schedule: Schedule.exponential('500 millis').pipe(\n            Schedule.compose(Schedule.recurs(3))\n          ),\n          while: (e) =\u003e e._tag === 'PriceRuNetworkError',\n        })\n      );\n\n    return {\n      searchOffers: (params) =\u003e // ... implementation,\n      getModel: (modelId) =\u003e // ... implementation,\n    };\n  })\n);\n\\`\\`\\`\n\n## Variant Extraction\nParse variant from offer name:\n- 'Samsung Galaxy S24 Ultra 12/512Gb (Titanium Gray)' → { ram: 12, storage: 512, color: 'gray' }\n- Generate canonical variant_key: '12/512' or '12/512|gray'","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T19:24:10.662513+01:00","updated_at":"2025-12-26T00:38:19.40351+01:00","closed_at":"2025-12-26T00:38:19.40351+01:00","dependencies":[{"issue_id":"cod-if0.1","depends_on_id":"cod-if0","type":"parent-child","created_at":"2025-12-25T19:24:10.66301+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-if0.2","title":"Phase 2: Device linking via WebSocket","description":"Add WebSocket handlers for linking devices to price.ru models.\n\n## Files\n- \\`apps/scraper/src/sources/price_ru/index.ts\\` (export all)\n- \\`apps/scraper/src/routes/ws-server.ts\\` (add handlers)\n- \\`packages/scraper-protocol/src/messages.ts\\` (add message types)\n\n## WebSocket Handlers\n\n### priceru.search\nSearch for price.ru models to link to a device.\n\\`\\`\\`typescript\n{\n  method: 'priceru.search',\n  params: { query: string; deviceId?: string }\n}\n// Returns: { models: Array\u003c{ modelId, name, priceInfo, variantLabel }\u003e }\n\\`\\`\\`\n\n### priceru.link\nLink a device to a price.ru model_id.\n\\`\\`\\`typescript\n{\n  method: 'priceru.link',\n  params: { deviceId: string; modelId: number; variantKey?: string }\n}\n// Creates device_sources row:\n// - source: 'price_ru'\n// - external_id: modelId (as string)\n// - metadata: { variant_key, model_name, linked_at }\n\\`\\`\\`\n\n### priceru.unlink\nRemove a price.ru link.\n\\`\\`\\`typescript\n{\n  method: 'priceru.unlink',\n  params: { deviceId: string; modelId: number }\n}\n\\`\\`\\`\n\n## Protocol Types\n\\`\\`\\`typescript\nclass PriceRuSearchParams extends Schema.Class\u003c...\u003e('PriceRuSearchParams')({\n  query: Schema.String,\n  deviceId: Schema.optional(Schema.String),\n}) {}\n\nclass PriceRuSearchResult extends Schema.Class\u003c...\u003e('PriceRuSearchResult')({\n  models: Schema.Array(Schema.Struct({\n    modelId: Schema.Number,\n    name: Schema.String,\n    priceMin: Schema.Number,\n    priceMax: Schema.Number,\n    variantLabel: Schema.optional(Schema.String),\n  })),\n}) {}\n\nclass PriceRuLinkParams extends Schema.Class\u003c...\u003e('PriceRuLinkParams')({\n  deviceId: Schema.String,\n  modelId: Schema.Number,\n  variantKey: Schema.optional(Schema.String),\n}) {}\n\\`\\`\\`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T19:24:27.496081+01:00","updated_at":"2025-12-26T00:38:19.405713+01:00","closed_at":"2025-12-26T00:38:19.405713+01:00","dependencies":[{"issue_id":"cod-if0.2","depends_on_id":"cod-if0","type":"parent-child","created_at":"2025-12-25T19:24:27.496703+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-ipk","title":"Add widget_model_mappings table","description":"Create widget_model_mappings table to map WordPress widget model names to device slugs. Columns: raw_model, normalized_model, device_id, confidence, status, override_category_id, locked, created_at, updated_at.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T19:39:11.948984+01:00","updated_at":"2026-01-08T19:41:53.085976+01:00","closed_at":"2026-01-08T19:41:53.085976+01:00","close_reason":"Added widget_model_mappings table with indexes","dependencies":[{"issue_id":"cod-ipk","depends_on_id":"cod-63k","type":"parent-child","created_at":"2026-01-08T19:39:31.68471+01:00","created_by":"daemon"}]}
{"id":"cod-jsz","title":"UI: Status tabs and mapping status in table","description":"Add status filter tabs to WidgetDebug: All | Needs Review (pending+suggested) | Auto-confirmed | Confirmed | Ignored. Show mapping status badge per row. Update stats to show counts per status. Sort Needs Review by usage_count desc, confidence asc.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T20:08:46.098819+01:00","updated_at":"2026-01-08T20:31:45.410021+01:00","closed_at":"2026-01-08T20:31:45.410021+01:00","close_reason":"Added status filter tabs (All/Needs Review/Auto-confirmed/Confirmed/Ignored), color-coded status badges, updated stats cards","dependencies":[{"issue_id":"cod-jsz","depends_on_id":"cod-g7x","type":"parent-child","created_at":"2026-01-08T20:09:08.3979+01:00","created_by":"daemon"},{"issue_id":"cod-jsz","depends_on_id":"cod-bu2","type":"blocks","created_at":"2026-01-08T20:09:31.079753+01:00","created_by":"daemon"}]}
{"id":"cod-jw1","title":"Epic: Multi-source REST API Refactor","description":"Refactor legacy /api/scrape/* and /api/phone-data/* endpoints to multi-source architecture. \n\n## Problem\n- Current DELETE /api/scrape/html/:slug only clears job_queue, not raw_html\n- Endpoints are kimovil-specific, don't scale to multiple sources\n- Bulk clears send 500 individual requests causing SQLite contention\n- Frontend expects different behavior than backend provides\n\n## Goals\n- Device-centric REST API: /api/v2/devices/:slug/...\n- Source and data_kind as explicit path/query params\n- Bulk operations via unified jobs API\n- Fix clear endpoints to actually delete data\n\n## Shared Contract\nSee design field for endpoint specifications.","design":"## API v2 Endpoints\n\n### Device Data Access\n- GET    /api/v2/devices/:slug/sources/:source/html\n- DELETE /api/v2/devices/:slug/sources/:source/html\n- GET    /api/v2/devices/:slug/sources/:source/raw-data/:dataKind\n- DELETE /api/v2/devices/:slug/sources/:source/raw-data/:dataKind\n- GET    /api/v2/devices/:slug/data/:dataKind\n- DELETE /api/v2/devices/:slug/data/:dataKind\n\n### Bulk Status\n- GET /api/v2/devices/bulk-status?slugs=a,b,c\u0026source=...\n\n### Bulk Operations via Jobs\nPOST /api/v2/jobs with job_type:\n- scrape, process_raw, process_ai (existing)\n- clear_html, clear_raw, clear_processed (new)\n\nBody: { job_type, source?, data_kind?, device_slugs: [], filter? }\n\n### Legacy Mapping\n- GET/DELETE /api/scrape/html/:slug → /api/v2/devices/:slug/sources/kimovil/html\n- GET /api/phone-data/raw/:slug → /api/v2/devices/:slug/sources/kimovil/raw-data/specs\n- GET /api/phone-data/:slug → /api/v2/devices/:slug/data/specs\n- GET /api/scrape/status?slugs= → /api/v2/devices/bulk-status?slugs=\n- POST /api/bulk/start → POST /api/v2/jobs\n\n## Implementation Phases\n1. Backend: Add v2 routes + fix clear logic + add bulk clear job types\n2. Frontend: Update API calls to use v2 endpoints\n3. Deprecate legacy endpoints (keep working for now)","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-25T01:26:47.354411+01:00","updated_at":"2025-12-25T01:47:04.581079+01:00","closed_at":"2025-12-25T01:47:04.581079+01:00"}
{"id":"cod-k0k","title":"Widget: Bruno collection card","description":"Add Bruno API collection for widget endpoints.\n\n## Deliverables\n1. bruno-collection/widget/ folder\n2. Get Price Widget.bru - GET /widget/v1/price/:slug\n3. Invalidate Widget.bru - POST /widget/v1/invalidate/:slug\n4. Invalidate All Widgets.bru - POST /widget/v1/invalidate\n\n## Test Assertions\n- Status 200\n- Content-Type includes text/html\n- Body contains widget container class\n- Cache-Control header present","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-08T18:16:23.736484+01:00","updated_at":"2026-01-08T18:44:35.581012+01:00","closed_at":"2026-01-08T18:44:35.581012+01:00","close_reason":"Created Bruno collection for widget API","dependencies":[{"issue_id":"cod-k0k","depends_on_id":"cod-1qq","type":"parent-child","created_at":"2026-01-08T18:16:39.039514+01:00","created_by":"daemon"},{"issue_id":"cod-k0k","depends_on_id":"cod-ecc","type":"blocks","created_at":"2026-01-08T18:16:49.625067+01:00","created_by":"daemon"}]}
{"id":"cod-kmt","title":"Schema: wp_posts_cache and wordpress_widget_cache tables","description":"Create SQLite tables for caching WordPress widget data","design":"Tables:\n1. sync_state (source PK, last_synced_modified_gmt, last_run_at)\n2. wp_posts_cache (post_id PK, title, slug, status, post_date_gmt, post_modified_gmt, content_hash, content_rendered, synced_at)\n3. wordpress_widget_cache (id, post_id, search_text, occurrence_index, post_date_gmt, post_modified_gmt, synced_at)\n\nIndexes:\n- idx_widget_period (post_date_gmt, search_text)\n- idx_widget_post (post_id)\n- idx_posts_modified (post_modified_gmt)\n- idx_posts_date (post_date_gmt)","acceptance_criteria":"- [ ] Tables created in schema.ts\n- [ ] Auto-migrate on startup\n- [ ] Indexes for efficient period queries","notes":"COMPLETED: Added sync_state, wp_posts_cache, wordpress_widget_cache tables to schema.ts with indexes for period queries","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T19:43:37.599648+01:00","updated_at":"2026-01-08T19:45:44.872569+01:00","closed_at":"2026-01-08T19:45:44.872572+01:00","dependencies":[{"issue_id":"cod-kmt","depends_on_id":"cod-3aw","type":"parent-child","created_at":"2026-01-08T19:44:11.050967+01:00","created_by":"daemon"}]}
{"id":"cod-li6","title":"Phase 4: Job Queue Extensions","description":"Extend job queue with source + dataKind awareness and implement pipeline registry.\n\n## JobQueueService changes:\n- Add source, dataKind to Job and JobQueueItem types\n- Extend createJob, enqueueJobSlugs with source/dataKind params\n- Add claimNextByPipeline(source, dataKind, jobType)\n\n## Pipeline Registry:\n\\`\\`\\`typescript\ninterface PipelineDefinition {\n  source: string;\n  dataKind: DataKind;\n  stages: Record\u003cPipelineStage, StageHandler\u003e;\n}\n\nconst pipelineRegistry = new Map\u003cstring, PipelineDefinition\u003e();\nconst registerPipeline = (def: PipelineDefinition) =\u003e ...\nconst getPipeline = (source, dataKind) =\u003e ...\n\\`\\`\\`\n\n## Worker updates:\n- Lookup pipeline by source + dataKind\n- Build PipelineContext and execute stage handler\n\n## Files:\n- apps/scraper/src/services/job-queue.ts\n- apps/scraper/src/pipeline/registry.ts (new)\n- apps/scraper/src/pipeline/context.ts (new)\n\nEstimated: 2-3 days","acceptance_criteria":"- [ ] Job/JobQueueItem types extended with source/dataKind\n- [ ] Pipeline registry implemented\n- [ ] Workers use pipeline registry for dispatch\n- [ ] Backward compatible (defaults to kimovil/specs)\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:40.986329+01:00","updated_at":"2025-12-21T05:00:23.031041+01:00","closed_at":"2025-12-21T05:00:23.031041+01:00","dependencies":[{"issue_id":"cod-li6","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.398203+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-li6","depends_on_id":"cod-3hz","type":"blocks","created_at":"2025-12-21T04:41:19.077658+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-lxv","title":"Phase 2: Migrate callers to DeviceRegistryService","description":"Update all callers that use DeviceService for device storage to use DeviceRegistryService instead.\n\nChanges needed:\n1. ws-server.ts bulk.start: Use deviceRegistry.getDevicesBySource('kimovil') instead of deviceService.getAllDevices()\n2. ws-server.ts yandex.link: Remove fallback to kimovil_devices (migration already done)\n3. slug-crawler.ts: Add DeviceRegistryService dependency\n   - loadKnownSlugs() → use deviceRegistry.getDevicesBySource('kimovil')\n   - processPrefix() → replace upsertDevice() with createDevice() + linkDeviceToSource()\n   - getCrawlStats() → use deviceRegistry.getDeviceCount()\n   - Add DeviceRegistryError to error union\n4. debug.ts: Update to use DeviceRegistryService for device queries\n\n~80 lines changed.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-25T17:57:59.640927+01:00","updated_at":"2025-12-25T18:15:29.887844+01:00","closed_at":"2025-12-25T18:15:29.887844+01:00","dependencies":[{"issue_id":"cod-lxv","depends_on_id":"cod-qda","type":"parent-child","created_at":"2025-12-25T17:58:19.818674+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-lxv","depends_on_id":"cod-1o8","type":"blocks","created_at":"2025-12-25T17:58:26.453427+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-mqu","title":"Phase 3: Modify SearchServiceKimovil to use BrowserService","description":"Replace HttpClient dependency with BrowserService. Use withPersistentStealthPage + page.evaluate(fetch) to call Kimovil API from page context. Keep existing Stream\u003cSearchEvent|SearchResult\u003e API and retry logic.","acceptance_criteria":"- [ ] SearchServiceKimovil depends on BrowserService (not HttpClient)\n- [ ] API call via page.evaluate(fetch(...))\n- [ ] Existing retry logic preserved\n- [ ] Stream API unchanged\n- [ ] live.ts updated to provide BrowserServiceLive to SearchServiceLayer\n- [ ] npm run check-types passes\n- [ ] Search works end-to-end (manual test)","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:38:56.65028+01:00","updated_at":"2025-12-21T17:49:17.57929+01:00","closed_at":"2025-12-21T17:49:17.57929+01:00","dependencies":[{"issue_id":"cod-mqu","depends_on_id":"cod-3a9","type":"parent-child","created_at":"2025-12-21T17:39:10.513827+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-mqu","depends_on_id":"cod-2i2","type":"blocks","created_at":"2025-12-21T17:39:23.099275+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-nah","title":"Phase 4: Integration \u0026 Cleanup","description":"Wire everything together in Slugs.tsx and clean up.\n\n## Deliverables\n1. DevicesTableProvider wrapped in Slugs.tsx\n2. Remove prop drilling, unused handlers\n3. Keyboard navigation (arrow keys, space to select)\n4. Final testing and polish\n\n## Acceptance Criteria\n- [ ] Slugs.tsx uses provider pattern\n- [ ] No unused props/handlers remain\n- [ ] Arrow keys navigate rows\n- [ ] Space toggles selection\n- [ ] Full flow works: search, filter, select, actions\n- [ ] Build passes","design":"\n## Provider Integration\n\u003cDevicesTableProvider\n  search={search}\n  filter={filter}\n  limit={limit}\n  onOpenModal={setModalSlug}\n\u003e\n  \u003cDevicesTable /\u003e\n  \u003cSelectionBar /\u003e\n\u003c/DevicesTableProvider\u003e\n\n## Keyboard Navigation\n- ArrowUp/Down: move focus\n- Space: toggle selection\n- Shift+ArrowUp/Down: extend selection\n- Escape: clear selection\n\n## Cleanup\n- Remove unused props from DevicesTableProps\n- Remove handlers moved to context\n- Update any remaining direct useSlugsApi consumers","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T17:16:18.154738+01:00","updated_at":"2025-12-23T17:52:43.032979+01:00","closed_at":"2025-12-23T17:52:43.032979+01:00","dependencies":[{"issue_id":"cod-nah","depends_on_id":"cod-b06","type":"parent-child","created_at":"2025-12-23T17:16:44.781069+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-nzz","title":"Add price API methods to useSlugsApi hook","description":"Add REST API calls for fetching price data from the backend.","design":"Add fetchPrices(deviceId) calling GET /api/prices/:deviceId. Add fetchPriceHistory(deviceId, days) calling GET /api/prices/:deviceId/history. Return typed responses.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T03:08:50.738103+01:00","updated_at":"2025-12-22T03:13:49.8017+01:00","closed_at":"2025-12-22T03:13:49.8017+01:00","dependencies":[{"issue_id":"cod-nzz","depends_on_id":"cod-a1z","type":"blocks","created_at":"2025-12-22T03:08:59.70924+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-nzz","depends_on_id":"cod-3xb","type":"parent-child","created_at":"2025-12-22T03:09:07.691906+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-on0","title":"Migrate Kimovil jobs to pipeline architecture","description":"Kimovil jobs (scrape, process_raw, process_ai) use direct service calls in bulk-job.ts instead of the pipeline registry system. Should be migrated for consistency with price_ru/yandex sources.","design":"1. Implement real handlers in kimovil/specs-pipeline.ts (currently stubs)\\n2. Update bulk-job.ts to route kimovil:specs through getStageHandler\\n3. Test all three stages work correctly\\n4. Remove legacy direct call code paths","status":"open","priority":3,"issue_type":"chore","created_at":"2025-12-26T00:11:57.844471+01:00","updated_at":"2025-12-26T00:11:57.844471+01:00"}
{"id":"cod-pgg","title":"Phase 1: Schema Extensions","description":"Add source/data_kind columns to existing tables and create new tables.\n\n## Tables to modify:\n- jobs: ADD source TEXT DEFAULT 'kimovil', data_kind TEXT DEFAULT 'specs'\n- job_queue: ADD source TEXT DEFAULT 'kimovil', data_kind TEXT DEFAULT 'specs', scrape_id INTEGER\n- raw_html: ADD scrape_id INTEGER\n- scrape_verification: ADD scrape_id INTEGER\n\n## New tables:\n- devices (id, slug, name, brand, created_at, updated_at)\n- device_sources (device_id, source, external_id, url, status, first_seen, last_seen)\n- scrapes (id, device_id, source, data_kind, external_id, url, requested_at, started_at, completed_at, status, error_message)\n- entity_data_raw (id, device_id, source, data_kind, scrape_id, data, created_at, updated_at)\n- entity_data (id, device_id, data_kind, data, created_at, updated_at)\n- price_quotes (id, device_id, source, seller, price_minor_units, currency, url, scraped_at, scrape_id, is_available)\n- price_summary (device_id, min_price, max_price, currency, updated_at)\n\n## Files:\n- apps/scraper/src/sql/schema.ts\n\nEstimated: 1-2 days","acceptance_criteria":"- [ ] All ALTER TABLE migrations run without error\n- [ ] New tables created with indexes\n- [ ] Defaults preserve backward compatibility\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:09.338913+01:00","updated_at":"2025-12-21T04:47:19.772919+01:00","closed_at":"2025-12-21T04:47:19.772919+01:00","dependencies":[{"issue_id":"cod-pgg","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.30202+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pgg","depends_on_id":"cod-26h","type":"blocks","created_at":"2025-12-21T04:41:18.984493+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pr6","title":"Update AI service and UI for cpuCoreClusters + rename to RobotService","description":"AI service needs updates after cpuCoreClusters addition. Also rename OpenAIService to RobotService and improve error handling/progress in web UI when processing AI from modal.","design":"1. Rename openai.ts to robot.ts, OpenAIService to RobotService, OpenAIError to RobotError\n2. Update validateAndMerge to include cpuCoreClusters field\n3. Improve PhoneDataModal to show progress/errors during AI processing (not just spinner)\n4. Update all imports and references across codebase","acceptance_criteria":"- [ ] openai.ts renamed to robot.ts\n- [ ] OpenAIService → RobotService everywhere\n- [ ] OpenAIError → RobotError\n- [ ] cpuCoreClusters passed through to final PhoneData\n- [ ] PhoneDataModal shows error messages on AI failure\n- [ ] Type checks pass","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-21T22:36:43.079116+01:00","updated_at":"2025-12-21T22:43:27.393549+01:00","closed_at":"2025-12-21T22:43:27.393549+01:00"}
{"id":"cod-pt7","title":"Epic: Unified Effect + SQL Migration","description":"Migrate to @effect/sql + idiomatic Effect patterns. Combines Epic 2 (Effect patterns) with Schema Refactor.\n\n## Goals\n- Replace raw better-sqlite3 with @effect/sql\n- Eliminate Effect.runPromise escapes\n- Add proper resource management (acquireRelease)\n- Domain models with Model.Class\n- Quarantine table for corrupted data\n- Structured logging\n\n## Constraints\n- App not live (can go offline, change schema freely)\n- No external DB consumers\n- ~50 writes/sec peak\n- Fail fast + quarantine corrupted data\n- Model.Class for DB entities only\n- Backup restore acceptable\n\n## Estimated Effort\n1.5-2 days\n\n## Reference\nSee REFACTOR_PLAN_V2.md for full details","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-21T00:32:25.806026+01:00","updated_at":"2025-12-25T18:31:07.404137+01:00","closed_at":"2025-12-25T18:31:07.404137+01:00"}
{"id":"cod-pt7.1","title":"Phase 0: Browser Resource Management","description":"Fix browser leak before touching DB. Isolated change that reduces flakes during later work.\n\n## Tasks\n- Add Effect.acquireRelease to BrowserService.createBrowser()\n- Add Effect.acquireRelease to BrowserService.createLocalBrowser()\n- Update callers to use Effect.scoped\n- Verify no browser processes leak after scrape errors\n\n## Files\n- apps/scraper/src/services/browser.ts\n- apps/scraper/src/services/scrape-kimovil.ts\n- apps/scraper/src/services/bulk-job.ts\n\n## Pattern\n```typescript\nconst withBrowser = Effect.acquireRelease(\n  browserService.createBrowser(),\n  (browser) =\u003e Effect.promise(() =\u003e browser.close())\n);\n\n// Usage\nEffect.scoped(\n  Effect.gen(function* () {\n    const browser = yield* withBrowser;\n    // use browser...\n  })\n); // browser.close() called automatically\n```\n\n## Verification\n- Run scrape, kill mid-way, check no orphan Chrome processes\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:32:39.426645+01:00","updated_at":"2025-12-21T01:40:11.774452+01:00","closed_at":"2025-12-21T01:40:11.774452+01:00","dependencies":[{"issue_id":"cod-pt7.1","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:32:39.42709+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.10","title":"Phase 9: Update AI Service","description":"Use domain models, eliminate runPromise escapes.\n\n## Tasks\n- Import Phone schema from @repo/scraper-domain\n- Delete duplicate schemas (NormalizedDataSchema, CameraSchema, etc.)\n- Keep Vercel AI SDK (@ai-sdk/google) - don't switch\n- Wrap AI calls in Effect.tryPromise\n- Return typed Effect, not Promise\n\n## Pattern\n```typescript\nconst adaptScrapedData = (rawData: Record\u003cstring, unknown\u003e) =\u003e\n  Effect.tryPromise({\n    try: () =\u003e generateObject({\n      model: google('gemini-2.0-flash'),\n      schema: PhoneSchema,  // From @repo/scraper-domain\n      prompt: buildPrompt(rawData),\n    }),\n    catch: (e) =\u003e new AiError({ cause: e }),\n  }).pipe(\n    Effect.map(result =\u003e result.object),\n    Effect.retry(Schedule.exponential('1 second').pipe(\n      Schedule.compose(Schedule.recurs(3))\n    ))\n  );\n```\n\n## Files\n- apps/scraper/src/services/openai.ts\n\n## Verification\n- AI normalization works end-to-end\n- No duplicate schema definitions\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:34:15.906759+01:00","updated_at":"2025-12-21T02:09:26.708511+01:00","closed_at":"2025-12-21T02:09:26.708511+01:00","dependencies":[{"issue_id":"cod-pt7.10","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:15.907295+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.10","depends_on_id":"cod-pt7.9","type":"blocks","created_at":"2025-12-21T00:35:34.926815+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.11","title":"Phase 10: Update Scrape Service","description":"Use new repositories, eliminate runPromise escapes.\n\n## Tasks\n- Update scrape-kimovil.ts to use new PhoneRepo\n- Replace Effect.runPromise calls with yield*\n- Use Effect.acquireRelease for page lifecycle\n- Stay in Effect context throughout\n\n## Before/After\n```typescript\n// Before\nconst html = await Effect.runPromise(htmlCache.getRawHtml(slug));\nconst browser = await Effect.runPromise(browserService.createBrowser());\n\n// After\nconst html = yield* htmlCache.getRawHtml(slug);\nconst browser = yield* Effect.scoped(withBrowser);\n```\n\n## Key Changes\n- scrape() returns Effect.Effect, not Promise\n- scrapeFast() returns Effect.Effect, not Promise\n- All internal calls use yield*, not await + runPromise\n- Page lifecycle managed with acquireRelease\n\n## Files\n- apps/scraper/src/services/scrape-kimovil.ts\n\n## Verification\n- Full scrape works end-to-end\n- No Effect.runPromise in service code\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-21T00:34:25.285122+01:00","updated_at":"2025-12-21T02:18:18.242749+01:00","closed_at":"2025-12-21T02:18:18.242749+01:00","dependencies":[{"issue_id":"cod-pt7.11","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:25.285575+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.11","depends_on_id":"cod-pt7.9","type":"blocks","created_at":"2025-12-21T00:35:34.961481+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.12","title":"Phase 11: Frontend Types","description":"Share types with frontend without adding @effect/schema dependency.\n\n## Tasks\n- Export plain TS types derived from domain models\n- Update frontend to import from @repo/scraper-domain\n- Remove duplicate type definitions in frontend\n\n## Pattern\n```typescript\n// @repo/scraper-domain/index.ts\nimport type { Phone as PhoneModel } from './models/phone';\n\n// Re-export as plain type (strips runtime Schema parts)\nexport type Phone = PhoneModel;\nexport type Camera = PhoneModel['cameras'][number];\n```\n\n## Files\n- packages/scraper-domain/src/index.ts (update exports)\n- apps/ws-web/src/pages/slugs/types.ts (simplify/remove)\n\n## Verification\n- Frontend builds without @effect/schema\n- Types match between backend and frontend\n- npm run check-types passes","status":"closed","priority":3,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-21T00:34:33.845849+01:00","updated_at":"2025-12-21T02:21:48.92588+01:00","closed_at":"2025-12-21T02:21:48.92588+01:00","dependencies":[{"issue_id":"cod-pt7.12","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:33.846277+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.12","depends_on_id":"cod-pt7.10","type":"blocks","created_at":"2025-12-21T00:35:34.993111+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.12","depends_on_id":"cod-pt7.11","type":"blocks","created_at":"2025-12-21T00:35:35.024877+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.13","title":"Phase 12: Structured Logging","description":"Replace console.log with Effect.log*.\n\n## Tasks\n- Replace console.log -\u003e Effect.logInfo\n- Replace console.warn -\u003e Effect.logWarning  \n- Replace console.error -\u003e Effect.logError\n- Add structured annotations where useful\n- Configure log output format\n\n## Pattern\n```typescript\n// Before\nconsole.log(`[HtmlCache] Saved raw HTML for slug: ${slug}`);\n\n// After\nyield* Effect.logInfo('Saved raw HTML').pipe(\n  Effect.annotateLogs({ service: 'HtmlCache', slug })\n);\n```\n\n## Benefits\n- Log levels (debug, info, warn, error)\n- Structured metadata (JSON-friendly)\n- Configurable at runtime\n- Testable (can capture logs)\n\n## Files\n- All service files\n- apps/scraper/src/utils/logger.ts (may delete or adapt)\n\n## Verification\n- Logs appear with proper levels\n- npm run check-types passes","status":"closed","priority":3,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:34:42.763019+01:00","updated_at":"2025-12-21T02:26:38.009441+01:00","closed_at":"2025-12-21T02:26:38.009441+01:00","dependencies":[{"issue_id":"cod-pt7.13","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:42.763481+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.13","depends_on_id":"cod-pt7.12","type":"blocks","created_at":"2025-12-21T00:35:35.056954+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.14","title":"Phase 13: Effect.Stream for WebSocket (Optional)","description":"Replace AsyncGenerator with Effect.Stream for better backpressure.\n\n## Tasks\n- Convert scrape progress events to Stream.Stream\n- Update WebSocket handler to consume stream\n- Add cancellation via Fiber interruption\n\n## Pattern\n```typescript\n// Before\nasync function* runScrape(): AsyncGenerator\u003cScrapeEvent\u003e {\n  yield { type: 'progress', stage: 'browser', progress: 0 };\n  // ...\n}\n\n// After  \nconst runScrape: Stream.Stream\u003cScrapeEvent, ScrapeError, ScrapeService\u003e =\n  Stream.gen(function* () {\n    yield* Stream.emit({ type: 'progress', stage: 'browser', progress: 0 });\n    // ...\n  });\n```\n\n## Benefits\n- Backpressure handling\n- Cancellation via Fiber interruption\n- Composable with other streams\n- Error typing\n\n## Files\n- apps/scraper/src/services/scrape-kimovil.ts\n- apps/scraper/src/routes/ws.ts\n\n## Verification\n- WebSocket progress works\n- Cancellation works\n- npm run check-types passes\n\n## Note\nThis phase is optional - can be deferred if time-constrained.","status":"closed","priority":3,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-21T00:34:51.707317+01:00","updated_at":"2025-12-25T18:31:01.473092+01:00","closed_at":"2025-12-25T18:31:01.473092+01:00","dependencies":[{"issue_id":"cod-pt7.14","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:51.707795+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.14","depends_on_id":"cod-pt7.13","type":"blocks","created_at":"2025-12-21T00:35:35.089457+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.2","title":"Phase 1: Install Packages + Test Harness","description":"Set up @effect/sql and testing infrastructure.\n\n## Tasks\n- Add @effect/sql, @effect/sql-sqlite-node to apps/scraper\n- Add @effect/vitest to dev dependencies\n- Create test harness with temp SQLite DB\n- Write one smoke test proving harness works\n\n## Files\n- apps/scraper/package.json\n- apps/scraper/src/test/setup.ts (new)\n- apps/scraper/src/test/smoke.test.ts (new)\n\n## Test Harness Pattern\n```typescript\n// setup.ts\nimport { SqliteClient } from '@effect/sql-sqlite-node';\n\nexport const TestDbLayer = SqliteClient.layer({\n  filename: ':memory:',\n});\n\nexport const withTestDb = \u003cA, E\u003e(\n  effect: Effect.Effect\u003cA, E, SqlClient\u003e\n) =\u003e effect.pipe(\n  Effect.provide(TestDbLayer),\n  Effect.scoped\n);\n```\n\n## Verification\n- bun test runs and passes\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-21T00:32:52.909917+01:00","updated_at":"2025-12-21T01:40:11.963213+01:00","closed_at":"2025-12-21T01:40:11.963213+01:00","dependencies":[{"issue_id":"cod-pt7.2","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:32:52.9105+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.3","title":"Phase 2: SqlClient Layer + Quarantine","description":"Replace DatabaseService with @effect/sql SqlClient, add quarantine infrastructure.\n\n## Tasks\n- Create apps/scraper/src/sql/client.ts with SqlClient layer\n- Configure WAL mode, busy timeout (for ~50 writes/sec), statement cache\n- Migrate schema initialization to new client\n- Create quarantine table for corrupted data\n- Create quarantine helper: quarantine(slug, sourceTable, data, error)\n- Delete old services/db.ts\n- Update layers/live.ts\n\n## Quarantine Schema\n```sql\nCREATE TABLE IF NOT EXISTS quarantine (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  slug TEXT NOT NULL,\n  source_table TEXT NOT NULL,\n  data TEXT NOT NULL,\n  error TEXT NOT NULL,\n  quarantined_at INTEGER NOT NULL DEFAULT (unixepoch())\n);\nCREATE INDEX idx_quarantine_slug ON quarantine(slug);\nCREATE INDEX idx_quarantine_source ON quarantine(source_table);\n```\n\n## Files\n- apps/scraper/src/sql/client.ts (new)\n- apps/scraper/src/sql/quarantine.ts (new)\n- apps/scraper/src/sql/schema.ts (new)\n- apps/scraper/src/services/db.ts (delete)\n- apps/scraper/src/layers/live.ts (update)\n\n## Verification\n- App starts with new SqlClient\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:06.211541+01:00","updated_at":"2025-12-21T01:43:22.271472+01:00","closed_at":"2025-12-21T01:43:22.271472+01:00","dependencies":[{"issue_id":"cod-pt7.3","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:06.212243+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.3","depends_on_id":"cod-pt7.2","type":"blocks","created_at":"2025-12-21T00:35:34.598542+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.4","title":"Phase 3: Domain Models","description":"Create canonical domain models using Model.Class.\n\n## Tasks\n- Create Camera, Sku, Benchmark as Schema.Class (embedded types)\n- Create Phone as Model.Class with proper field types\n- Create RawPhone as Model.Class for pre-AI data\n- Use Model.JsonFromString for array fields\n- Use Model.BooleanFromNumber for SQLite booleans\n- Add createdAt, updatedAt timestamps\n- Export from @repo/scraper-domain\n\n## Model Pattern\n```typescript\nexport class Camera extends Schema.Class\u003cCamera\u003e('Camera')({\n  resolution_mp: Schema.Number,\n  aperture_fstop: Schema.NullOr(Schema.String),\n  sensor: Schema.NullOr(Schema.String),\n  type: CameraType,\n  features: Schema.Array(Schema.String),\n}) {}\n\nexport class Phone extends Model.Class\u003cPhone\u003e('Phone')({\n  slug: Schema.String,\n  name: Schema.String,\n  cameras: Model.JsonFromString(Schema.Array(Camera)),\n  nfc: Model.BooleanFromNumber,\n  createdAt: Model.DateTimeInsert,\n  updatedAt: Model.DateTimeUpdate,\n}) {}\n```\n\n## Files\n- packages/scraper-domain/src/models/phone.ts (new)\n- packages/scraper-domain/src/models/index.ts (new)\n- packages/scraper-domain/src/index.ts (update exports)\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:16.401696+01:00","updated_at":"2025-12-21T01:49:00.226416+01:00","closed_at":"2025-12-21T01:49:00.226416+01:00","dependencies":[{"issue_id":"cod-pt7.4","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:16.402118+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.4","depends_on_id":"cod-pt7.3","type":"blocks","created_at":"2025-12-21T00:35:34.632569+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.5","title":"Phase 4: Migrate PhoneDataService","description":"Migrate phone data storage to @effect/sql with Model + quarantine.\n\n## Tasks\n- Write integration tests for current PhoneDataService behavior\n- Create PhoneRepo using Model.makeRepository for basic CRUD\n- Keep custom queries hand-written (getSlugsNeedingAi, getSlugsNeedingExtraction)\n- Add Schema.decode with fail-fast + quarantine fallback\n- Update service internals, keep interface stable\n- Delete old implementation\n\n## Error Handling Pattern\n```typescript\nconst getPhone = (slug: string) =\u003e sql\u003cPhoneRow\u003e`\n  SELECT * FROM phone_data WHERE slug = ${slug}\n`.pipe(\n  Effect.flatMap(rows =\u003e rows[0] \n    ? Schema.decode(Phone)(rows[0])\n    : Effect.succeed(null)\n  ),\n  Effect.catchTag('ParseError', (e) =\u003e\n    quarantine(slug, 'phone_data', rows[0], e.message).pipe(\n      Effect.as(null)\n    )\n  )\n);\n```\n\n## Files\n- apps/scraper/src/test/phone-data.test.ts (new)\n- apps/scraper/src/repositories/phone.ts (new)\n- apps/scraper/src/services/phone-data.ts (rewrite internals)\n\n## Verification\n- All phone-data tests pass\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:26.366226+01:00","updated_at":"2025-12-21T02:02:10.029025+01:00","closed_at":"2025-12-21T02:02:10.029025+01:00","dependencies":[{"issue_id":"cod-pt7.5","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:26.367233+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.5","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.664561+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.6","title":"Phase 5: Migrate HtmlCacheService","description":"Migrate HTML cache to @effect/sql.\n\n## Tasks\n- Write integration tests for current HtmlCacheService behavior\n- Rewrite internals to use SqlClient\n- Keep interface stable\n- Add quarantine for corrupted verification records\n\n## Key Methods to Test\n- saveRawHtml(slug, html, source)\n- getRawHtml(slug, source)\n- getRawHtmlWithAge(slug, source)\n- recordVerification(slug, isCorrupted, reason)\n- getVerificationStatus(slug)\n- getCorruptedSlugs()\n- getValidSlugs()\n\n## Files\n- apps/scraper/src/test/html-cache.test.ts (new)\n- apps/scraper/src/services/html-cache.ts (rewrite internals)\n\n## Verification\n- All html-cache tests pass\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-21T00:33:32.625445+01:00","updated_at":"2025-12-21T02:02:10.215932+01:00","closed_at":"2025-12-21T02:02:10.215932+01:00","dependencies":[{"issue_id":"cod-pt7.6","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:32.625901+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.6","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.696791+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.7","title":"Phase 6: Migrate JobQueueService","description":"Migrate job queue to @effect/sql with explicit transactions.\n\n## Tasks\n- Write integration tests for queue behavior (ordering, retry, backoff)\n- Identify multi-step operations needing transactions\n- Rewrite internals to use SqlClient\n- Wrap transactional operations explicitly\n- Keep interface stable\n\n## Transactional Operations\n- claimNextQueueItem (SELECT + UPDATE in one transaction)\n- rescheduleQueueItem (UPDATE attempt + next_attempt_at)\n- enqueueJobSlugs (bulk INSERT)\n\n## Key Methods to Test\n- createJob(input)\n- getJob(id), getAllJobs()\n- enqueueJobSlugs(jobId, jobType, mode, slugs)\n- claimNextQueueItem(jobId) - must be atomic\n- completeQueueItem(id, error?)\n- rescheduleQueueItem(id, nextAttemptAt, error, errorCode)\n- getJobStats(id), getTimeoutStats(id)\n\n## Files\n- apps/scraper/src/test/job-queue.test.ts (new)\n- apps/scraper/src/services/job-queue.ts (rewrite internals)\n\n## Verification\n- All job-queue tests pass\n- Queue ordering/retry semantics unchanged\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:41.731196+01:00","updated_at":"2025-12-21T02:02:10.39989+01:00","closed_at":"2025-12-21T02:02:10.39989+01:00","dependencies":[{"issue_id":"cod-pt7.7","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:41.731666+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.7","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.730495+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.8","title":"Phase 7: Migrate DeviceService","description":"Migrate device storage to @effect/sql.\n\n## Tasks\n- Write integration tests for DeviceService\n- Create Device Model.Class if beneficial (or keep simple)\n- Rewrite internals to use SqlClient\n- Keep interface stable\n\n## Key Methods to Test\n- upsertDevice(device)\n- getDevice(slug)\n- getDeviceCount()\n- getAllDevices()\n- enqueuePrefix(prefix, depth)\n- getNextPendingPrefix()\n- markPrefixDone(prefix, resultCount)\n\n## Files\n- apps/scraper/src/test/device.test.ts (new)\n- apps/scraper/src/services/device.ts (rewrite internals)\n\n## Verification\n- All device tests pass\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:33:55.850655+01:00","updated_at":"2025-12-21T02:02:10.585224+01:00","closed_at":"2025-12-21T02:02:10.585224+01:00","dependencies":[{"issue_id":"cod-pt7.8","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:55.851095+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.8","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.762845+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-pt7.9","title":"Phase 8: Data Migration (Pipe to JSON)","description":"Convert pipe-delimited strings to JSON arrays.\n\n## Tasks\n- Create idempotent migration script\n- Add pre-check: count rows needing migration\n- Add post-check: count valid JSON rows\n- Backup DB before running\n- Run migration\n- Verify no data loss\n\n## Migration Logic\n```typescript\nconst needsMigration = (value: string) =\u003e {\n  if (!value) return false;\n  try { JSON.parse(value); return false; }  // Already JSON\n  catch { return value.includes('|'); }      // Pipe-delimited\n};\n\nconst migrate = (value: string) =\u003e \n  JSON.stringify(value.split('|').filter(Boolean));\n```\n\n## Fields to Migrate\n- aliases, images, materials, colors\n- displayFeatures, cpuCores, sim\n- cameraFeatures, others\n\n## Files\n- apps/scraper/src/migrations/001-pipe-to-json.ts (new)\n\n## Verification\n- Pre-check count matches post-check count\n- Random sample of migrated rows parse correctly\n- App reads migrated data without errors","status":"closed","priority":1,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-21T00:34:04.51097+01:00","updated_at":"2025-12-21T02:05:53.846096+01:00","closed_at":"2025-12-21T02:05:53.846096+01:00","dependencies":[{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:04.511464+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.5","type":"blocks","created_at":"2025-12-21T00:35:34.795495+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.6","type":"blocks","created_at":"2025-12-21T00:35:34.827669+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.7","type":"blocks","created_at":"2025-12-21T00:35:34.859748+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.8","type":"blocks","created_at":"2025-12-21T00:35:34.893089+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-qda","title":"Epic: Consolidate Device Services","description":"Eliminate dual-registry by making DeviceRegistryService the canonical device store. Rename DeviceService to KimovilPrefixService for prefix queue only. Estimated ~200 lines changed.","design":"3 phases: (1) Create shared generateDeviceId utility, (2) Migrate callers to use DeviceRegistryService, (3) Slim DeviceService to prefix-only and rename to KimovilPrefixService. Domain cleanup already done - no type conflicts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-25T17:57:39.234508+01:00","updated_at":"2026-01-08T18:02:14.035659+01:00","closed_at":"2026-01-08T18:02:14.035659+01:00","close_reason":"All 4 phases complete: generateDeviceId utility created, callers migrated, DeviceService renamed to KimovilPrefixService, legacy table dropped"}
{"id":"cod-r6c","title":"Widget: Tests for widget endpoint","description":"Create comprehensive tests for widget API using vitest.\n\n## Deliverables\n1. apps/scraper/src/test/widget.test.ts\n2. Test cases:\n   - Returns valid HTML for known device\n   - Returns 'not found' card for unknown slug\n   - Cache hit returns same content\n   - Invalidation clears cache\n   - arrowVariant changes output\n   - Response headers are correct\n   - HTML is XSS-safe (escaped content)\n   - Performance: \u003c10ms for cached response\n\n## Test Setup\n- Use existing runTest helper from setup.ts\n- Seed test device + price data\n- Mock time for TTL tests if needed","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-08T18:16:06.263299+01:00","updated_at":"2026-01-08T18:39:00.76644+01:00","closed_at":"2026-01-08T18:39:00.76644+01:00","close_reason":"Implemented 9 comprehensive widget tests - all passing","dependencies":[{"issue_id":"cod-r6c","depends_on_id":"cod-1qq","type":"parent-child","created_at":"2026-01-08T18:16:38.813041+01:00","created_by":"daemon"},{"issue_id":"cod-r6c","depends_on_id":"cod-ecc","type":"blocks","created_at":"2026-01-08T18:16:49.410478+01:00","created_by":"daemon"}]}
{"id":"cod-reb","title":"WordPress sync service","description":"Service to fetch and sync WordPress posts with widget data","design":"WordPressSyncService with:\n1. syncPosts() - incremental sync using modified_after\n2. extractWidgets(content) - regex extraction of searchText\n3. computeContentHash(content) - SHA-256 for change detection\n\nSync algorithm:\n1. Read last_synced_modified_gmt from sync_state\n2. Fetch posts with modified_after filter\n3. For each post: compare content_hash, skip if unchanged\n4. For changed posts: upsert wp_posts_cache, delete+reinsert widget rows\n5. Update sync_state with max modified_gmt","acceptance_criteria":"- [ ] Incremental sync works\n- [ ] Content hash change detection\n- [ ] Transaction safety for post+widget updates\n- [ ] Rate limiting for WP API calls","notes":"COMPLETED: Created WordPressSyncService with syncPosts(), getSyncStatus(), extractWidgets(). Added to LiveRuntime layer.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T19:43:46.901622+01:00","updated_at":"2026-01-08T19:47:59.770413+01:00","closed_at":"2026-01-08T19:47:59.770415+01:00","close_reason":"Implemented WordPressSyncService with syncPosts, getSyncStatus, extractWidgets methods. Added to LiveRuntime layer. Types verified.","dependencies":[{"issue_id":"cod-reb","depends_on_id":"cod-3aw","type":"parent-child","created_at":"2026-01-08T19:44:11.166036+01:00","created_by":"daemon"},{"issue_id":"cod-reb","depends_on_id":"cod-kmt","type":"blocks","created_at":"2026-01-08T19:44:31.968152+01:00","created_by":"daemon"}]}
{"id":"cod-rll","title":"Phase 2: Create PhoneDataService","description":"Create PhoneDataService to own phone data storage (raw + AI normalized).","design":"1. Create services/phone-data.ts\n2. Move from storage.ts: savePhoneDataRaw, getPhoneDataRaw, hasPhoneDataRaw, getPhoneDataRawCount\n3. Move: savePhoneData, getPhoneData, hasPhoneData, getPhoneDataCount\n4. Move: getPhoneDataRawBulk, getSlugsNeedingExtraction, getSlugsNeedingAi\n5. OpenAI service calls PhoneDataService to save results\n6. Update api.ts routes to use new service","acceptance_criteria":"- [ ] PhoneDataService created\n- [ ] All phone data methods moved\n- [ ] OpenAI/bulk-job uses new service for saving\n- [ ] API routes work correctly\n- [ ] Build passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T19:30:59.796622+01:00","updated_at":"2025-12-20T19:57:00.556503+01:00","closed_at":"2025-12-20T19:57:00.556503+01:00","dependencies":[{"issue_id":"cod-rll","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.863404+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-rll","depends_on_id":"cod-8np","type":"blocks","created_at":"2025-12-20T19:35:42.105534+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-rll","depends_on_id":"cod-co8","type":"blocks","created_at":"2025-12-20T19:35:42.137539+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-rll","depends_on_id":"cod-duf","type":"blocks","created_at":"2025-12-20T19:35:42.1665+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-s4i","title":"Phase 2: Scheduler daemon loop","description":"Implement the background scheduler fiber that polls for due schedules and triggers jobs.\n\n## Scheduler Loop\n- Effect.forever fiber started on app boot\n- Polls job_schedules for next_run_at \u003c= now AND enabled = 1\n- Claims schedule with locked_until for crash safety\n- Creates Job via JobQueueService\n- Enqueues work items\n- Starts BulkJobManager.runJob\n- Updates schedule state (last_run_at, last_status, next_run_at)\n\n## Croner Integration\n- Install croner package\n- Use only for computing next_run_at from cron expression\n- No in-memory scheduling\n\n## Crash Recovery\n- On startup, check for schedules with next_run_at in the past\n- Run once (not catch-up all missed)\n- Check if last_job_id is still running before creating new job\n\n## Files\n- apps/scraper/src/services/scheduler.ts (add loop + helpers)\n- apps/scraper/src/index.ts (start loop on boot)\n- package.json (add croner)","acceptance_criteria":"- [ ] Croner installed and used for next-run calculation\n- [ ] Scheduler loop implemented as Effect.forever fiber\n- [ ] Loop started on app boot (after resumeStuckJobs)\n- [ ] Schedule claiming with locked_until works\n- [ ] Job creation + BulkJobManager integration works\n- [ ] Crash recovery handles missed schedules\n- [ ] npm run build passes\n- [ ] npm run check-types passes","notes":"COMPLETED: Phase 2 - Scheduler daemon loop\n\nCHANGES:\n- Installed croner for cron expression parsing\n- Added loop methods: getDueSchedules, claimSchedule, releaseSchedule, markScheduleResult\n- enableSchedule now computes next_run_at (critical fix from oracle review)\n- markScheduleResult uses Effect.try (critical fix from oracle review)\n- runSchedulerLoop uses catchAllCause (critical fix from oracle review)\n- Loop started on boot after resumeStuckJobs\n\nCOMMIT: 4ffa815 (+316 lines)\n\nORACLE REVIEW FIXES APPLIED:\n- Safe cron parsing with Effect.try in markScheduleResult\n- catchAllCause instead of catchAll for defect handling\n- Initialize next_run_at on enable","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T18:02:56.597745+01:00","updated_at":"2025-12-23T18:14:41.974896+01:00","closed_at":"2025-12-23T18:14:41.974896+01:00","dependencies":[{"issue_id":"cod-s4i","depends_on_id":"cod-eip","type":"parent-child","created_at":"2025-12-23T18:03:24.942668+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-s4i","depends_on_id":"cod-cvb","type":"blocks","created_at":"2025-12-23T18:03:45.20874+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-sdl","title":"Add prices icon to TabBar component","description":"Extend TabBar to support a prices/currency icon variant for the new Prices tab.","design":"Add 'prices' to TabIcon type. Use Russian Ruble symbol (₽) or currency icon. Style with amber/orange color to differentiate from existing cyan/violet tabs.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T03:08:50.931938+01:00","updated_at":"2025-12-22T03:15:52.485338+01:00","closed_at":"2025-12-22T03:15:52.485338+01:00","dependencies":[{"issue_id":"cod-sdl","depends_on_id":"cod-a1z","type":"blocks","created_at":"2025-12-22T03:08:59.740208+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-sdl","depends_on_id":"cod-3xb","type":"parent-child","created_at":"2025-12-22T03:09:07.720419+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-sne","title":"Add primary_category_id to devices + device_category_links table","description":"Add primary_category_id FK to devices table for fast lookup. Add device_category_links join table for multi-category support (hybrids like tablet/laptop).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T19:39:05.216307+01:00","updated_at":"2026-01-08T19:41:08.236839+01:00","closed_at":"2026-01-08T19:41:08.236839+01:00","close_reason":"Added primary_category_id to devices + device_category_links table","dependencies":[{"issue_id":"cod-sne","depends_on_id":"cod-ipk","type":"blocks","created_at":"2026-01-08T19:39:25.43247+01:00","created_by":"daemon"},{"issue_id":"cod-sne","depends_on_id":"cod-63k","type":"parent-child","created_at":"2026-01-08T19:39:31.565776+01:00","created_by":"daemon"}]}
{"id":"cod-syq","title":"Fix multi-link architecture for price tracking","description":"Current schema only allows ONE source link per device per source type (UNIQUE device_id,source constraint). User needs: device → many source links → many price quotes per link.\n\nBlockers identified:\n1. device_sources has UNIQUE(device_id, source) - prevents multiple Yandex links\n2. price_quotes has no link identifier (no external_id column)\n3. entity_data_raw has UNIQUE(device_id, source, data_kind)\n4. All price queries are device-level only\n\nMigration needed:\n- Remove UNIQUE(device_id, source) from device_sources\n- Add external_id TEXT column to price_quotes\n- Update PriceService.savePriceQuotes to accept externalId\n- Update yandex.scrape handler to pass externalId","design":"Schema changes:\n1. Rebuild device_sources without UNIQUE(device_id, source)\n2. ALTER TABLE price_quotes ADD COLUMN external_id TEXT\n3. Add index idx_price_quotes_link on (device_id, source, external_id, scraped_at)\n\nService changes:\n1. PriceService.savePriceQuotes: add externalId param, store in price_quotes\n2. PriceService.getPriceHistory: add optional externalId filter\n3. yandex.scrape handler: extract externalId from URL, call linkDeviceToSource, pass to savePriceQuotes\n\nEffort: ~4-6 hours","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-23T00:54:09.217212+01:00","updated_at":"2025-12-23T01:15:04.181863+01:00","closed_at":"2025-12-23T01:15:04.181863+01:00"}
{"id":"cod-t8h","title":"Refactor JobsSection: Complete Rewrite","description":"Complete refactor of JobsSection.tsx following SolidJS idioms. Current state: 600-line monolith with duplicated logic, bugs (status() not called), and anti-patterns (IIFEs in JSX).","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-22T00:16:57.18393+01:00","updated_at":"2025-12-22T00:27:47.462819+01:00","closed_at":"2025-12-22T00:27:47.462819+01:00"}
{"id":"cod-t8k","title":"Phase 1: Context \u0026 Services Architecture","description":"Create the foundation: selection service and context providers.\n\n## Deliverables\n1. selection.service.ts - modifier key support (shift/ctrl/cmd)\n2. devices-table.context.tsx - 4 contexts (Devices, Selection, RowData, Actions)\n3. Refactor useSlugsApi to use createStore for status maps\n\n## Acceptance Criteria\n- [ ] SelectionService handles click, shift+click, cmd/ctrl+click\n- [ ] Contexts expose focused APIs (not 17+ props)\n- [ ] scrapeStatus, queueStatus, queueLoading use createStore\n- [ ] Build passes (npm run check-types)","design":"\n## Selection Service\n- createStore\u003cRecord\u003cstring, boolean\u003e\u003e for selected state\n- lastIndex signal for shift-select anchor\n- handleRowClick(slug, index, MouseEvent) with modifier detection\n\n## Context Architecture\n- DevicesContext: devices, filtered, total, limit\n- SelectionContext: isSelected, handleRowClick, toggleAll, clearSelection\n- RowDataContext: getStatus(slug), getQueue(slug), getQueueLoading(slug)\n- ActionsContext: queueScrape, clearData, openModal\n\n## useSlugsApi Changes\nReplace createSignal\u003cRecord\u003c...\u003e\u003e with createStore\u003cRecord\u003c...\u003e\u003e for:\n- scrapeStatus\n- queueStatus\n- queueLoading","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T17:15:32.588334+01:00","updated_at":"2025-12-23T17:20:57.844145+01:00","closed_at":"2025-12-23T17:20:57.844145+01:00","dependencies":[{"issue_id":"cod-t8k","depends_on_id":"cod-6i9","type":"blocks","created_at":"2025-12-23T17:16:30.56457+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-t8k","depends_on_id":"cod-b06","type":"parent-child","created_at":"2025-12-23T17:16:44.696426+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-trg","title":"Persistent browser pool for bulk scraping","description":"Implement a persistent browser pool to eliminate per-request browser startup overhead (~1-2s per item). Currently each of 50 workers launches a NEW browser per queue item. Pool should: lazy-init browsers on-demand, match pool size to worker count, idle-cleanup after no active jobs, crash recovery with replacement, usage-based recycling after N uses.","design":"Queue-based pool inside BrowserService using Ref\u003cBrowserPoolState\u003e + Semaphore. Fresh page per scrape, reuse browsers. Background daemon fiber for idle cleanup. Integration via withPooledBrowserPage() replacing createBrowserScoped() in ScrapeService.scrapeFast. See Oracle consultation for full architecture.","acceptance_criteria":"- [ ] Pool state in BrowserService (Ref\u003cBrowserPoolState\u003e + Semaphore)\n- [ ] withPooledBrowserPage() API exposed\n- [ ] Lazy browser creation on-demand\n- [ ] resizePool() to adjust max size with worker count\n- [ ] Idle cleanup fiber (closes browsers after X min inactivity when no jobs)\n- [ ] Crash detection removes slot, creates replacement\n- [ ] Usage-based recycling after N uses\n- [ ] Graceful shutdown via Effect.addFinalizer\n- [ ] ScrapeService.scrapeFast uses pool instead of createBrowserScoped\n- [ ] Build passes (npm run build)\n- [ ] Type check passes (npm run check-types)","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-24T19:29:46.585678+01:00","updated_at":"2025-12-24T19:43:53.918622+01:00","closed_at":"2025-12-24T19:43:53.918622+01:00"}
{"id":"cod-tve","title":"Fix 1: SSRF Protection + Shared URL Validation","description":"Create shared URL validation helper and use it in both WS handlers.\n\n## Implementation\n1. Create apps/scraper/src/sources/yandex_market/url-utils.ts:\n   - validateYandexUrl(url: string): { externalId: string } | { error: string }\n   - Whitelist: market.yandex.ru, m.market.yandex.ru\n   - Require HTTPS\n   - Extract product ID from pathname\n\n2. Update yandex.scrape handler to use validateYandexUrl\n3. Update yandex.link handler to use validateYandexUrl\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T02:24:11.826905+01:00","updated_at":"2025-12-22T02:27:55.188285+01:00","closed_at":"2025-12-22T02:27:55.188285+01:00","dependencies":[{"issue_id":"cod-tve","depends_on_id":"cod-ulx","type":"parent-child","created_at":"2025-12-22T02:24:45.407891+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-u5r","title":"JobsSection presentational atoms","description":"Create small reusable UI components: JobTypeBadge, JobStatusBadge, JobProgressBar, JobWorkersSelect, JobActions, JobTimeoutInfo. Each component uses shared helpers.","design":"Components in apps/ws-web/src/pages/slugs/components/jobs/. Each is pure presentational, takes props, uses helpers from jobViewHelpers.ts.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-22T00:17:14.468131+01:00","updated_at":"2025-12-22T00:27:47.399727+01:00","closed_at":"2025-12-22T00:27:47.399727+01:00","dependencies":[{"issue_id":"cod-u5r","depends_on_id":"cod-t8h","type":"parent-child","created_at":"2025-12-22T00:17:37.524221+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-u5r","depends_on_id":"cod-0z6","type":"blocks","created_at":"2025-12-22T00:17:37.626364+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-u6l","title":"Phase 3: Design Polish \u0026 Interactions","description":"Implement the industrial precision design and interactive features.\n\n## Deliverables\n1. Entire row clickable for selection\n2. DataStatusIcons clickable to open specific modal tabs\n3. Inline price summary (lazy-loaded)\n4. Row expansion for price details\n5. Visual refinements per design system\n\n## Acceptance Criteria\n- [ ] Row click triggers selection (not just checkbox)\n- [ ] Clicking HTML/Raw/AI icon opens modal to that tab\n- [ ] Price summary shows inline when available\n- [ ] Expanded row shows price details\n- [ ] Build passes","design":"\n## Row Layout\n┌─────┬─────────────────────────┬────────┬─────────────────┬────────┬──────┬─────┐\n│ ☑  │ Device Name              │ Brand  │ ■ ■ ■ ✓        │ 85K₽   │ •••  │ ⋮   │\n│     │ device-slug              │        │ HTML RAW AI OK  │ 3 offers│      │     │\n└─────┴─────────────────────────┴────────┴─────────────────┴────────┴──────┴─────┘\n\n## Clickable Icons\nDataStatusIcons receive onOpenTab callback\nEach icon triggers openModal(slug, tab) where tab = 'html' | 'raw' | 'ai'\n\n## Price Integration\n- createResource fetches price summary\n- Shows min price inline\n- Expansion shows full price breakdown","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-23T17:16:06.839431+01:00","updated_at":"2025-12-23T17:37:03.742966+01:00","closed_at":"2025-12-23T17:37:03.742966+01:00","dependencies":[{"issue_id":"cod-u6l","depends_on_id":"cod-nah","type":"blocks","created_at":"2025-12-23T17:16:30.625061+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-u6l","depends_on_id":"cod-b06","type":"parent-child","created_at":"2025-12-23T17:16:44.753275+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-ulx","title":"Epic: Yandex.Market Follow-up Fixes","description":"Fix issues identified during Oracle reviews of Yandex.Market price scraping feature.\n\n## Issues\n1. SSRF Protection (Critical) - validate URLs before scraping\n2. Shared URL Parsing - DRY up URL validation logic\n3. Availability Parsing - extract isAvailable from HTML\n4. Filter History by Availability - only include available offers\n5. variantLabel Population - extract human-readable variant names","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-22T02:24:01.963094+01:00","updated_at":"2025-12-22T02:39:26.894021+01:00","closed_at":"2025-12-22T02:39:26.894021+01:00"}
{"id":"cod-uzr","title":"Phase 1: Schema extensions for price scraping","description":"Extend database schema to support Yandex.Market price scraping.\n\n## Changes\n1. Add columns to price_quotes via ensureColumn:\n   - seller_id TEXT (Yandex businessId)\n   - variant_key TEXT (normalized SKU like '4/128')\n   - variant_label TEXT (human readable '4 GB / 128 GB')\n   - offer_id TEXT (for deduplication)\n\n2. Add index for efficient queries:\n   - idx_price_quotes_variant on (device_id, variant_key, scraped_at)\n\n## Verification\n- npm run build passes\n- npm run check-types passes\n- Schema auto-migrates on app startup","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T01:55:03.569219+01:00","updated_at":"2025-12-22T01:59:40.740925+01:00","closed_at":"2025-12-22T01:59:40.740925+01:00","dependencies":[{"issue_id":"cod-uzr","depends_on_id":"cod-abp","type":"parent-child","created_at":"2025-12-22T01:56:14.25131+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-v72","title":"Fix 3: Parse Availability from Yandex HTML","description":"Extract actual availability status from Yandex.Market HTML instead of hardcoding true.\n\n## Implementation\n1. Analyze /tmp/yandex-brightdata.html for availability patterns\n2. Update apps/scraper/src/sources/yandex_market/extractor.ts:\n   - Look for inStock, isAvailable, stockItemCount, or similar fields\n   - Set isAvailable based on found data\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T02:24:29.013185+01:00","updated_at":"2025-12-22T02:35:11.87267+01:00","closed_at":"2025-12-22T02:35:11.87267+01:00","dependencies":[{"issue_id":"cod-v72","depends_on_id":"cod-ulx","type":"parent-child","created_at":"2025-12-22T02:24:45.472098+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-v72","depends_on_id":"cod-2l4","type":"blocks","created_at":"2025-12-22T02:24:45.566358+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-vaq","title":"Phase 4: Add missing types to domain","description":"Add types that are scattered or missing (~60 lines). Add to models/device.ts: JobType, JobStatus, AiMode type unions. Create models/entity.ts with EntityData and PriceQuote interfaces matching DB tables.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-25T17:23:56.337186+01:00","updated_at":"2025-12-25T17:51:36.676792+01:00","closed_at":"2025-12-25T17:51:36.676792+01:00","dependencies":[{"issue_id":"cod-vaq","depends_on_id":"cod-2nf","type":"parent-child","created_at":"2025-12-25T17:24:20.324377+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-vaq","depends_on_id":"cod-087","type":"blocks","created_at":"2025-12-25T17:24:42.200771+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-vtu","title":"Phase 4: Update AGENTS.md documentation","description":"Update documentation to reflect new scheduler functionality.\n\n## Updates\n- Remove 'No cron/scheduler' limitation note\n- Add Scheduler section describing:\n  - job_schedules table\n  - SchedulerService\n  - Scheduler loop behavior\n  - API endpoints\n  - Crash recovery strategy\n- Add example schedule creation\n- Document cron expression format\n\n## Files\n- AGENTS.md","acceptance_criteria":"- [ ] AGENTS.md updated with scheduler documentation\n- [ ] Limitation note removed\n- [ ] API endpoints documented\n- [ ] Example usage included","notes":"COMPLETED: Phase 4 - Documentation\n\nCHANGES:\n- Added Scheduler section with table schema\n- Added SchedulerService overview\n- Added crash recovery documentation\n- Added cron expression format reference\n- Added Scheduler API endpoints section\n- Added curl examples\n- Removed 'no cron/scheduler' limitation note\n\nCOMMIT: 76d3313 (+88 lines)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-23T18:03:12.585877+01:00","updated_at":"2025-12-23T18:19:56.139435+01:00","closed_at":"2025-12-23T18:19:56.139435+01:00","dependencies":[{"issue_id":"cod-vtu","depends_on_id":"cod-eip","type":"parent-child","created_at":"2025-12-23T18:03:24.999624+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-vtu","depends_on_id":"cod-cnh","type":"blocks","created_at":"2025-12-23T18:03:45.264293+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-wl0","title":"Phase 2: Remove dead code from scraper-protocol","description":"Remove unused protocol messages (~50 lines). Delete: batch.submitted, batch.progress, batch.completed StreamEvent variants; BulkItemCompleted class; BulkListParams (ignored by handler).","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-25T17:23:38.508036+01:00","updated_at":"2025-12-25T17:33:51.812843+01:00","closed_at":"2025-12-25T17:33:51.812843+01:00","dependencies":[{"issue_id":"cod-wl0","depends_on_id":"cod-2nf","type":"parent-child","created_at":"2025-12-25T17:24:20.063313+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-wl0","depends_on_id":"cod-2ov","type":"blocks","created_at":"2025-12-25T17:24:41.991352+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-x5r","title":"Phase 4: Update LiveLayer and cleanup","description":"Update Effect layer composition with new services, remove deprecated code from storage.ts.","design":"1. Update layers/live.ts to compose all new services\n2. Remove deprecated wrappers from storage.ts\n3. Delete storage.ts if empty, or keep minimal shared DB utilities\n4. Update all imports across codebase\n5. Verify index.ts startup works correctly","acceptance_criteria":"- [ ] LiveLayer composes: HtmlCacheService, JobQueueService, DeviceService, PhoneDataService, KimovilScraper, OpenAIService, BrowserService\n- [ ] No deprecated code in storage.ts\n- [ ] Clean imports everywhere\n- [ ] Server starts and all features work\n- [ ] Build and typecheck pass","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T19:31:14.194922+01:00","updated_at":"2025-12-20T23:40:47.73989+01:00","closed_at":"2025-12-20T23:40:47.73989+01:00","dependencies":[{"issue_id":"cod-x5r","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.925128+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-x5r","depends_on_id":"cod-rll","type":"blocks","created_at":"2025-12-20T19:35:42.226064+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"cod-x5r","depends_on_id":"cod-3qg","type":"blocks","created_at":"2025-12-20T19:35:42.258114+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"cod-yvy","title":"Refactor: Split ws-server.ts by message handlers","description":"ws-server.ts is 1016 lines - split into separate handler modules by message type for maintainability","status":"open","priority":2,"issue_type":"chore","created_at":"2025-12-26T00:36:39.918717+01:00","updated_at":"2025-12-26T00:36:39.918717+01:00"}
{"id":"cod-z8g","title":"Widget: HTML renderer matching PalachPriceWidget styling","description":"Create pure HTML string renderer that produces identical output to PalachPriceWidget.\n\n## Deliverables\n1. apps/scraper/src/services/widget-render.ts\n2. renderPriceWidget(model: WidgetModel): string\n3. All Tailwind classes from PalachPriceWidget preserved exactly\n4. Support for arrowVariant (neutral/up/down/hot/new)\n5. Support for theme (light/dark - light only for now)\n\n## WidgetModel Interface\n- device: { name, brand, slug, image }\n- specs: { screenSize, cpu, battery }\n- prices: { source, minPrice, offerCount, url }[]\n- options: { arrowVariant, theme }\n\n## Key Constraints\n- Pure function, no IO\n- Self-contained HTML (no external dependencies)\n- Escape all user content for XSS safety","notes":"COMPLETED: Created apps/scraper/src/services/widget-render.ts\n\nImplemented:\n- renderPriceWidget(model, options) - main widget with header, specs, price highlight, shop rows\n- renderNotFoundWidget(slug) - 404 case\n- renderErrorWidget() - error case\n\nFeatures:\n- All Tailwind classes converted to inline styles\n- ArrowVariant support (neutral/up/down/hot/new) with correct HSL colors\n- XSS-safe escapeHtml() for all user content\n- Pure function, no IO\n- Complete HTML document with Inter font family\n- Price formatting in rubles with locale\n- Pluralization for Russian offer counts\n\nBuild passes successfully.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-08T18:15:33.498621+01:00","updated_at":"2026-01-08T18:25:01.744427+01:00","closed_at":"2026-01-08T18:25:01.744427+01:00","close_reason":"Implemented widget-render.ts with Tailwind classes matching PalachPriceWidget","dependencies":[{"issue_id":"cod-z8g","depends_on_id":"cod-1qq","type":"parent-child","created_at":"2026-01-08T18:16:38.465707+01:00","created_by":"daemon"},{"issue_id":"cod-z8g","depends_on_id":"cod-0ua","type":"blocks","created_at":"2026-01-08T18:16:49.301556+01:00","created_by":"daemon"}]}
