{"id":"cod-0qv","title":"Fix review issues: initStealthSession cleanup + SearchError wrapping","description":"Address two issues from Oracle reviews:\n1. initStealthSession lacks cleanup on partial failure - if browser created but page.goto fails, browser leaks\n2. SearchServiceKimovil: browser-level errors not wrapped in SearchError, so they bypass retry logic","acceptance_criteria":"- [ ] initStealthSession uses acquireRelease or cleanup on failure\n- [ ] All errors from withPersistentStealthPage wrapped in SearchError\n- [ ] npm run check-types passes\n- [ ] npm run build passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:50:13.460317+01:00","updated_at":"2025-12-21T17:52:29.074467+01:00","closed_at":"2025-12-21T17:52:29.074467+01:00"}
{"id":"cod-26h","title":"Phase 2: Backfill Devices","description":"Populate devices and device_sources from existing kimovil_devices table.\n\n## Migration steps:\n1. Generate device IDs (16-char sha256 of slug)\n2. INSERT INTO devices from kimovil_devices\n3. INSERT INTO device_sources with source='kimovil', external_id=slug\n\n## Files:\n- apps/scraper/src/sql/schema.ts (add migration function)\n\nEstimated: 0.5 days","acceptance_criteria":"- [ ] All kimovil_devices migrated to devices\n- [ ] device_sources populated with source='kimovil'\n- [ ] Migration is idempotent (can run multiple times)\n- [ ] Existing functionality unchanged","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:17.482994+01:00","updated_at":"2025-12-21T04:49:47.035999+01:00","closed_at":"2025-12-21T04:49:47.035999+01:00","dependencies":[{"issue_id":"cod-26h","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.335025+01:00","created_by":"daemon"},{"issue_id":"cod-26h","depends_on_id":"cod-b4n","type":"blocks","created_at":"2025-12-21T04:41:19.017632+01:00","created_by":"daemon"}]}
{"id":"cod-2i2","title":"Phase 2: Implement stealth browser init and withPersistentStealthPage","description":"Create initStealthSession helper that launches chromium with stealth flags, patches webdriver, navigates to kimovil.com. Implement withPersistentStealthPage that lazily inits session, acquires semaphore, runs user effect with page, handles errors.","acceptance_criteria":"- [ ] Stealth browser launches with --disable-blink-features=AutomationControlled\n- [ ] navigator.webdriver patched via addInitScript\n- [ ] Session pre-warms by visiting kimovil.com/en/\n- [ ] withPersistentStealthPage serializes access via Semaphore\n- [ ] Lazy init on first call, reuses on subsequent\n- [ ] npm run check-types passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:38:46.282708+01:00","updated_at":"2025-12-21T17:46:31.993012+01:00","closed_at":"2025-12-21T17:46:31.993012+01:00","dependencies":[{"issue_id":"cod-2i2","depends_on_id":"cod-3a9","type":"parent-child","created_at":"2025-12-21T17:39:10.482994+01:00","created_by":"daemon"},{"issue_id":"cod-2i2","depends_on_id":"cod-8wi","type":"blocks","created_at":"2025-12-21T17:39:23.068878+01:00","created_by":"daemon"}]}
{"id":"cod-2qg","title":"Remove pipe-delimited strings, use JSON arrays everywhere","description":"Currently the codebase has inconsistent data formats:\n- Extractors return pipe-delimited strings (e.g., 'Glass|Aluminium')\n- Migration 001 converted some to JSON arrays in DB\n- Schema still expects Schema.String for these fields\n- Result: double-encoded JSON strings like '[\"Glass\",\"Aluminium\"]'\n- Nested values like skus[].marketId still pipe-delimited\n\n## Fields to migrate\n- aliases, images, materials, colors, displayFeatures, cpuCores, sim, cameraFeatures, others (top-level)\n- skus[].marketId (nested - should become string[])\n- cameras[].features (nested - should become string[])\n\n## Changes needed\n1. Update extractors to return arrays instead of .join('|')\n2. Update RawPhone/Phone schemas to use Schema.Array(Schema.String)\n3. Remove toDelimited/toPipeString helpers in scrape-kimovil.ts\n4. Update openai.ts to work with arrays\n5. Write migration to fix existing double-encoded data\n6. Update any UI code that splits on '|'","design":"Approach:\n1. Schema first: Update phone.ts to use arrays\n2. Extractors: Return arrays directly\n3. AI service: Remove pipe-string conversions\n4. Migration: Fix corrupted data in DB\n5. Test with fresh scrape + existing data","notes":"COMPLETED: Full migration to JSON arrays\n\nCHANGES:\n- Schema: All list fields now Schema.Array(Schema.String)\n- Sku: marketId → marketIds (array)\n- Camera: features now array\n- Extractors: Return arrays directly\n- Removed toDelimited/toPipeString helpers\n- Migration 002: Fixed 6462 rows in phone_data_raw, 57 in phone_data\n\nVERIFIED:\n- npm run check-types passes\n- Migration successful\n- samsung-galaxy-s24 now has proper arrays","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T21:11:32.708259+01:00","updated_at":"2025-12-21T21:20:56.952306+01:00","closed_at":"2025-12-21T21:20:56.952309+01:00"}
{"id":"cod-3a9","title":"Fix Kimovil search 403 by adding persistent stealth browser to BrowserService","description":"Cloudflare now blocks all direct HTTP requests to Kimovil API. Solution: extend BrowserService with persistent stealth browser that bypasses detection using --disable-blink-features=AutomationControlled + webdriver patch. Reuse browser session between searches to avoid repeated page loads.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-12-21T17:38:26.39231+01:00","updated_at":"2025-12-21T17:49:24.73252+01:00","closed_at":"2025-12-21T17:49:24.73252+01:00"}
{"id":"cod-3hz","title":"Phase 5: Migrate Kimovil Pipeline","description":"Migrate existing Kimovil phone scraping to new entity_data pattern.\n\n## Changes:\n1. Register Kimovil specs pipeline in registry\n2. Refactor ScrapeKimovilService to:\n   - Create scrape records via ScrapeRecordService\n   - Save to entity_data_raw instead of phone_data_raw\n   - Save to entity_data instead of phone_data\n3. Keep PhoneDataService as facade for API backward compatibility\n   - Reads from entity_data_raw/entity_data WHERE source='kimovil' AND data_kind='specs'\n   - Converts to existing RawPhone/Phone types\n\n## Files:\n- apps/scraper/src/services/scrape-kimovil.ts\n- apps/scraper/src/services/phone-data.ts (update as facade)\n- apps/scraper/src/sources/kimovil/specs.ts (new pipeline impl)\n\nEstimated: 3-5 days","acceptance_criteria":"- [ ] Kimovil pipeline registered\n- [ ] New scrapes use entity_data tables\n- [ ] PhoneDataService facade works unchanged\n- [ ] Existing API endpoints work\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:52.081627+01:00","updated_at":"2025-12-21T05:04:25.904919+01:00","closed_at":"2025-12-21T05:04:25.904919+01:00","dependencies":[{"issue_id":"cod-3hz","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.432995+01:00","created_by":"daemon"},{"issue_id":"cod-3hz","depends_on_id":"cod-7ue","type":"blocks","created_at":"2025-12-21T04:41:19.11074+01:00","created_by":"daemon"}]}
{"id":"cod-3qg","title":"Phase 3: Refactor KimovilScraper","description":"Rename scrape-kimovil.ts to kimovil.ts, refactor to use HtmlCacheService directly.","design":"1. Split scrape-kimovil.ts into three files:\n   - kimovil.ts (~300 lines): ScrapeService impl, fetch, cache orchestration\n   - kimovil-extractors.ts (~600 lines): extractPhoneData, getCameras, getSpecs, getSKUs\n   - kimovil-validators.ts (~100 lines): isBotProtectionPage, getHtmlValidationError\n2. kimovil.ts injects HtmlCacheService dependency\n3. Remove direct storage.ts imports for HTML ops\n4. Export extractors/validators for reuse and testing\n5. Prepare interface pattern for future scrapers (GSMArena, etc.)\n6. Update exports and imports across codebase","acceptance_criteria":"- [ ] scrape-kimovil.ts split into kimovil.ts, kimovil-extractors.ts, kimovil-validators.ts\n- [ ] kimovil.ts uses HtmlCacheService for caching\n- [ ] Extractors are pure functions, easily testable\n- [ ] Validators exported for reuse by other scrapers\n- [ ] Clean separation of Kimovil-specific logic\n- [ ] Build passes","notes":"Completed: validators + extractors extracted. scrape-kimovil.ts reduced from 1101 to 595 lines.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T19:31:06.531582+01:00","updated_at":"2025-12-20T19:57:00.587077+01:00","closed_at":"2025-12-20T19:57:00.587077+01:00","dependencies":[{"issue_id":"cod-3qg","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.893932+01:00","created_by":"daemon"},{"issue_id":"cod-3qg","depends_on_id":"cod-8np","type":"blocks","created_at":"2025-12-20T19:35:42.195617+01:00","created_by":"daemon"}]}
{"id":"cod-7ue","title":"Phase 6: Cleanup \u0026 Documentation","description":"Remove legacy code paths and update documentation.\n\n## Cleanup:\n- Remove direct phone_data_raw/phone_data writes (keep tables for now)\n- Remove legacy slug-based lookups where device_id should be used\n- Consolidate duplicate code between services\n\n## Documentation:\n- Update AGENTS.md with new architecture\n- Document pipeline registration pattern\n- Add example for new source implementation\n\n## Files:\n- AGENTS.md\n- README.md\n- apps/scraper/src/services/* (cleanup)\n\nEstimated: 2-3 days","acceptance_criteria":"- [ ] Legacy code paths removed\n- [ ] Documentation updated\n- [ ] AGENTS.md reflects new architecture\n- [ ] npm run build passes\n- [ ] npm run check-types passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T04:41:00.226038+01:00","updated_at":"2025-12-21T05:10:28.956992+01:00","closed_at":"2025-12-21T05:10:28.956992+01:00","dependencies":[{"issue_id":"cod-7ue","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.468979+01:00","created_by":"daemon"}]}
{"id":"cod-7y3","title":"Refactor search errors to Effect-idiomatic tagged errors","description":"Replace nested SearchError with structured tagged errors using Data.TaggedError pattern.\n\nCurrent problem:\n- Errors nested multiple times with string messages\n- No structured data (status code, URL, attempt buried in strings)\n- Hard to debug and filter logs\n\nSolution:\n- KimovilHttpError: url, status, statusText, attempt\n- KimovilInvalidResponseError: url, attempt, raw\n- SearchRetryExhaustedError: query, attempts, lastError\n- Map errors once at leaf, don't re-wrap\n- Use log annotations for debugging","acceptance_criteria":"- [ ] New error types using Data.TaggedError\n- [ ] Errors have structured fields (url, status, attempt, etc.)\n- [ ] Single mapError at leaf level\n- [ ] SearchRetryExhaustedError wraps final failure\n- [ ] No nested error wrapping\n- [ ] npm run check-types passes\n- [ ] npm run build passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:59:22.945237+01:00","updated_at":"2025-12-21T18:03:45.204748+01:00","closed_at":"2025-12-21T18:03:45.204748+01:00"}
{"id":"cod-8np","title":"Phase 1: Extract HtmlCacheService","description":"Extract HTML caching logic from storage.ts into dedicated HtmlCacheService. Add 'source' column for multi-source support.","design":"1. Create services/html-cache.ts with Effect service pattern\n2. Move: saveRawHtml, getRawHtml, getRawHtmlIfFresh, getRawHtmlWithAge\n3. Move: recordVerification, verifyHtml, getVerificationStatus, getCorruptedSlugs, getValidSlugs\n4. Add 'source' column to raw_html table (default: 'kimovil')\n5. Update scrape-kimovil.ts to use new service\n6. Keep old methods in storage.ts as deprecated wrappers initially","acceptance_criteria":"- [ ] HtmlCacheService created with Effect Context pattern\n- [ ] All HTML cache methods moved and working\n- [ ] Source column added with migration\n- [ ] scrape-kimovil.ts uses new service\n- [ ] Build passes, existing tests pass","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T19:30:39.8528+01:00","updated_at":"2025-12-20T19:57:00.458486+01:00","closed_at":"2025-12-20T19:57:00.458486+01:00","dependencies":[{"issue_id":"cod-8np","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.767894+01:00","created_by":"daemon"}]}
{"id":"cod-8wi","title":"Phase 1: Extend BrowserService interface and convert to Layer.scoped","description":"Add withPersistentStealthPage method signature. Convert BrowserServiceLive from Layer.succeed to Layer.scoped. Add Ref\u003cOption\u003c{browser, page}\u003e\u003e and Semaphore(1) for state management.","acceptance_criteria":"- [ ] Interface has withPersistentStealthPage method\n- [ ] Layer converted to Layer.scoped with acquireRelease\n- [ ] State refs created (browser/page Ref, Semaphore)\n- [ ] Existing scoped methods unchanged\n- [ ] npm run check-types passes","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:38:37.19559+01:00","updated_at":"2025-12-21T17:42:38.425932+01:00","closed_at":"2025-12-21T17:42:38.425932+01:00","dependencies":[{"issue_id":"cod-8wi","depends_on_id":"cod-3a9","type":"parent-child","created_at":"2025-12-21T17:39:10.451215+01:00","created_by":"daemon"}]}
{"id":"cod-apr","title":"Separate clear/refresh actions for Raw and AI data","description":"Add granular data management: separate 'Clear Raw Data' and 'Clear AI Data' buttons, plus 'Refresh Raw' (re-run extractors) and 'Refresh AI' (re-run Gemini) actions. Integrate into table row actions, PhoneDataModal tabs, and bulk selection bar.\n\n## Oracle-Validated API Contract\n\n### Delete endpoints (clear data):\n- DELETE /api/phone-data/raw/:slug - clear phone_data_raw only\n- DELETE /api/phone-data/:slug - clear phone_data only\n- Keep DELETE /api/scrape/html/:slug for raw_html (update to actually clear HTML)\n\n### Process endpoints (refresh):\n- POST /api/process/raw - re-run extractors on cached HTML (exists)\n- POST /api/process/ai - re-run Gemini on raw data (exists)\n\n### Edge cases to handle:\n- Refresh with missing source: 404/409 response\n- No cascade: clearing AI doesn't clear Raw (and vice versa)\n- Concurrency guard: check if slug is running in job_queue\n\n## UI Integration Points\n1. DevicesTable row actions: Clear Raw, Clear AI buttons\n2. PhoneDataModal tabs: Refresh button per tab (Raw/AI)\n3. SelectionBar: Bulk clear raw/AI actions","design":"## Backend Changes (api.ts + phone-data.ts)\n\n### PhoneDataService additions:\n- deleteRaw(slug): DELETE from phone_data_raw WHERE slug\n- delete(slug): DELETE from phone_data WHERE slug\n\n### New API routes:\n- DELETE /api/phone-data/raw/:slug → phoneData.deleteRaw(slug)\n- DELETE /api/phone-data/:slug → phoneData.delete(slug)\n\n### Update existing routes:\n- POST /api/process/raw: Add 404 check for missing HTML\n- POST /api/process/ai: Add 404 check for missing raw data\n\n## Frontend Changes\n\n### useSlugsApi.ts additions:\n- clearRawData(slug): DELETE /api/phone-data/raw/:slug\n- clearAiData(slug): DELETE /api/phone-data/:slug\n- refreshRawData(slug): POST /api/process/raw\n- refreshAiData(slug): POST /api/process/ai\n\n### DevicesTable.tsx:\n- Add 'Clear Raw' action button (cyan trash icon)\n- Add 'Clear AI' action button (violet trash icon)\n- Show only when respective data exists\n\n### PhoneDataModal.tsx:\n- Add refresh button to Raw Data tab header\n- Add refresh button to AI Data tab header\n- Loading state during refresh\n- Auto-reload data after refresh\n\n### SelectionBar.tsx:\n- Add 'Clear Raw' bulk action\n- Add 'Clear AI' bulk action","status":"in_progress","priority":1,"issue_type":"feature","created_at":"2025-12-21T21:59:35.823985+01:00","updated_at":"2025-12-21T21:59:48.809881+01:00"}
{"id":"cod-b4n","title":"Phase 3: Core Services Implementation","description":"Implement new core services for device registry, entity data, and scrape management.\n\n## New services:\n1. DeviceRegistryService - Manage devices + device_sources\n   - lookupDevice(source, externalId)\n   - createDevice(slug, name, brand)\n   - linkDeviceToSource(deviceId, source, externalId, url)\n   - getDeviceById/getDeviceBySlug\n\n2. EntityDataService - Abstract entity_data_raw + entity_data\n   - saveRawData(deviceId, source, dataKind, data, scrapeId?)\n   - saveFinalData(deviceId, dataKind, data)\n   - getRawData/getFinalData\n\n3. ScrapeRecordService - Manage scrapes table lifecycle\n   - createScrape(deviceId, source, dataKind, externalId, url)\n   - startScrape(id)\n   - completeScrape(id)\n   - failScrape(id, error)\n\n## Domain models:\n- Device, DeviceSourceLink schemas\n- DataKind type: 'specs' | 'prices' | 'reviews' | 'availability'\n\n## Files:\n- apps/scraper/src/services/device-registry.ts (new)\n- apps/scraper/src/services/entity-data.ts (new)\n- apps/scraper/src/services/scrape-record.ts (new)\n- packages/scraper-domain/src/models/device.ts (new)\n\nEstimated: 3-4 days","acceptance_criteria":"- [ ] DeviceRegistryService implemented with tests\n- [ ] EntityDataService implemented\n- [ ] ScrapeRecordService implemented\n- [ ] Device + DeviceSourceLink schemas defined\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:29.519649+01:00","updated_at":"2025-12-21T04:54:29.687519+01:00","closed_at":"2025-12-21T04:54:29.687519+01:00","dependencies":[{"issue_id":"cod-b4n","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.366509+01:00","created_by":"daemon"},{"issue_id":"cod-b4n","depends_on_id":"cod-li6","type":"blocks","created_at":"2025-12-21T04:41:19.048277+01:00","created_by":"daemon"}]}
{"id":"cod-baw","title":"Unified search UI: local DB + Kimovil","description":"Update web UI search on index page to search both local devices DB and Kimovil API. Show local results instantly, then load Kimovil additions.\n\nRequirements:\n- Search local devices table first (fast, instant results)\n- Optionally fetch Kimovil API for devices not in DB\n- Clean, modern UI to display mixed results\n- Clear visual distinction between local vs Kimovil-only items\n- Fast perceived performance (show local results immediately)","design":"Consider:\n- Parallel search: local DB query + Kimovil API call\n- Show local results first, append Kimovil results as they arrive\n- UI indicators: checkmark for 'in DB', plus icon for 'add from Kimovil'\n- Debounced search input\n- Loading states for each source","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-21T17:56:07.30486+01:00","updated_at":"2025-12-21T17:56:07.30486+01:00"}
{"id":"cod-bb8","title":"Refactor storage.ts into modular service architecture","description":"Split the 2075-line storage.ts monolith into focused, testable services. Enable multi-source scraping architecture with shared infrastructure. See architecture diagram in thread T-019b3cfd-8ef0-770e-8cb1-2293860be2fb.","design":"Phase 1: Extract data layer services (HtmlCacheService, JobQueueService, DeviceService)\nPhase 2: Create PhoneDataService, refactor OpenAI integration  \nPhase 3: Refactor scrapers to use new services, prepare for multi-source\nPhase 4: Update LiveLayer composition, cleanup deprecated code","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-20T19:30:30.435199+01:00","updated_at":"2025-12-20T23:40:55.273208+01:00","closed_at":"2025-12-20T23:40:55.273208+01:00"}
{"id":"cod-co8","title":"Phase 1: Extract JobQueueService","description":"Extract job queue CRUD from storage.ts into dedicated JobQueueService.","design":"1. Create services/job-queue.ts\n2. Move: createJob, getJob, getAllJobs, updateJobStatus, getJobStats\n3. Move: enqueueJobSlugs, claimNextJobQueueItem, completeQueueItem, rescheduleQueueItem\n4. Move: resetStuckQueueItems, resetErrorQueueItems, getErrorQueueItems, unclaimRunningItems, getTimeoutStats\n5. Move deprecated bulk job methods as aliases\n6. Update bulk-job.ts to use new service","acceptance_criteria":"- [ ] JobQueueService created with Effect Context pattern\n- [ ] All job/queue methods moved\n- [ ] bulk-job.ts uses new service\n- [ ] Build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T19:30:46.941906+01:00","updated_at":"2025-12-20T19:57:00.492287+01:00","closed_at":"2025-12-20T19:57:00.492287+01:00","dependencies":[{"issue_id":"cod-co8","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.801291+01:00","created_by":"daemon"}]}
{"id":"cod-dre","title":"Phone Data UI Integration","description":"Integrate phone_data_raw and phone_data tables into web UI with tabbed modal (HTML/Raw/AI/Compare), JsonViewer with Shiki highlighting, and redesigned dense table with data indicators.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-20T00:01:28.605046+01:00","updated_at":"2025-12-20T00:01:28.605046+01:00","comments":[{"id":1,"issue_id":"cod-dre","author":"romanzagrebin","text":"Phase 1-3 complete:\n- Backend: GET /api/phone-data/raw/:slug, GET /api/phone-data/:slug\n- Backend: /api/scrape/status now returns hasRawData, hasAiData\n- Frontend types: PhoneDataRaw, PhoneDataAi, Sku, SingleCameraData, Benchmark\n- API hooks: fetchPhoneDataRaw(), fetchPhoneDataAi()\n\nNext: Phase 4 - JsonViewer + TabBar components","created_at":"2025-12-19T23:04:38Z"},{"id":2,"issue_id":"cod-dre","author":"romanzagrebin","text":"Phase 4-5 complete:\n- Installed shiki for JSON syntax highlighting\n- Created JsonViewer component (Shiki highlighting, copy button, loading/empty states)\n- Created TabBar component (HTML/Raw/AI/Compare tabs with status indicators)\n- Created PhoneDataModal (replaces HtmlPreviewModal, tabbed interface, lazy data loading)\n- Updated Slugs.tsx integration\n- Updated DevicesTable to use new modal\n\nFiles created:\n- apps/ws-web/src/pages/slugs/components/JsonViewer.tsx\n- apps/ws-web/src/pages/slugs/components/TabBar.tsx\n- apps/ws-web/src/pages/slugs/components/PhoneDataModal.tsx\n\nType checks pass. Ready for testing.","created_at":"2025-12-19T23:09:10Z"},{"id":3,"issue_id":"cod-dre","author":"romanzagrebin","text":"Phase 6+8 complete:\n- Created DataStatusIcons component (HTML/Raw/AI/Verified icons with color coding)\n- Redesigned DevicesTable: dense layout, merged Device column (name+slug), separate Queue column, data icons\n- Updated StatsPanel: 6-column responsive grid with Raw Data + AI Data counts\n- Backend /api/slugs now returns rawData/aiData counts\n\nAll phases complete. Ready for testing.","created_at":"2025-12-19T23:12:49Z"}]}
{"id":"cod-dt2","title":"Implement rich CpuCoreCluster format for CPU cores parsing","description":"Current cpuCores format is string[] like ['4x2400', '4x2000'] which loses valuable data. Need structured format preserving core names (Cortex A78, Kryo, Firestorm), P/E core classification, and handling no-frequency cores (Apple devices).","design":"Add CpuCoreCluster interface: { count, maxFreqMhz, label, role, rawGroup, index }. Create getCpuCoreClusters() in parsers.ts, keep getCpuCores() as adapter. Update RawPhoneData in extractors.ts, scraper-domain, and scraper-protocol schemas.","acceptance_criteria":"- [ ] CpuCoreCluster type defined with count, maxFreqMhz, label, role, rawGroup, index\n- [ ] getCpuCoreClusters() parses all format variations from exploration\n- [ ] getCpuCores() adapter returns string[] for backward compat\n- [ ] Handles no-frequency cores (Apple: Firestorm, Avalanche, etc.)\n- [ ] Detects P/E core roles from keywords and known mappings\n- [ ] Effect Schemas updated in scraper-domain and scraper-protocol\n- [ ] Type checks pass\n- [ ] Existing tests still work","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-21T22:25:19.083937+01:00","updated_at":"2025-12-21T22:31:15.314286+01:00","closed_at":"2025-12-21T22:31:15.314286+01:00"}
{"id":"cod-duf","title":"Phase 1: Extract DeviceService","description":"Extract device and prefix CRUD from storage.ts into dedicated DeviceService.","design":"1. Create services/device.ts\n2. Move: upsertDevice, getDevice, getDeviceCount, getAllDevices\n3. Move: enqueuePrefix, getNextPendingPrefix, markPrefixDone, getPendingPrefixCount, seedInitialPrefixes, resetAllPrefixes\n4. Update slug-crawler.ts to use new service","acceptance_criteria":"- [ ] DeviceService created with Effect Context pattern\n- [ ] All device/prefix methods moved\n- [ ] slug-crawler.ts uses new service\n- [ ] Build passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T19:30:52.435115+01:00","updated_at":"2025-12-20T19:57:00.524369+01:00","closed_at":"2025-12-20T19:57:00.524369+01:00","dependencies":[{"issue_id":"cod-duf","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.832406+01:00","created_by":"daemon"}]}
{"id":"cod-f3t","title":"Epic: Multi-Source Device Data Platform Refactor (V3)","description":"Evolve from Kimovil scraper to multi-source device data platform. Make devices central and source-agnostic. Treat scrapes as first-class entities. Let each data kind define its own schema but reuse same infrastructure.\n\nKey changes:\n- devices table as canonical registry\n- device_sources for external source links\n- scrapes table for individual attempts\n- entity_data_raw + entity_data for generic data storage\n- price_quotes for multi-row price data\n- source + dataKind aware job queue\n\nEstimated: 2-3 weeks\n\nReference: REFACTOR_PLAN_V3.md","design":"Pipeline registry pattern: (source, dataKind, stage) → handler. Each source implements stages: scrape → process_raw → process_ai","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-21T04:39:56.921903+01:00","updated_at":"2025-12-21T05:10:36.388891+01:00","closed_at":"2025-12-21T05:10:36.388891+01:00"}
{"id":"cod-fzn","title":"Phase 5: Introduce DatabaseService layer","description":"Replace singleton getDb() pattern with proper Effect DatabaseService for idiomatic dependency injection.","design":"1. Create DatabaseService interface in db.ts with { db: Database.Database }\n2. Create DatabaseServiceLive layer that initializes connection + runs all migrations\n3. Update all data services (JobQueue, HtmlCache, Device, PhoneData) to yield* DatabaseService\n4. Update LiveLayer to provide DatabaseServiceLive to all data services\n5. Remove duplicate getDb() singletons from each service\n6. Enables proper testing with mock database","acceptance_criteria":"- [ ] DatabaseService created with Effect Context pattern\n- [ ] All data services depend on DatabaseService via yield*\n- [ ] Single shared connection guaranteed by Effect\n- [ ] No duplicate getDb() functions\n- [ ] Build passes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-20T19:47:01.359117+01:00","updated_at":"2025-12-20T23:40:51.463908+01:00","closed_at":"2025-12-20T23:40:51.463908+01:00","dependencies":[{"issue_id":"cod-fzn","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:47:05.88226+01:00","created_by":"daemon"},{"issue_id":"cod-fzn","depends_on_id":"cod-x5r","type":"blocks","created_at":"2025-12-20T19:47:05.914207+01:00","created_by":"daemon"}]}
{"id":"cod-li6","title":"Phase 4: Job Queue Extensions","description":"Extend job queue with source + dataKind awareness and implement pipeline registry.\n\n## JobQueueService changes:\n- Add source, dataKind to Job and JobQueueItem types\n- Extend createJob, enqueueJobSlugs with source/dataKind params\n- Add claimNextByPipeline(source, dataKind, jobType)\n\n## Pipeline Registry:\n\\`\\`\\`typescript\ninterface PipelineDefinition {\n  source: string;\n  dataKind: DataKind;\n  stages: Record\u003cPipelineStage, StageHandler\u003e;\n}\n\nconst pipelineRegistry = new Map\u003cstring, PipelineDefinition\u003e();\nconst registerPipeline = (def: PipelineDefinition) =\u003e ...\nconst getPipeline = (source, dataKind) =\u003e ...\n\\`\\`\\`\n\n## Worker updates:\n- Lookup pipeline by source + dataKind\n- Build PipelineContext and execute stage handler\n\n## Files:\n- apps/scraper/src/services/job-queue.ts\n- apps/scraper/src/pipeline/registry.ts (new)\n- apps/scraper/src/pipeline/context.ts (new)\n\nEstimated: 2-3 days","acceptance_criteria":"- [ ] Job/JobQueueItem types extended with source/dataKind\n- [ ] Pipeline registry implemented\n- [ ] Workers use pipeline registry for dispatch\n- [ ] Backward compatible (defaults to kimovil/specs)\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:40.986329+01:00","updated_at":"2025-12-21T05:00:23.031041+01:00","closed_at":"2025-12-21T05:00:23.031041+01:00","dependencies":[{"issue_id":"cod-li6","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.398203+01:00","created_by":"daemon"},{"issue_id":"cod-li6","depends_on_id":"cod-3hz","type":"blocks","created_at":"2025-12-21T04:41:19.077658+01:00","created_by":"daemon"}]}
{"id":"cod-mqu","title":"Phase 3: Modify SearchServiceKimovil to use BrowserService","description":"Replace HttpClient dependency with BrowserService. Use withPersistentStealthPage + page.evaluate(fetch) to call Kimovil API from page context. Keep existing Stream\u003cSearchEvent|SearchResult\u003e API and retry logic.","acceptance_criteria":"- [ ] SearchServiceKimovil depends on BrowserService (not HttpClient)\n- [ ] API call via page.evaluate(fetch(...))\n- [ ] Existing retry logic preserved\n- [ ] Stream API unchanged\n- [ ] live.ts updated to provide BrowserServiceLive to SearchServiceLayer\n- [ ] npm run check-types passes\n- [ ] Search works end-to-end (manual test)","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-21T17:38:56.65028+01:00","updated_at":"2025-12-21T17:49:17.57929+01:00","closed_at":"2025-12-21T17:49:17.57929+01:00","dependencies":[{"issue_id":"cod-mqu","depends_on_id":"cod-3a9","type":"parent-child","created_at":"2025-12-21T17:39:10.513827+01:00","created_by":"daemon"},{"issue_id":"cod-mqu","depends_on_id":"cod-2i2","type":"blocks","created_at":"2025-12-21T17:39:23.099275+01:00","created_by":"daemon"}]}
{"id":"cod-pgg","title":"Phase 1: Schema Extensions","description":"Add source/data_kind columns to existing tables and create new tables.\n\n## Tables to modify:\n- jobs: ADD source TEXT DEFAULT 'kimovil', data_kind TEXT DEFAULT 'specs'\n- job_queue: ADD source TEXT DEFAULT 'kimovil', data_kind TEXT DEFAULT 'specs', scrape_id INTEGER\n- raw_html: ADD scrape_id INTEGER\n- scrape_verification: ADD scrape_id INTEGER\n\n## New tables:\n- devices (id, slug, name, brand, created_at, updated_at)\n- device_sources (device_id, source, external_id, url, status, first_seen, last_seen)\n- scrapes (id, device_id, source, data_kind, external_id, url, requested_at, started_at, completed_at, status, error_message)\n- entity_data_raw (id, device_id, source, data_kind, scrape_id, data, created_at, updated_at)\n- entity_data (id, device_id, data_kind, data, created_at, updated_at)\n- price_quotes (id, device_id, source, seller, price_minor_units, currency, url, scraped_at, scrape_id, is_available)\n- price_summary (device_id, min_price, max_price, currency, updated_at)\n\n## Files:\n- apps/scraper/src/sql/schema.ts\n\nEstimated: 1-2 days","acceptance_criteria":"- [ ] All ALTER TABLE migrations run without error\n- [ ] New tables created with indexes\n- [ ] Defaults preserve backward compatibility\n- [ ] npm run check-types passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T04:40:09.338913+01:00","updated_at":"2025-12-21T04:47:19.772919+01:00","closed_at":"2025-12-21T04:47:19.772919+01:00","dependencies":[{"issue_id":"cod-pgg","depends_on_id":"cod-f3t","type":"parent-child","created_at":"2025-12-21T04:41:13.30202+01:00","created_by":"daemon"},{"issue_id":"cod-pgg","depends_on_id":"cod-26h","type":"blocks","created_at":"2025-12-21T04:41:18.984493+01:00","created_by":"daemon"}]}
{"id":"cod-pr6","title":"Update AI service and UI for cpuCoreClusters + rename to RobotService","description":"AI service needs updates after cpuCoreClusters addition. Also rename OpenAIService to RobotService and improve error handling/progress in web UI when processing AI from modal.","design":"1. Rename openai.ts to robot.ts, OpenAIService to RobotService, OpenAIError to RobotError\n2. Update validateAndMerge to include cpuCoreClusters field\n3. Improve PhoneDataModal to show progress/errors during AI processing (not just spinner)\n4. Update all imports and references across codebase","acceptance_criteria":"- [ ] openai.ts renamed to robot.ts\n- [ ] OpenAIService → RobotService everywhere\n- [ ] OpenAIError → RobotError\n- [ ] cpuCoreClusters passed through to final PhoneData\n- [ ] PhoneDataModal shows error messages on AI failure\n- [ ] Type checks pass","status":"in_progress","priority":1,"issue_type":"feature","created_at":"2025-12-21T22:36:43.079116+01:00","updated_at":"2025-12-21T22:36:49.061445+01:00"}
{"id":"cod-pt7","title":"Epic: Unified Effect + SQL Migration","description":"Migrate to @effect/sql + idiomatic Effect patterns. Combines Epic 2 (Effect patterns) with Schema Refactor.\n\n## Goals\n- Replace raw better-sqlite3 with @effect/sql\n- Eliminate Effect.runPromise escapes\n- Add proper resource management (acquireRelease)\n- Domain models with Model.Class\n- Quarantine table for corrupted data\n- Structured logging\n\n## Constraints\n- App not live (can go offline, change schema freely)\n- No external DB consumers\n- ~50 writes/sec peak\n- Fail fast + quarantine corrupted data\n- Model.Class for DB entities only\n- Backup restore acceptable\n\n## Estimated Effort\n1.5-2 days\n\n## Reference\nSee REFACTOR_PLAN_V2.md for full details","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-21T00:32:25.806026+01:00","updated_at":"2025-12-21T00:32:25.806026+01:00"}
{"id":"cod-pt7.1","title":"Phase 0: Browser Resource Management","description":"Fix browser leak before touching DB. Isolated change that reduces flakes during later work.\n\n## Tasks\n- Add Effect.acquireRelease to BrowserService.createBrowser()\n- Add Effect.acquireRelease to BrowserService.createLocalBrowser()\n- Update callers to use Effect.scoped\n- Verify no browser processes leak after scrape errors\n\n## Files\n- apps/scraper/src/services/browser.ts\n- apps/scraper/src/services/scrape-kimovil.ts\n- apps/scraper/src/services/bulk-job.ts\n\n## Pattern\n```typescript\nconst withBrowser = Effect.acquireRelease(\n  browserService.createBrowser(),\n  (browser) =\u003e Effect.promise(() =\u003e browser.close())\n);\n\n// Usage\nEffect.scoped(\n  Effect.gen(function* () {\n    const browser = yield* withBrowser;\n    // use browser...\n  })\n); // browser.close() called automatically\n```\n\n## Verification\n- Run scrape, kill mid-way, check no orphan Chrome processes\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:32:39.426645+01:00","updated_at":"2025-12-21T01:40:11.774452+01:00","closed_at":"2025-12-21T01:40:11.774452+01:00","dependencies":[{"issue_id":"cod-pt7.1","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:32:39.42709+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.10","title":"Phase 9: Update AI Service","description":"Use domain models, eliminate runPromise escapes.\n\n## Tasks\n- Import Phone schema from @repo/scraper-domain\n- Delete duplicate schemas (NormalizedDataSchema, CameraSchema, etc.)\n- Keep Vercel AI SDK (@ai-sdk/google) - don't switch\n- Wrap AI calls in Effect.tryPromise\n- Return typed Effect, not Promise\n\n## Pattern\n```typescript\nconst adaptScrapedData = (rawData: Record\u003cstring, unknown\u003e) =\u003e\n  Effect.tryPromise({\n    try: () =\u003e generateObject({\n      model: google('gemini-2.0-flash'),\n      schema: PhoneSchema,  // From @repo/scraper-domain\n      prompt: buildPrompt(rawData),\n    }),\n    catch: (e) =\u003e new AiError({ cause: e }),\n  }).pipe(\n    Effect.map(result =\u003e result.object),\n    Effect.retry(Schedule.exponential('1 second').pipe(\n      Schedule.compose(Schedule.recurs(3))\n    ))\n  );\n```\n\n## Files\n- apps/scraper/src/services/openai.ts\n\n## Verification\n- AI normalization works end-to-end\n- No duplicate schema definitions\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:34:15.906759+01:00","updated_at":"2025-12-21T02:09:26.708511+01:00","closed_at":"2025-12-21T02:09:26.708511+01:00","dependencies":[{"issue_id":"cod-pt7.10","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:15.907295+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.10","depends_on_id":"cod-pt7.9","type":"blocks","created_at":"2025-12-21T00:35:34.926815+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.11","title":"Phase 10: Update Scrape Service","description":"Use new repositories, eliminate runPromise escapes.\n\n## Tasks\n- Update scrape-kimovil.ts to use new PhoneRepo\n- Replace Effect.runPromise calls with yield*\n- Use Effect.acquireRelease for page lifecycle\n- Stay in Effect context throughout\n\n## Before/After\n```typescript\n// Before\nconst html = await Effect.runPromise(htmlCache.getRawHtml(slug));\nconst browser = await Effect.runPromise(browserService.createBrowser());\n\n// After\nconst html = yield* htmlCache.getRawHtml(slug);\nconst browser = yield* Effect.scoped(withBrowser);\n```\n\n## Key Changes\n- scrape() returns Effect.Effect, not Promise\n- scrapeFast() returns Effect.Effect, not Promise\n- All internal calls use yield*, not await + runPromise\n- Page lifecycle managed with acquireRelease\n\n## Files\n- apps/scraper/src/services/scrape-kimovil.ts\n\n## Verification\n- Full scrape works end-to-end\n- No Effect.runPromise in service code\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-21T00:34:25.285122+01:00","updated_at":"2025-12-21T02:18:18.242749+01:00","closed_at":"2025-12-21T02:18:18.242749+01:00","dependencies":[{"issue_id":"cod-pt7.11","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:25.285575+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.11","depends_on_id":"cod-pt7.9","type":"blocks","created_at":"2025-12-21T00:35:34.961481+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.12","title":"Phase 11: Frontend Types","description":"Share types with frontend without adding @effect/schema dependency.\n\n## Tasks\n- Export plain TS types derived from domain models\n- Update frontend to import from @repo/scraper-domain\n- Remove duplicate type definitions in frontend\n\n## Pattern\n```typescript\n// @repo/scraper-domain/index.ts\nimport type { Phone as PhoneModel } from './models/phone';\n\n// Re-export as plain type (strips runtime Schema parts)\nexport type Phone = PhoneModel;\nexport type Camera = PhoneModel['cameras'][number];\n```\n\n## Files\n- packages/scraper-domain/src/index.ts (update exports)\n- apps/ws-web/src/pages/slugs/types.ts (simplify/remove)\n\n## Verification\n- Frontend builds without @effect/schema\n- Types match between backend and frontend\n- npm run check-types passes","status":"closed","priority":3,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-21T00:34:33.845849+01:00","updated_at":"2025-12-21T02:21:48.92588+01:00","closed_at":"2025-12-21T02:21:48.92588+01:00","dependencies":[{"issue_id":"cod-pt7.12","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:33.846277+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.12","depends_on_id":"cod-pt7.10","type":"blocks","created_at":"2025-12-21T00:35:34.993111+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.12","depends_on_id":"cod-pt7.11","type":"blocks","created_at":"2025-12-21T00:35:35.024877+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.13","title":"Phase 12: Structured Logging","description":"Replace console.log with Effect.log*.\n\n## Tasks\n- Replace console.log -\u003e Effect.logInfo\n- Replace console.warn -\u003e Effect.logWarning  \n- Replace console.error -\u003e Effect.logError\n- Add structured annotations where useful\n- Configure log output format\n\n## Pattern\n```typescript\n// Before\nconsole.log(`[HtmlCache] Saved raw HTML for slug: ${slug}`);\n\n// After\nyield* Effect.logInfo('Saved raw HTML').pipe(\n  Effect.annotateLogs({ service: 'HtmlCache', slug })\n);\n```\n\n## Benefits\n- Log levels (debug, info, warn, error)\n- Structured metadata (JSON-friendly)\n- Configurable at runtime\n- Testable (can capture logs)\n\n## Files\n- All service files\n- apps/scraper/src/utils/logger.ts (may delete or adapt)\n\n## Verification\n- Logs appear with proper levels\n- npm run check-types passes","status":"closed","priority":3,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:34:42.763019+01:00","updated_at":"2025-12-21T02:26:38.009441+01:00","closed_at":"2025-12-21T02:26:38.009441+01:00","dependencies":[{"issue_id":"cod-pt7.13","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:42.763481+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.13","depends_on_id":"cod-pt7.12","type":"blocks","created_at":"2025-12-21T00:35:35.056954+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.14","title":"Phase 13: Effect.Stream for WebSocket (Optional)","description":"Replace AsyncGenerator with Effect.Stream for better backpressure.\n\n## Tasks\n- Convert scrape progress events to Stream.Stream\n- Update WebSocket handler to consume stream\n- Add cancellation via Fiber interruption\n\n## Pattern\n```typescript\n// Before\nasync function* runScrape(): AsyncGenerator\u003cScrapeEvent\u003e {\n  yield { type: 'progress', stage: 'browser', progress: 0 };\n  // ...\n}\n\n// After  \nconst runScrape: Stream.Stream\u003cScrapeEvent, ScrapeError, ScrapeService\u003e =\n  Stream.gen(function* () {\n    yield* Stream.emit({ type: 'progress', stage: 'browser', progress: 0 });\n    // ...\n  });\n```\n\n## Benefits\n- Backpressure handling\n- Cancellation via Fiber interruption\n- Composable with other streams\n- Error typing\n\n## Files\n- apps/scraper/src/services/scrape-kimovil.ts\n- apps/scraper/src/routes/ws.ts\n\n## Verification\n- WebSocket progress works\n- Cancellation works\n- npm run check-types passes\n\n## Note\nThis phase is optional - can be deferred if time-constrained.","status":"open","priority":3,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-21T00:34:51.707317+01:00","updated_at":"2025-12-21T00:34:51.707317+01:00","dependencies":[{"issue_id":"cod-pt7.14","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:51.707795+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.14","depends_on_id":"cod-pt7.13","type":"blocks","created_at":"2025-12-21T00:35:35.089457+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.2","title":"Phase 1: Install Packages + Test Harness","description":"Set up @effect/sql and testing infrastructure.\n\n## Tasks\n- Add @effect/sql, @effect/sql-sqlite-node to apps/scraper\n- Add @effect/vitest to dev dependencies\n- Create test harness with temp SQLite DB\n- Write one smoke test proving harness works\n\n## Files\n- apps/scraper/package.json\n- apps/scraper/src/test/setup.ts (new)\n- apps/scraper/src/test/smoke.test.ts (new)\n\n## Test Harness Pattern\n```typescript\n// setup.ts\nimport { SqliteClient } from '@effect/sql-sqlite-node';\n\nexport const TestDbLayer = SqliteClient.layer({\n  filename: ':memory:',\n});\n\nexport const withTestDb = \u003cA, E\u003e(\n  effect: Effect.Effect\u003cA, E, SqlClient\u003e\n) =\u003e effect.pipe(\n  Effect.provide(TestDbLayer),\n  Effect.scoped\n);\n```\n\n## Verification\n- bun test runs and passes\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-21T00:32:52.909917+01:00","updated_at":"2025-12-21T01:40:11.963213+01:00","closed_at":"2025-12-21T01:40:11.963213+01:00","dependencies":[{"issue_id":"cod-pt7.2","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:32:52.9105+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.3","title":"Phase 2: SqlClient Layer + Quarantine","description":"Replace DatabaseService with @effect/sql SqlClient, add quarantine infrastructure.\n\n## Tasks\n- Create apps/scraper/src/sql/client.ts with SqlClient layer\n- Configure WAL mode, busy timeout (for ~50 writes/sec), statement cache\n- Migrate schema initialization to new client\n- Create quarantine table for corrupted data\n- Create quarantine helper: quarantine(slug, sourceTable, data, error)\n- Delete old services/db.ts\n- Update layers/live.ts\n\n## Quarantine Schema\n```sql\nCREATE TABLE IF NOT EXISTS quarantine (\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\n  slug TEXT NOT NULL,\n  source_table TEXT NOT NULL,\n  data TEXT NOT NULL,\n  error TEXT NOT NULL,\n  quarantined_at INTEGER NOT NULL DEFAULT (unixepoch())\n);\nCREATE INDEX idx_quarantine_slug ON quarantine(slug);\nCREATE INDEX idx_quarantine_source ON quarantine(source_table);\n```\n\n## Files\n- apps/scraper/src/sql/client.ts (new)\n- apps/scraper/src/sql/quarantine.ts (new)\n- apps/scraper/src/sql/schema.ts (new)\n- apps/scraper/src/services/db.ts (delete)\n- apps/scraper/src/layers/live.ts (update)\n\n## Verification\n- App starts with new SqlClient\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:06.211541+01:00","updated_at":"2025-12-21T01:43:22.271472+01:00","closed_at":"2025-12-21T01:43:22.271472+01:00","dependencies":[{"issue_id":"cod-pt7.3","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:06.212243+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.3","depends_on_id":"cod-pt7.2","type":"blocks","created_at":"2025-12-21T00:35:34.598542+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.4","title":"Phase 3: Domain Models","description":"Create canonical domain models using Model.Class.\n\n## Tasks\n- Create Camera, Sku, Benchmark as Schema.Class (embedded types)\n- Create Phone as Model.Class with proper field types\n- Create RawPhone as Model.Class for pre-AI data\n- Use Model.JsonFromString for array fields\n- Use Model.BooleanFromNumber for SQLite booleans\n- Add createdAt, updatedAt timestamps\n- Export from @repo/scraper-domain\n\n## Model Pattern\n```typescript\nexport class Camera extends Schema.Class\u003cCamera\u003e('Camera')({\n  resolution_mp: Schema.Number,\n  aperture_fstop: Schema.NullOr(Schema.String),\n  sensor: Schema.NullOr(Schema.String),\n  type: CameraType,\n  features: Schema.Array(Schema.String),\n}) {}\n\nexport class Phone extends Model.Class\u003cPhone\u003e('Phone')({\n  slug: Schema.String,\n  name: Schema.String,\n  cameras: Model.JsonFromString(Schema.Array(Camera)),\n  nfc: Model.BooleanFromNumber,\n  createdAt: Model.DateTimeInsert,\n  updatedAt: Model.DateTimeUpdate,\n}) {}\n```\n\n## Files\n- packages/scraper-domain/src/models/phone.ts (new)\n- packages/scraper-domain/src/models/index.ts (new)\n- packages/scraper-domain/src/index.ts (update exports)\n\n## Verification\n- npm run build passes\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:16.401696+01:00","updated_at":"2025-12-21T01:49:00.226416+01:00","closed_at":"2025-12-21T01:49:00.226416+01:00","dependencies":[{"issue_id":"cod-pt7.4","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:16.402118+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.4","depends_on_id":"cod-pt7.3","type":"blocks","created_at":"2025-12-21T00:35:34.632569+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.5","title":"Phase 4: Migrate PhoneDataService","description":"Migrate phone data storage to @effect/sql with Model + quarantine.\n\n## Tasks\n- Write integration tests for current PhoneDataService behavior\n- Create PhoneRepo using Model.makeRepository for basic CRUD\n- Keep custom queries hand-written (getSlugsNeedingAi, getSlugsNeedingExtraction)\n- Add Schema.decode with fail-fast + quarantine fallback\n- Update service internals, keep interface stable\n- Delete old implementation\n\n## Error Handling Pattern\n```typescript\nconst getPhone = (slug: string) =\u003e sql\u003cPhoneRow\u003e`\n  SELECT * FROM phone_data WHERE slug = ${slug}\n`.pipe(\n  Effect.flatMap(rows =\u003e rows[0] \n    ? Schema.decode(Phone)(rows[0])\n    : Effect.succeed(null)\n  ),\n  Effect.catchTag('ParseError', (e) =\u003e\n    quarantine(slug, 'phone_data', rows[0], e.message).pipe(\n      Effect.as(null)\n    )\n  )\n);\n```\n\n## Files\n- apps/scraper/src/test/phone-data.test.ts (new)\n- apps/scraper/src/repositories/phone.ts (new)\n- apps/scraper/src/services/phone-data.ts (rewrite internals)\n\n## Verification\n- All phone-data tests pass\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:26.366226+01:00","updated_at":"2025-12-21T02:02:10.029025+01:00","closed_at":"2025-12-21T02:02:10.029025+01:00","dependencies":[{"issue_id":"cod-pt7.5","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:26.367233+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.5","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.664561+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.6","title":"Phase 5: Migrate HtmlCacheService","description":"Migrate HTML cache to @effect/sql.\n\n## Tasks\n- Write integration tests for current HtmlCacheService behavior\n- Rewrite internals to use SqlClient\n- Keep interface stable\n- Add quarantine for corrupted verification records\n\n## Key Methods to Test\n- saveRawHtml(slug, html, source)\n- getRawHtml(slug, source)\n- getRawHtmlWithAge(slug, source)\n- recordVerification(slug, isCorrupted, reason)\n- getVerificationStatus(slug)\n- getCorruptedSlugs()\n- getValidSlugs()\n\n## Files\n- apps/scraper/src/test/html-cache.test.ts (new)\n- apps/scraper/src/services/html-cache.ts (rewrite internals)\n\n## Verification\n- All html-cache tests pass\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":90,"created_at":"2025-12-21T00:33:32.625445+01:00","updated_at":"2025-12-21T02:02:10.215932+01:00","closed_at":"2025-12-21T02:02:10.215932+01:00","dependencies":[{"issue_id":"cod-pt7.6","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:32.625901+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.6","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.696791+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.7","title":"Phase 6: Migrate JobQueueService","description":"Migrate job queue to @effect/sql with explicit transactions.\n\n## Tasks\n- Write integration tests for queue behavior (ordering, retry, backoff)\n- Identify multi-step operations needing transactions\n- Rewrite internals to use SqlClient\n- Wrap transactional operations explicitly\n- Keep interface stable\n\n## Transactional Operations\n- claimNextQueueItem (SELECT + UPDATE in one transaction)\n- rescheduleQueueItem (UPDATE attempt + next_attempt_at)\n- enqueueJobSlugs (bulk INSERT)\n\n## Key Methods to Test\n- createJob(input)\n- getJob(id), getAllJobs()\n- enqueueJobSlugs(jobId, jobType, mode, slugs)\n- claimNextQueueItem(jobId) - must be atomic\n- completeQueueItem(id, error?)\n- rescheduleQueueItem(id, nextAttemptAt, error, errorCode)\n- getJobStats(id), getTimeoutStats(id)\n\n## Files\n- apps/scraper/src/test/job-queue.test.ts (new)\n- apps/scraper/src/services/job-queue.ts (rewrite internals)\n\n## Verification\n- All job-queue tests pass\n- Queue ordering/retry semantics unchanged\n- npm run check-types passes","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2025-12-21T00:33:41.731196+01:00","updated_at":"2025-12-21T02:02:10.39989+01:00","closed_at":"2025-12-21T02:02:10.39989+01:00","dependencies":[{"issue_id":"cod-pt7.7","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:41.731666+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.7","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.730495+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.8","title":"Phase 7: Migrate DeviceService","description":"Migrate device storage to @effect/sql.\n\n## Tasks\n- Write integration tests for DeviceService\n- Create Device Model.Class if beneficial (or keep simple)\n- Rewrite internals to use SqlClient\n- Keep interface stable\n\n## Key Methods to Test\n- upsertDevice(device)\n- getDevice(slug)\n- getDeviceCount()\n- getAllDevices()\n- enqueuePrefix(prefix, depth)\n- getNextPendingPrefix()\n- markPrefixDone(prefix, resultCount)\n\n## Files\n- apps/scraper/src/test/device.test.ts (new)\n- apps/scraper/src/services/device.ts (rewrite internals)\n\n## Verification\n- All device tests pass\n- npm run check-types passes","status":"closed","priority":2,"issue_type":"task","estimated_minutes":60,"created_at":"2025-12-21T00:33:55.850655+01:00","updated_at":"2025-12-21T02:02:10.585224+01:00","closed_at":"2025-12-21T02:02:10.585224+01:00","dependencies":[{"issue_id":"cod-pt7.8","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:33:55.851095+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.8","depends_on_id":"cod-pt7.4","type":"blocks","created_at":"2025-12-21T00:35:34.762845+01:00","created_by":"daemon"}]}
{"id":"cod-pt7.9","title":"Phase 8: Data Migration (Pipe to JSON)","description":"Convert pipe-delimited strings to JSON arrays.\n\n## Tasks\n- Create idempotent migration script\n- Add pre-check: count rows needing migration\n- Add post-check: count valid JSON rows\n- Backup DB before running\n- Run migration\n- Verify no data loss\n\n## Migration Logic\n```typescript\nconst needsMigration = (value: string) =\u003e {\n  if (!value) return false;\n  try { JSON.parse(value); return false; }  // Already JSON\n  catch { return value.includes('|'); }      // Pipe-delimited\n};\n\nconst migrate = (value: string) =\u003e \n  JSON.stringify(value.split('|').filter(Boolean));\n```\n\n## Fields to Migrate\n- aliases, images, materials, colors\n- displayFeatures, cpuCores, sim\n- cameraFeatures, others\n\n## Files\n- apps/scraper/src/migrations/001-pipe-to-json.ts (new)\n\n## Verification\n- Pre-check count matches post-check count\n- Random sample of migrated rows parse correctly\n- App reads migrated data without errors","status":"closed","priority":1,"issue_type":"task","estimated_minutes":30,"created_at":"2025-12-21T00:34:04.51097+01:00","updated_at":"2025-12-21T02:05:53.846096+01:00","closed_at":"2025-12-21T02:05:53.846096+01:00","dependencies":[{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7","type":"parent-child","created_at":"2025-12-21T00:34:04.511464+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.5","type":"blocks","created_at":"2025-12-21T00:35:34.795495+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.6","type":"blocks","created_at":"2025-12-21T00:35:34.827669+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.7","type":"blocks","created_at":"2025-12-21T00:35:34.859748+01:00","created_by":"daemon"},{"issue_id":"cod-pt7.9","depends_on_id":"cod-pt7.8","type":"blocks","created_at":"2025-12-21T00:35:34.893089+01:00","created_by":"daemon"}]}
{"id":"cod-rll","title":"Phase 2: Create PhoneDataService","description":"Create PhoneDataService to own phone data storage (raw + AI normalized).","design":"1. Create services/phone-data.ts\n2. Move from storage.ts: savePhoneDataRaw, getPhoneDataRaw, hasPhoneDataRaw, getPhoneDataRawCount\n3. Move: savePhoneData, getPhoneData, hasPhoneData, getPhoneDataCount\n4. Move: getPhoneDataRawBulk, getSlugsNeedingExtraction, getSlugsNeedingAi\n5. OpenAI service calls PhoneDataService to save results\n6. Update api.ts routes to use new service","acceptance_criteria":"- [ ] PhoneDataService created\n- [ ] All phone data methods moved\n- [ ] OpenAI/bulk-job uses new service for saving\n- [ ] API routes work correctly\n- [ ] Build passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T19:30:59.796622+01:00","updated_at":"2025-12-20T19:57:00.556503+01:00","closed_at":"2025-12-20T19:57:00.556503+01:00","dependencies":[{"issue_id":"cod-rll","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.863404+01:00","created_by":"daemon"},{"issue_id":"cod-rll","depends_on_id":"cod-8np","type":"blocks","created_at":"2025-12-20T19:35:42.105534+01:00","created_by":"daemon"},{"issue_id":"cod-rll","depends_on_id":"cod-co8","type":"blocks","created_at":"2025-12-20T19:35:42.137539+01:00","created_by":"daemon"},{"issue_id":"cod-rll","depends_on_id":"cod-duf","type":"blocks","created_at":"2025-12-20T19:35:42.1665+01:00","created_by":"daemon"}]}
{"id":"cod-x5r","title":"Phase 4: Update LiveLayer and cleanup","description":"Update Effect layer composition with new services, remove deprecated code from storage.ts.","design":"1. Update layers/live.ts to compose all new services\n2. Remove deprecated wrappers from storage.ts\n3. Delete storage.ts if empty, or keep minimal shared DB utilities\n4. Update all imports across codebase\n5. Verify index.ts startup works correctly","acceptance_criteria":"- [ ] LiveLayer composes: HtmlCacheService, JobQueueService, DeviceService, PhoneDataService, KimovilScraper, OpenAIService, BrowserService\n- [ ] No deprecated code in storage.ts\n- [ ] Clean imports everywhere\n- [ ] Server starts and all features work\n- [ ] Build and typecheck pass","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T19:31:14.194922+01:00","updated_at":"2025-12-20T23:40:47.73989+01:00","closed_at":"2025-12-20T23:40:47.73989+01:00","dependencies":[{"issue_id":"cod-x5r","depends_on_id":"cod-bb8","type":"parent-child","created_at":"2025-12-20T19:31:26.925128+01:00","created_by":"daemon"},{"issue_id":"cod-x5r","depends_on_id":"cod-rll","type":"blocks","created_at":"2025-12-20T19:35:42.226064+01:00","created_by":"daemon"},{"issue_id":"cod-x5r","depends_on_id":"cod-3qg","type":"blocks","created_at":"2025-12-20T19:35:42.258114+01:00","created_by":"daemon"}]}
