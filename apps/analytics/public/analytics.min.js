"use strict";(()=>{(function(){"use strict";var s={endpoint:window.COD_ANALYTICS_ENDPOINT||"https://analytics.click-or-die.ru/v1/events",siteId:window.COD_ANALYTICS_SITE_ID||null,batchSize:20,flushInterval:5e3,visibilityThreshold:.5,sessionTimeout:18e5,cookieExpiry:365,debug:window.COD_ANALYTICS_DEBUG||!1},v=[],h=null,f=null,b=Date.now(),N=null;function o(){s.debug}function y(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",i=0;i<20;i++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}function A(t,e,i){var n="";if(i){var a=new Date;a.setTime(a.getTime()+i*24*60*60*1e3),n="; expires="+a.toUTCString()}document.cookie=t+"="+encodeURIComponent(e)+n+"; path=/; SameSite=Lax"}function E(t){for(var e=t+"=",i=document.cookie.split(";"),n=0;n<i.length;n++){for(var a=i[n];a.charAt(0)===" ";)a=a.substring(1);if(a.indexOf(e)===0)return decodeURIComponent(a.substring(e.length))}return null}function T(){var t=E("cod_vid");return t||(t="v_"+y(),A("cod_vid",t,s.cookieExpiry),o("Created new visitor ID:",t)),t}function S(){var t=null;try{t=sessionStorage.getItem("cod_sid");var e=sessionStorage.getItem("cod_last_activity");if(t&&e){var i=Date.now()-parseInt(e,10);i>s.sessionTimeout&&(t=null,o("Session expired, creating new one"))}}catch{}if(!t){t="s_"+y();try{sessionStorage.setItem("cod_sid",t)}catch{}o("Created new session ID:",t)}try{sessionStorage.setItem("cod_last_activity",Date.now().toString())}catch{}return t}function C(){b=Date.now();try{sessionStorage.setItem("cod_last_activity",b.toString())}catch{}}function O(){var t=location.href.split("?")[0].split("#")[0];return t}function D(){if(!document.referrer)return"";try{return new URL(document.referrer).hostname}catch{return""}}function m(t,e){C(),f=S();var i={event_type:t,occurred_at:new Date().toISOString(),session_id:f,visitor_id:h,page_url:O(),page_path:location.pathname,referrer_domain:D(),site_id:s.siteId,properties:e||{}};v.push(i),o("Queued event:",t,e),v.length>=s.batchSize&&u()}function u(){if(v.length!==0){var t=v.slice();v=[];var e=JSON.stringify({events:t});if(o("Flushing",t.length,"events"),navigator.sendBeacon){var i=new Blob([e],{type:"application/json"}),n=navigator.sendBeacon(s.endpoint,i);n||k(e)}else k(e)}}function k(t){try{fetch(s.endpoint,{method:"POST",body:t,headers:{"Content-Type":"application/json"},keepalive:!0,mode:"cors"}).catch(function(e){o("Failed to send events:",e)})}catch(e){o("Fetch error:",e)}}function L(t,e){var i=parseInt(t.dataset.mappingId,10),n=parseInt(t.dataset.postId,10),a=parseInt(t.dataset.priceCount,10),r=parseInt(t.dataset.minPrice,10);return{mapping_id:isNaN(i)?null:i,post_id:isNaN(n)?null:n,device_slug:t.dataset.deviceSlug||null,raw_model:t.dataset.rawModel||null,widget_status:t.dataset.widgetStatus||"loaded",price_count:isNaN(a)?0:a,min_price:isNaN(r)?null:r,viewport_percent:e}}function g(t,e){if(!t.dataset.codTracked){t.dataset.codTracked="true";var i=L(t,e);m("widget_impression",i),o("Tracked impression:",i.widget_status,i.device_slug)}}function _(){var t=document.querySelectorAll("[data-widget-tracking]");if(o("Found",t.length,"widgets to track"),t.forEach(function(n){var a=n.dataset.widgetStatus;(a==="empty"||a==="not_found")&&g(n,0)}),!("IntersectionObserver"in window)){o("IntersectionObserver not supported, tracking all widgets immediately"),t.forEach(function(n){n.dataset.widgetStatus==="loaded"&&g(n,100)});return}var e=new IntersectionObserver(function(n){n.forEach(function(a){if(a.isIntersecting&&a.intersectionRatio>=s.visibilityThreshold){var r=a.target;g(r,Math.round(a.intersectionRatio*100)),e.unobserve(r)}})},{threshold:[0,.5,1]});if(t.forEach(function(n){n.dataset.widgetStatus==="loaded"&&!n.dataset.codTracked&&e.observe(n)}),"MutationObserver"in window){var i=new MutationObserver(function(n){n.forEach(function(a){a.addedNodes.forEach(function(r){if(r.nodeType===1){var l=[];if(r.hasAttribute&&r.hasAttribute("data-widget-tracking")&&l.push(r),r.querySelectorAll)for(var p=r.querySelectorAll("[data-widget-tracking]"),c=0;c<p.length;c++)l.push(p[c]);l.forEach(function(d){var I=d.dataset.widgetStatus;I==="empty"||I==="not_found"?g(d,0):I==="loaded"&&!d.dataset.codTracked&&e.observe(d)})}})})});i.observe(document.body,{childList:!0,subtree:!0})}}function x(t){for(var e=t;e&&e!==document.body;){if(e.hasAttribute&&e.hasAttribute("data-widget-tracking"))return e;e=e.parentNode}return null}function w(){document.addEventListener("click",function(t){for(var e=t.target;e&&e!==document.body;){if(e.hasAttribute&&e.hasAttribute("data-widget-click")){var i=x(e),n=null,a=null,r=null;i&&(n=parseInt(i.dataset.mappingId,10),a=parseInt(i.dataset.postId,10),r=i.dataset.deviceSlug||null);var l=e.dataset.shopSource||null,p=e.dataset.shopName||null,c=parseInt(e.dataset.price,10),d=parseInt(e.dataset.position,10);m("widget_click",{mapping_id:isNaN(n)?null:n,post_id:isNaN(a)?null:a,device_slug:r,click_target:e.dataset.clickTarget||"shop_link",shop_source:l,shop_name:p,price:isNaN(c)?null:c,position:isNaN(d)?null:d,destination_url:e.href||null}),o("Tracked click:",l,p,c);break}e=e.parentNode}},!0)}function M(){h=T(),f=S(),o("Initialized with visitor:",h,"session:",f),N=setInterval(u,s.flushInterval),document.addEventListener("visibilitychange",function(){document.visibilityState==="hidden"&&u()}),window.addEventListener("pagehide",u),window.addEventListener("beforeunload",u),document.body.addEventListener("htmx:afterSettle",function(){o("HTMX content settled, re-scanning widgets"),_()}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",function(){_(),w()}):(_(),w())}window.codAnalytics={trackEvent:m,flush:u,getVisitorId:function(){return h},getSessionId:function(){return f},config:s},M()})();})();
